## A - OAuth2 con Password y Bearer

**Definición:**  
OAuth2 es un protocolo de autorización que permite a los usuarios autenticarse y obtener tokens de acceso para interactuar con una API. En este caso, se utiliza el flujo "password", donde el usuario proporciona su nombre de usuario y contraseña para obtener un token de acceso (Bearer token).

**Ejemplo:**

```python
from fastapi import Depends, FastAPI, HTTPException
from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm

app = FastAPI()
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

@app.post("/token")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    # Verificar usuario y contraseña
    if form_data.username != "johndoe" or form_data.password != "secret":
        raise HTTPException(status_code=400, detail="Usuario o contraseña incorrectos")

    # Crear y devolver un token de acceso
    return {"access_token": form_data.username, "token_type": "bearer"}
```

**Descripción del ejemplo:**  
Este código muestra cómo implementar un endpoint `/token` que recibe las credenciales del usuario y devuelve un token de acceso si las credenciales son válidas.

---

## B - OAuth2PasswordRequestForm

**Definición:**  
`OAuth2PasswordRequestForm` es una clase proporcionada por FastAPI para manejar el flujo de autenticación OAuth2 con contraseña. Recibe el `username`, `password`, y opcionalmente `scope` como campos de un formulario.

**Ejemplo:**

```python
from fastapi.security import OAuth2PasswordRequestForm

@app.post("/token")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    # Acceder a los datos del formulario
    username = form_data.username
    password = form_data.password
    return {"username": username, "password": password}
```

**Descripción del ejemplo:**  
Este código muestra cómo usar `OAuth2PasswordRequestForm` para obtener el nombre de usuario y la contraseña enviados en el formulario.

---

## C - Scopes en OAuth2

**Definición:**  
Los "scopes" (alcances) en OAuth2 son permisos específicos que se pueden asignar a un token de acceso. Estos permiten restringir lo que un usuario o aplicación puede hacer con la API.

**Ejemplo:**

```python
from fastapi.security import OAuth2PasswordRequestForm

@app.post("/token")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    # Verificar scopes
    scopes = form_data.scopes
    return {"scopes": scopes}
```

**Descripción del ejemplo:**  
Este código muestra cómo acceder a los scopes enviados en el formulario de autenticación.

---

## D - Manejo de Errores en Autenticación

**Definición:**  
Es importante manejar errores como credenciales inválidas o usuarios inactivos, y devolver respuestas HTTP adecuadas (como 401 Unauthorized o 400 Bad Request).

**Ejemplo:**

```python
from fastapi import HTTPException

@app.post("/token")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    user_dict = fake_users_db.get(form_data.username)
    if not user_dict:
        raise HTTPException(status_code=400, detail="Usuario o contraseña incorrectos")

    user = UserInDB(**user_dict)
    if not user.hashed_password == fake_hash_password(form_data.password):
        raise HTTPException(status_code=400, detail="Usuario o contraseña incorrectos")

    return {"access_token": user.username, "token_type": "bearer"}
```

**Descripción del ejemplo:**  
Este código muestra cómo manejar errores comunes relacionados con la autenticación, como credenciales incorrectas.

---

## E - Usuario Activo/Inactivo

**Definición:**  
Es posible restringir el acceso a usuarios inactivos. Si un usuario está marcado como inactivo, se debe devolver un error 400 con el mensaje "Inactive user".

**Ejemplo:**

```python
async def get_current_active_user(current_user: User = Depends(get_current_user)):
    if current_user.disabled:
        raise HTTPException(status_code=400, detail="Usuario inactivo")
    return current_user
```

**Descripción del ejemplo:**  
Este código muestra cómo verificar si un usuario está activo antes de permitirle acceder a un endpoint protegido.

---

## F - Devolver el Token de Acceso

**Definición:**  
El endpoint `/token` debe devolver un JSON con un `access_token` y un `token_type`. El `token_type` debe ser "bearer" para cumplir con el estándar OAuth2.

**Ejemplo:**

```python
@app.post("/token")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    user_dict = fake_users_db.get(form_data.username)
    if not user_dict:
        raise HTTPException(status_code=400, detail="Usuario o contraseña incorrectos")

    user = UserInDB(**user_dict)
    if not user.hashed_password == fake_hash_password(form_data.password):
        raise HTTPException(status_code=400, detail="Usuario o contraseña incorrectos")

    return {"access_token": user.username, "token_type": "bearer"}
```

**Descripción del ejemplo:**  
Este código muestra cómo devolver un token de acceso en formato JSON después de una autenticación exitosa.

---

## G - Dependencias para Obtener el Usuario Actual

**Definición:**  
Se pueden crear dependencias para obtener el usuario actual y verificar si está activo. Estas dependencias se pueden usar en endpoints protegidos.

**Ejemplo:**

```python
async def get_current_user(token: str = Depends(oauth2_scheme)):
    user = fake_decode_token(token)
    if not user:
        raise HTTPException(status_code=401, detail="Credenciales inválidas")
    return user

async def get_current_active_user(current_user: User = Depends(get_current_user)):
    if current_user.disabled:
        raise HTTPException(status_code=400, detail="Usuario inactivo")
    return current_user

@app.get("/users/me")
async def read_users_me(current_user: User = Depends(get_current_active_user)):
    return current_user
```

**Descripción del ejemplo:**  
Este código muestra cómo usar dependencias para obtener y verificar el usuario actual antes de permitir el acceso a un endpoint.

---

## H - Integración con la Documentación Interactiva

**Definición:**  
FastAPI genera automáticamente una documentación interactiva (Swagger UI) que permite probar los endpoints de autenticación directamente desde el navegador.

**Ejemplo:**

1.  Ejecuta la aplicación FastAPI.
2.  Abre `http://127.0.0.1:8000/docs` en tu navegador.
3.  Haz clic en "Authorize" y proporciona las credenciales.
4.  Prueba los endpoints protegidos.

**Descripción del ejemplo:**  
Este proceso muestra cómo usar la documentación interactiva para probar la autenticación y los endpoints protegidos.

---

## I - Recap

**Definición:**  
Con estos conceptos, puedes implementar un sistema de autenticación seguro utilizando OAuth2 con contraseña y tokens Bearer en FastAPI. Asegúrate de manejar correctamente los errores, verificar usuarios activos y devolver tokens de acceso en el formato correcto.

**Ejemplo de flujo completo:**

```python
from fastapi import Depends, FastAPI, HTTPException
from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm

app = FastAPI()
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

fake_users_db = {
    "johndoe": {
        "username": "johndoe",
        "hashed_password": "fakehashedsecret",
        "disabled": False,
    }
}

def fake_hash_password(password: str):
    return "fakehashed" + password

@app.post("/token")
async def login(form_data: OAuth2PasswordRequestForm = Depends()):
    user_dict = fake_users_db.get(form_data.username)
    if not user_dict:
        raise HTTPException(status_code=400, detail="Usuario o contraseña incorrectos")

    user = UserInDB(**user_dict)
    if not user.hashed_password == fake_hash_password(form_data.password):
        raise HTTPException(status_code=400, detail="Usuario o contraseña incorrectos")

    return {"access_token": user.username, "token_type": "bearer"}

@app.get("/users/me")
async def read_users_me(current_user: User = Depends(get_current_active_user)):
    return current_user
```

**Descripción del ejemplo:**  
Este código muestra un flujo completo de autenticación OAuth2 con contraseña y tokens Bearer en FastAPI.
