## A - TestClient con with para Eventos

**Definición:** La misma clase TestClient de FastAPI, cuando se usa dentro de un bloque with, ejecuta los eventos de ciclo de vida (startup y shutdown) de la app durante la creación y finalización del contexto.

**Ejemplo:** Al usar el TestClient en un bloque with, se ejecutan los eventos definidos como startup al iniciar el bloque, y los eventos de shutdown al cerrarse.

(Esto permite simular el ciclo de vida completo de una aplicación FastAPI dentro de un test.)

## B - Ejecución de Eventos startup

**Definición:** Los eventos definidos con @app.on_event("startup") se ejecutan cuando se inicializa el contexto del TestClient dentro del bloque with. Esto permite realizar configuraciones, inicializar variables, etc. que son necesarias para las pruebas.

**Ejemplo:**

```Python
from fastapi import FastAPI
from fastapi.testclient import TestClient

app = FastAPI()

items = {}

@app.on_event("startup")
async def startup_event():
    items["foo"] = {"name": "Fighters"}


@app.get("/items/{item_id}")
async def read_items(item_id: str):
  return items[item_id]


def test_read_items():
  with TestClient(app) as client:
    response = client.get("/items/foo")
    assert response.status_code == 200
    assert response.json() == {"name": "Fighters"}
```

(Al entrar al bloque with, se ejecuta el evento startup, que inicializa la variable items)

## C - Ejecución de Eventos shutdown

**Definición:** Los eventos definidos con @app.on_event("shutdown") se ejecutan cuando el contexto del TestClient termina (al salir del bloque with). Esto permite limpiar recursos, cerrar conexiones, etc.

**Ejemplo:**

```Python
from fastapi import FastAPI
from fastapi.testclient import TestClient

app = FastAPI()

log = []

@app.on_event("shutdown")
def shutdown_event():
    log.append("shutdown event")

@app.get("/")
async def read_root():
  return {"message": "OK"}

def test_read_root():
    with TestClient(app) as client:
        response = client.get("/")
        assert response.status_code == 200
        assert "shutdown event" in log
```

(Al terminar el with, se ejecuta el evento shutdown que agrega un mensaje al log)

## D - Pruebas con Inicialización de Recursos

**Definición:** Utilizar el bloque with con TestClient permite probar rutas que dependen de recursos que se inicializan en los eventos de startup.

**Ejemplo:**

(Ver ejemplo del punto B, donde se testea una ruta que depende de items que se inicializa en el evento startup)

## E - Limpieza de Recursos

**Definición:** Similarmente se pueden testear rutas con limpieza de recursos dentro de los eventos shutdown.

**Ejemplo:**
(Ver ejemplo del punto C, donde se comprueba que el evento shutdown ejecuta el código esperado)
