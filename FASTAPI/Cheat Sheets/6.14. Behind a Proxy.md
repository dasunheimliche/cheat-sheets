## A - Uso de FastAPI detrás de un proxy

**Definición:**  
Cuando se utiliza un proxy (como Traefik o Nginx) que agrega un prefijo de ruta adicional (por ejemplo, `/api/v1`), FastAPI puede manejar esta configuración mediante el parámetro `root_path`. Este parámetro permite que la aplicación funcione correctamente incluso cuando el proxy modifica las rutas.

**Ejemplo:**

```python
from fastapi import FastAPI, Request

app = FastAPI()

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

**Descripción del ejemplo:**  
Este código define una ruta `/app` en FastAPI. Si la aplicación está detrás de un proxy que agrega un prefijo `/api/v1`, el `root_path` se usa para manejar correctamente las rutas.

---

## B - Configuración del `root_path`

**Definición:**  
El `root_path` se puede proporcionar de dos maneras:

1.  Usando la opción de línea de comandos `--root-path` al iniciar Uvicorn o Hypercorn.
2.  Configurando el parámetro `root_path` al crear la aplicación FastAPI.

**Ejemplo 1: Usando línea de comandos**

```bash
fastapi run main.py --root-path /api/v1
```

**Ejemplo 2: Configurando en la aplicación**

```python
from fastapi import FastAPI, Request

app = FastAPI(root_path="/api/v1")

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

**Descripción del ejemplo:**  
En ambos casos, el `root_path` se establece en `/api/v1`, lo que permite que la aplicación funcione correctamente detrás de un proxy que agrega este prefijo.

---

## C - Verificación del `root_path`

**Definición:**  
Puedes verificar el `root_path` actual en cada solicitud accediendo al objeto `Request` y su propiedad `scope`. Esto es útil para depuración o para personalizar el comportamiento de la aplicación en función del prefijo de ruta.

**Ejemplo:**

```python
from fastapi import FastAPI, Request

app = FastAPI(root_path="/api/v1")

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

**Descripción del ejemplo:**  
Este código devuelve el `root_path` en la respuesta, lo que permite verificar que el prefijo de ruta se está manejando correctamente.

---

## D - Pruebas locales con Traefik

**Definición:**  
Puedes probar la configuración de un proxy con prefijo de ruta localmente usando Traefik. Traefik es un proxy inverso que puede agregar y manejar prefijos de ruta.

**Pasos para configurar Traefik:**

1.  Descarga Traefik desde [su página oficial](https://github.com/containous/traefik/releases).
2.  Crea un archivo `traefik.toml` con la siguiente configuración:

```toml
[entryPoints]
  [entryPoints.http]
    address = ":9999"

[providers]
  [providers.file]
    filename = "routes.toml"
```

1.  Crea un archivo `routes.toml` con la siguiente configuración:

```toml
[http]
  [http.middlewares]
    [http.middlewares.api-stripprefix.stripPrefix]
      prefixes = ["/api/v1"]

  [http.routers]
    [http.routers.app-http]
      entryPoints = ["http"]
      service = "app"
      rule = "PathPrefix(`/api/v1`)"
      middlewares = ["api-stripprefix"]

  [http.services]
    [http.services.app]
      [http.services.app.loadBalancer]
        [[http.services.app.loadBalancer.servers]]
          url = "http://127.0.0.1:8000"
```

1.  Inicia Traefik:

```bash
./traefik --configFile=traefik.toml
```

1.  Inicia tu aplicación FastAPI con el `root_path`:

```bash
fastapi run main.py --root-path /api/v1
```

**Descripción del ejemplo:**  
Este proceso configura Traefik para agregar el prefijo `/api/v1` y redirigir las solicitudes a tu aplicación FastAPI.

---

## E - Interfaz de documentación con `root_path`

**Definición:**  
Cuando se usa un `root_path`, la interfaz de documentación de FastAPI (Swagger UI) se ajusta automáticamente para funcionar con el prefijo de ruta. Esto permite que la documentación sea accesible en la ruta correcta (por ejemplo, `/api/v1/docs`).

**Ejemplo:**

1.  Accede a la documentación sin el prefijo (no funcionará):  
    `http://127.0.0.1:8000/docs`
2.  Accede a la documentación con el prefijo (funcionará correctamente):  
    `http://127.0.0.1:9999/api/v1/docs`

**Descripción del ejemplo:**  
La documentación solo funcionará correctamente cuando se acceda a través del proxy con el prefijo de ruta configurado.

---

## F - Servidores adicionales en OpenAPI

**Definición:**  
Puedes configurar servidores adicionales en el esquema OpenAPI de FastAPI. Esto es útil si deseas que la misma interfaz de documentación interactúe con múltiples entornos (por ejemplo, staging y producción).

**Ejemplo:**

```python
from fastapi import FastAPI, Request

app = FastAPI(
    servers=[
        {"url": "https://stag.example.com", "description": "Staging environment"},
        {"url": "https://prod.example.com", "description": "Production environment"},
    ],
    root_path="/api/v1",
)

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

**Descripción del ejemplo:**  
Este código agrega dos servidores adicionales al esquema OpenAPI. FastAPI también incluye automáticamente un servidor con el `root_path`.

---

## G - Deshabilitar el servidor automático de `root_path`

**Definición:**  
Si no deseas que FastAPI incluya automáticamente un servidor con el `root_path` en el esquema OpenAPI, puedes deshabilitarlo usando el parámetro `root_path_in_servers=False`.

**Ejemplo:**

```python
from fastapi import FastAPI, Request

app = FastAPI(
    servers=[
        {"url": "https://stag.example.com", "description": "Staging environment"},
        {"url": "https://prod.example.com", "description": "Production environment"},
    ],
    root_path="/api/v1",
    root_path_in_servers=False,
)

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

**Descripción del ejemplo:**  
Este código deshabilita la inclusión automática del servidor con el `root_path` en el esquema OpenAPI.
