## A - Proxy con Prefijo de Ruta Eliminado

**Definición:** Un proxy (como Traefik o Nginx) que agrega un prefijo a la ruta de la aplicación (ej: /api/v1), pero lo elimina antes de enviar la petición al servidor (Uvicorn/FastAPI). Esto hace que la aplicación "crea" que está sirviendo en la ruta base (ej: /app), aunque realmente se accede a ella en /api/v1/app.

**Ejemplo:**

**Código FastAPI:** Define la ruta /app.

**Proxy:** Escucha en /api/v1/app, pero al enviar la petición al servidor la convierte en /app.

**Acceso:** El usuario accede a /api/v1/app, pero la aplicación maneja /app.

(La aplicación no tiene conocimiento del prefijo /api/v1, el proxy hace la traducción).

## B - Problema de la Documentación en un Proxy

**Definición:** La UI de docs (Swagger UI/ReDoc) espera el esquema OpenAPI en /openapi.json, pero si hay un proxy con un prefijo /api/v1, la UI buscará el esquema incorrectamente en /openapi.json en vez de en /api/v1/openapi.json.

**Ejemplo:**

UI de docs (front-end) busca /openapi.json, cuando debería ser /api/v1/openapi.json en el caso de nuestro ejemplo.

Esto causa que la UI no pueda cargar la especificación OpenAPI.

(El problema es que las rutas "conocidas" por el front-end no concuerdan con las del servidor cuando hay un proxy con un prefijo de ruta.)

## C - root_path

**Definición:** Un mecanismo de la especificación ASGI (y FastAPI) para indicar el prefijo de ruta que está agregando el proxy, a pesar que el servidor (Uvicorn) no ve ese prefijo directamente. Este prefijo se utiliza para que la UI de docs sepa dónde buscar el esquema OpenAPI y para generar la url base correcta de la documentación.

**Ejemplo (usando el parámetro en la terminal):**

```Bash
fastapi run main.py --root-path /api/v1
```

(Indica que la aplicación está sirviendo detrás de un proxy que agrega el prefijo /api/v1.)

**Ejemplo (pasando el parámetro al constructor de la app):**

```python
from fastapi import FastAPI

app = FastAPI(root_path="/api/v1")
```

(Es equivalente al ejemplo con el comando en terminal)

## D - Acceder al root_path desde el código

**Definición:** Se puede acceder al root_path actual en cada request usando request.scope.get("root_path"). Esto permite ver el prefijo de ruta que está configurado para la aplicación.

**Ejemplo:**

```Python
from fastapi import FastAPI, Request

app = FastAPI(root_path="/api/v1")


@app.get("/app")
def read_main(request: Request):
    return {"message": "Hola", "root_path": request.scope.get("root_path")}
```

(La respuesta contendrá el root_path, en este ejemplo /api/v1.)

## E - Funcionamiento de root_path y el proxy

**Definición:** El servidor (Uvicorn) escucha en la ruta base (ej: http://127.0.0.1:8000/app). El proxy escucha en http://127.0.0.1:9999/api/v1/app. El proxy elimina el prefijo al comunicarse con el servidor, y FastAPI utiliza el root_path para que la UI de docs funcione correctamente.

**Ejemplo:**

Uvicorn: Sirve en http://127.0.0.1:8000/app.

Traefik: Escucha en http://127.0.0.1:9999/api/v1/app.

Internamente (traefik): Elimina /api/v1 al comunicarse con Uvicorn en http://127.0.0.1:8000/app.

Resultado: La aplicación ve la petición en /app, la UI de docs se carga correctamente en http://127.0.0.1:9999/api/v1/docs.

(Es un mecanismo para que la ruta vista por el servidor sea consistente con la del front-end usando el proxy.)

## F - Configuración de Servidores Adicionales en OpenAPI

**Definición:** Se puede configurar servers en la inicialización de FastAPI para que se muestren opciones de URL adicionales en la documentación de la API (ej: entornos de staging y producción).

**Ejemplo:**

```Python
from fastapi import FastAPI

app = FastAPI(
    servers=[
        {"url": "https://stag.example.com", "description": "Staging"},
        {"url": "https://prod.example.com", "description": "Producción"},
    ],
    root_path="/api/v1",
)
```

(OpenAPI mostrará /api/v1 (del root_path) y las URLs adicionales)

## G - Deshabilitar Servidor Automático de root_path

**Definición:** Se puede usar root_path_in_servers=False para evitar que FastAPI agregue automáticamente un servidor con el prefijo de root_path a la lista de servers en la especificación OpenAPI.

**Ejemplo:**

```Python
from fastapi import FastAPI

app = FastAPI(
    servers=[
       {"url": "https://example.com", "description": "Producción"},
    ],
    root_path="/api/v1",
    root_path_in_servers=False,
)
```

(OpenAPI NO incluirá un servidor con el root_path /api/v1 en la definición de la documentación de la API)

## H - Sub-Aplicaciones con root_path

**Definición:** Las sub-aplicaciones montadas funcionan correctamente con root_path, FastAPI gestiona todo internamente para que no haya conflictos.

**Ejemplo:**
(Combinar los ejemplos de sub-aplicaciones y el parámetro root_path debería ser intuitivo dado lo aprendido en los puntos anteriores)

```Python
from fastapi import FastAPI

app = FastAPI(root_path="/api/v1")

sub_app = FastAPI()

@sub_app.get("/items")
def read_items():
    return {"items": ["item1", "item2"]}

app.mount("/sub_app", sub_app)
```

En este caso la documentación de la sub_app se encontraría en /api/v1/sub_app/docs

**Nota:** Esta sección es bastante técnica y requiere una comprensión de la arquitectura de un proxy y las especificaciones ASGI. La idea clave es que root_path ayuda a alinear las expectativas del front-end y back-end cuando se usa un proxy con un prefijo de ruta.
