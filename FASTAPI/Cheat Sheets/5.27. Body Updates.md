## A - Actualización de datos con `PUT`

**Definición:**  
El método HTTP `PUT` se utiliza para reemplazar completamente un recurso existente con nuevos datos. Si el recurso no existe, puede crearlo. FastAPI permite usar `PUT` para actualizar datos en una base de datos o almacenamiento.

**Advertencia:**  
Al usar `PUT`, si no proporcionas todos los campos del modelo, los campos faltantes se establecerán con sus valores predeterminados, lo que podría sobrescribir datos existentes.

Ejemplo:

```python
from fastapi import FastAPI
from fastapi.encoders import jsonable_encoder
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str | None = None
    description: str | None = None
    price: float | None = None
    tax: float = 10.5
    tags: list[str] = []

items = {
    "foo": {"name": "Foo", "price": 50.2},
    "bar": {"name": "Bar", "description": "The bartenders", "price": 62, "tax": 20.2},
}

@app.put("/items/{item_id}", response_model=Item)
async def update_item(item_id: str, item: Item):
    update_item_encoded = jsonable_encoder(item)
    items[item_id] = update_item_encoded
    return update_item_encoded
```

**Descripción:**

- `PUT` reemplaza completamente el recurso identificado por `item_id`.
- `jsonable_encoder` convierte el modelo Pydantic en un diccionario compatible con JSON.
- Si no se proporciona un campo (por ejemplo, `tax`), se usará el valor predeterminado (10.5).

---

## B - Actualizaciones parciales con `PATCH`

**Definición:**  
El método HTTP `PATCH` se utiliza para realizar actualizaciones parciales de un recurso. Solo se envían los campos que se desean modificar, y el resto de los campos permanecen intactos.

**Nota:**  
Aunque `PATCH` es menos común que `PUT`, es más adecuado para actualizaciones parciales.

Ejemplo:

```python
@app.patch("/items/{item_id}", response_model=Item)
async def update_item(item_id: str, item: Item):
    stored_item_data = items[item_id]
    stored_item_model = Item(**stored_item_data)
    update_data = item.dict(exclude_unset=True)
    updated_item = stored_item_model.copy(update=update_data)
    items[item_id] = jsonable_encoder(updated_item)
    return updated_item
```

**Descripción:**

- `exclude_unset=True` en `item.dict()` asegura que solo se incluyan los campos que se enviaron en la solicitud.
- `stored_item_model.copy(update=update_data)` aplica las actualizaciones parciales al modelo existente.
- `jsonable_encoder` convierte el modelo actualizado en un diccionario compatible con JSON.

---

## C - Uso de `exclude_unset` en Pydantic

**Definición:**  
El parámetro `exclude_unset` en Pydantic permite generar un diccionario que excluye los campos que no se han establecido explícitamente (es decir, que tienen valores predeterminados o son `None`). Esto es útil para actualizaciones parciales.

**Nota:**  
En Pydantic v2, el método se llama `.model_dump()` en lugar de `.dict()`.

Ejemplo:

```python
update_data = item.dict(exclude_unset=True)
```

**Descripción:**

- `exclude_unset=True` asegura que solo se incluyan los campos que el usuario envió en la solicitud.
- Esto evita sobrescribir campos existentes con valores predeterminados.

---

## D - Uso del parámetro `update` en Pydantic

**Definición:**  
El parámetro `update` en Pydantic permite crear una copia de un modelo existente y aplicar actualizaciones parciales. Esto es útil para combinar datos existentes con nuevos datos.

**Nota:**  
En Pydantic v2, el método se llama `.model_copy()` en lugar de `.copy()`.

Ejemplo:

```python
updated_item = stored_item_model.copy(update=update_data)
```

**Descripción:**

- `update=update_data` aplica los cambios parciales al modelo almacenado.
- Esto permite actualizar solo los campos especificados sin afectar los demás.

---

## E - Resumen de actualizaciones parciales

**Definición:**  
Para realizar actualizaciones parciales con `PATCH`, sigue estos pasos:

1.  Recupera los datos almacenados.
2.  Convierte los datos en un modelo Pydantic.
3.  Genera un diccionario con solo los campos enviados en la solicitud (`exclude_unset=True`).
4.  Crea una copia del modelo almacenado y aplica las actualizaciones (`copy(update=update_data)`).
5.  Convierte el modelo actualizado en un formato compatible con JSON (`jsonable_encoder`).
6.  Guarda los datos actualizados.
7.  Devuelve el modelo actualizado.

Ejemplo completo:

```python
@app.patch("/items/{item_id}", response_model=Item)
async def update_item(item_id: str, item: Item):
    stored_item_data = items[item_id]
    stored_item_model = Item(**stored_item_data)
    update_data = item.dict(exclude_unset=True)
    updated_item = stored_item_model.copy(update=update_data)
    items[item_id] = jsonable_encoder(updated_item)
    return updated_item
```

**Descripción:**

- Este enfoque asegura que solo se actualicen los campos enviados en la solicitud.
- Los campos no enviados conservan sus valores originales.

---

## F - Consideraciones adicionales

**Definición:**

- **Validación:** Los modelos de entrada aún se validan, incluso en actualizaciones parciales. Si un campo no es opcional, debe proporcionarse o tener un valor predeterminado.
- **Uso de `PUT` para actualizaciones parciales:** Aunque `PATCH` es más adecuado, también puedes usar `PUT` para actualizaciones parciales si lo prefieres.

**Nota:**  
Si todos los campos de tu modelo son opcionales, puedes usar el mismo modelo para creaciones y actualizaciones. De lo contrario, considera usar modelos separados para cada caso.
