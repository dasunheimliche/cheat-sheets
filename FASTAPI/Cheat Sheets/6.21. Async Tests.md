## A - Pruebas asíncronas en FastAPI

**Definición:**  
Las pruebas asíncronas son útiles cuando necesitas probar código que realiza operaciones asíncronas, como consultas a una base de datos o llamadas a servicios externos. En FastAPI, puedes escribir pruebas asíncronas utilizando `pytest` y `HTTPX`.

Ejemplo:

```python
import pytest
from httpx import AsyncClient, ASGITransport
from .main import app

@pytest.mark.anyio
async def test_root():
    async with AsyncClient(transport=ASGITransport(app=app), base_url="http://test") as ac:
        response = await ac.get("/")
    assert response.status_code == 200
    assert response.json() == {"message": "Tomato"}
```

Descripción del ejemplo:

- `@pytest.mark.anyio` marca la prueba como asíncrona.
- `AsyncClient` es un cliente HTTP asíncrono que permite realizar solicitudes a la aplicación FastAPI.
- `await ac.get("/")` realiza una solicitud GET asíncrona a la ruta `/`.
- Las aserciones verifican que la respuesta tenga un código de estado 200 y que el contenido sea el esperado.

---

## B - `pytest.mark.anyio`

**Definición:**  
`@pytest.mark.anyio` es un marcador de `pytest` que indica que una función de prueba debe ejecutarse de manera asíncrona. Esto es necesario cuando la prueba contiene llamadas a funciones asíncronas (`async def`).

Ejemplo:

```python
@pytest.mark.anyio
async def test_example():
    # Código de prueba asíncrono
    pass
```

Descripción del ejemplo:

- Este marcador permite que `pytest` ejecute la función de prueba en un entorno asíncrono.

---

## C - `AsyncClient` de HTTPX

**Definición:**  
`AsyncClient` es un cliente HTTP asíncrono proporcionado por la biblioteca `HTTPX`. Se utiliza para realizar solicitudes HTTP asíncronas a una aplicación FastAPI durante las pruebas. A diferencia de `TestClient`, `AsyncClient` funciona correctamente en funciones de prueba asíncronas.

Ejemplo:

```python
from httpx import AsyncClient, ASGITransport

async with AsyncClient(transport=ASGITransport(app=app), base_url="http://test") as ac:
    response = await ac.get("/")
```

Descripción del ejemplo:

- `ASGITransport` permite que `AsyncClient` interactúe con la aplicación FastAPI.
- `await ac.get("/")` realiza una solicitud GET asíncrona a la ruta `/`.

---

## D - Eventos de ciclo de vida (`lifespan`)

**Definición:**  
Si tu aplicación FastAPI depende de eventos de ciclo de vida (como `startup` o `shutdown`), el `AsyncClient` no los activará automáticamente. Para manejar esto, puedes usar `LifespanManager` de la biblioteca `asgi-lifespan`.

Ejemplo:

```python
from asgi_lifespan import LifespanManager

async with LifespanManager(app):
    async with AsyncClient(app=app, base_url="http://test") as ac:
        response = await ac.get("/")
```

Descripción del ejemplo:

- `LifespanManager` asegura que los eventos de ciclo de vida se ejecuten antes y después de las pruebas.

---

## E - Integración con otras bibliotecas asíncronas

**Definición:**  
Al integrar pruebas asíncronas con bibliotecas que requieren un bucle de eventos (como `MotorClient` para MongoDB), es importante asegurarse de que los objetos que necesitan un bucle de eventos se instancien dentro de funciones asíncronas.

Ejemplo:

```python
from motor.motor_asyncio import AsyncIOMotorClient

@pytest.mark.anyio
async def test_mongo_integration():
    client = AsyncIOMotorClient("mongodb://localhost:27017")
    # Realizar operaciones asíncronas con el cliente de MongoDB
```

Descripción del ejemplo:

- `AsyncIOMotorClient` se instancia dentro de una función asíncrona para evitar errores relacionados con el bucle de eventos.

---

### Resumen del Cheat Sheet

1.  **Pruebas asíncronas:** Usar `async def` y `await` para probar código asíncrono.
2.  **`pytest.mark.anyio`:** Marcador para ejecutar pruebas asíncronas con `pytest`.
3.  **`AsyncClient`:** Cliente HTTP asíncrono para realizar solicitudes a FastAPI.
4.  **Eventos de ciclo de vida:** Usar `LifespanManager` para manejar eventos `startup` y `shutdown`.
5.  **Integración asíncrona:** Instanciar objetos que requieren un bucle de eventos dentro de funciones asíncronas.
