## A - Pruebas Asíncronas (Async Tests)

**Definición:** Pruebas que utilizan funciones async def para interactuar con la aplicación FastAPI. Son útiles cuando las pruebas necesitan realizar operaciones asíncronas, como consultar bases de datos asíncronas o interactuar con servicios externos.

**Ejemplo:** Una prueba que consulta una base de datos usando un cliente asíncrono después de hacer una petición a una ruta de FastAPI.

(Las pruebas asíncronas permiten una mejor integración con el resto de código de la app si este también utiliza funciones async).

## B - pytest.mark.anyio

**Definición:** Un marcador de pytest del plugin AnyIO, que indica que una función de prueba (async def) debe ejecutarse de forma asíncrona.

**Ejemplo:**

```Python
import pytest

@pytest.mark.anyio
async def test_my_async_function():
    # ...
    pass
```

(El decorador @pytest.mark.anyio indica que test_my_async_function se ejecuta en un loop de eventos.)

## C - httpx.AsyncClient

**Definición:** Un cliente HTTP asíncrono de la librería HTTPX. Se utiliza para hacer peticiones asíncronas a la aplicación FastAPI en las pruebas. Es la herramienta apropiada para testear aplicaciones asíncronas.

**Ejemplo:**

```Python
import httpx

async def test_my_async_function():
  async with httpx.AsyncClient() as client:
    response = await client.get("http://test/items")
    # ...
    pass
```

(Se usa httpx.AsyncClient para realizar peticiones HTTP asíncronas y esperar sus respuestas)

## D - httpx.ASGITransport

**Definición:** Un adaptador de HTTPX que permite realizar peticiones directamente a una aplicación ASGI (como FastAPI) sin necesidad de un servidor HTTP real.

**Ejemplo:**

```Python
from httpx import ASGITransport, AsyncClient

async def test_root(app):
    async with AsyncClient(
        transport=ASGITransport(app=app), base_url="http://test"
    ) as ac:
        response = await ac.get("/")
        # ...
```

(El adaptador ASGITransport se inicializa con la instancia de la aplicación y AsyncClient utiliza dicho adaptador para hacer las peticiones)

## E - Bloque async with con AsyncClient

**Definición:** Un bloque async with asegura que AsyncClient se cierre correctamente al final del bloque, liberando recursos. Es una buena práctica para manejar los recursos de manera adecuada.

**Ejemplo:**

```Python
async def test_root(app):
  async with httpx.AsyncClient(transport=httpx.ASGITransport(app=app)) as client:
    # ...
    pass
```

(El AsyncClient se crea en el bloque async with, se utiliza y al terminar el bloque se cierra automáticamente.)

## F - Llamadas a Funciones Asíncronas en Pruebas

**Definición:** Al utilizar pruebas asíncronas, se puede llamar (y usar await) a otras funciones asíncronas dentro de los tests, como por ejemplo funciones que interactúan con una base de datos asíncrona.

**Ejemplo:**

```Python
import pytest
from httpx import ASGITransport, AsyncClient

from .main import app


@pytest.mark.anyio
async def test_async_db_query():
    async with AsyncClient(
        transport=ASGITransport(app=app), base_url="http://test"
    ) as ac:
        response = await ac.get("/")
    #Aqui podemos testear el resultado de una consulta a la base de datos
    db_result = await query_db()
    assert db_result == {"value": 1}
```

(En este ejemplo query_db podría ser una función que consulta una base de datos y la llamada a esta función también necesita utilizar await.)

## G - RuntimeError: Task attached to a different loop

**Definición:** Un error común al mezclar código síncrono y asíncrono. Se puede evitar instanciando objetos que necesitan un loop de eventos dentro de funciones asíncronas, como @app.on_event("startup").

**Ejemplo:**

(Por ejemplo al utilizar MotorClient de MongoDB se debe inicializar en una función async como por ejemplo en el evento startup y no a nivel global.)
