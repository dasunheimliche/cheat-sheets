## A - OAuth2 con FastAPI (Primeros pasos)

**Definición:**  
OAuth2 es un estándar para manejar autenticación y autorización. En este caso, se utiliza el flujo "password" de OAuth2, donde el frontend envía un `username` y `password` para obtener un token. FastAPI proporciona herramientas como `OAuth2PasswordBearer` para simplificar este proceso.

**Ejemplo:**

```python
from fastapi import FastAPI, Depends
from fastapi.security import OAuth2PasswordBearer

app = FastAPI()

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

@app.get("/items/")
async def read_items(token: str = Depends(oauth2_scheme)):
    return {"token": token}
```

**Descripción del ejemplo:**  
Este código configura un esquema de seguridad OAuth2 en FastAPI. `OAuth2PasswordBearer` define que el token se obtendrá en la URL `/token`. La dependencia `oauth2_scheme` se usa para asegurar que el endpoint `/items/` requiera un token.

---

## B - Flujo de autenticación "password"

**Definición:**  
El flujo "password" es uno de los métodos de OAuth2 para autenticar usuarios. El frontend envía un `username` y `password` a la API, que responde con un token. Este token se usa luego para autenticar solicitudes futuras.

**Pasos del flujo:**

1.  El usuario ingresa `username` y `password` en el frontend.
2.  El frontend envía estos datos a la URL `/token`.
3.  La API verifica las credenciales y devuelve un token.
4.  El frontend almacena el token y lo envía en el encabezado `Authorization` para futuras solicitudes.

**Ejemplo de encabezado:**
Authorization: Bearer <token>

---

## C - `OAuth2PasswordBearer`

**Definición:**  
`OAuth2PasswordBearer` es una clase de FastAPI que simplifica la implementación del flujo "password" de OAuth2. Se configura con una URL (`tokenUrl`) donde el frontend enviará las credenciales para obtener el token.

**Ejemplo:**

```python
from fastapi import Depends, FastAPI
from fastapi.security import OAuth2PasswordBearer

app = FastAPI()

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

@app.get("/items/")
async def read_items(token: str = Depends(oauth2_scheme)):
    return {"token": token}
```

**Descripción del ejemplo:**  
Aquí, `OAuth2PasswordBearer` se configura para usar la URL `/token`. La dependencia `oauth2_scheme` asegura que el endpoint `/items/` requiera un token válido en el encabezado `Authorization`.

---

## D - Integración con OpenAPI y documentación interactiva

**Definición:**  
FastAPI integra automáticamente los esquemas de seguridad en la documentación interactiva (Swagger UI). Esto permite probar la autenticación directamente desde la interfaz de documentación.

**Cómo funciona:**

1.  FastAPI detecta el uso de `OAuth2PasswordBearer`.
2.  Añade un botón "Authorize" en la documentación interactiva.
3.  Los usuarios pueden ingresar credenciales y obtener un token para probar los endpoints protegidos.

**Ejemplo:**  
![](https://fastapi.tiangolo.com/img/tutorial/security/image01.png)

---

## E - Manejo de errores de autenticación

**Definición:**  
Si el token no está presente o es inválido, FastAPI automáticamente devuelve un error HTTP 401 (`UNAUTHORIZED`). No es necesario verificar manualmente la presencia del token.

**Ejemplo de error:**

```json
{
  "detail": "Not authenticated"
}
```

---

## F - Uso de `Annotated` (Python 3.9+)

**Definición:**  
`Annotated` es una forma moderna de definir dependencias en FastAPI. Proporciona una sintaxis más clara y es preferible en Python 3.9 y versiones posteriores.

**Ejemplo:**

```python
from typing import Annotated
from fastapi import Depends, FastAPI
from fastapi.security import OAuth2PasswordBearer

app = FastAPI()

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

@app.get("/items/")
async def read_items(token: Annotated[str, Depends(oauth2_scheme)]):
    return {"token": token}
```

**Descripción del ejemplo:**  
Este código es equivalente al ejemplo anterior, pero usa `Annotated` para definir la dependencia de manera más explícita.

---

## G - Instalación de dependencias adicionales

**Definición:**  
Para usar OAuth2 con FastAPI, es necesario instalar el paquete `python-multipart`, ya que OAuth2 utiliza datos de formulario para enviar `username` y `password`.

**Comando de instalación:**

```bash
pip install python-multipart
```
