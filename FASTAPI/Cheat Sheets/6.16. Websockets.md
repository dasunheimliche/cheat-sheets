## A - WebSockets

**Definición:** Un protocolo de comunicación bidireccional y persistente entre un cliente (ej: navegador web) y un servidor. Permite enviar y recibir datos en tiempo real sin necesidad de establecer una nueva conexión para cada intercambio.

**Ejemplo:** Un chat en tiempo real, un juego multijugador, actualizaciones de datos en vivo.

(Similar al concepto de websockets en otros entornos, pero facilitado por FastAPI)

## B - WebSocket

**Definición:** Clase de fastapi (o starlette) que representa una conexión WebSocket. Proporciona métodos para aceptar la conexión (.accept()), recibir mensajes (.receive_text(), .receive_bytes(), .receive_json()), y enviar mensajes (.send_text(), .send_bytes(), .send_json()).

**Ejemplo:**

```Python
from fastapi import WebSocket

@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
  # Aqui se maneja la conexión websocket
  pass
```

(El parámetro websocket representa una conexión WebSocket individual)

## C - Ruta WebSocket

**Definición:** Una ruta específica en una aplicación FastAPI que se define para manejar conexiones WebSockets. Se declara con el decorador @app.websocket().

**Ejemplo:**

```Python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
  await websocket.accept()
  while True:
    data = await websocket.receive_text()
    await websocket.send_text(f"Recibido: {data}")
```

(La ruta /ws manejara las conexiones websocket)

## D - Aceptar Conexión (.accept())

**Definición:** Método de la instancia WebSocket que acepta la conexión WebSocket establecida por el cliente. Debe ser la primera operación que se ejecute en la ruta WebSocket.

**Ejemplo:**

```Python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept() #Acepta la conexión
    # Resto del manejo del websocket
```

(Si no se acepta la conexión, no se podrán recibir o enviar datos.)

## E - Recibir Mensajes (.receive_text(), .receive_bytes(), .receive_json())

**Definición:** Métodos para recibir datos del cliente a través de la conexión WebSocket. .receive_text() recibe texto (string), .receive_bytes() recibe bytes y .receive_json() recibe un diccionario JSON, se recomienda utilizar la que mas se adecue al caso. Son corrutinas que esperan hasta que haya un nuevo mensaje.

**Ejemplo:**

```Python
data = await websocket.receive_text() #Espera y recibe un mensaje de texto
```

(La variable data contendra el texto recibido desde el cliente.)

## F - Enviar Mensajes (.send_text(), .send_bytes(), .send_json())

**Definición:** Métodos para enviar datos al cliente a través de la conexión WebSocket. .send_text() envia texto (string), .send_bytes() envia bytes y .send_json() envia un diccionario como formato JSON.

**Ejemplo:**

```Python
await websocket.send_text(f"Mensaje: {data}") # Envia un mensaje de texto al cliente
```

(El cliente recibira el texto enviado a traves de esta instrucción)

## G - WebSocketDisconnect

**Definición:** Una excepción que se genera cuando la conexión WebSocket se cierra (por el cliente o el servidor). Se puede usar en un bloque try...except para manejar las desconexiones de manera limpia.

**Ejemplo:**

```Python
from fastapi import WebSocket, WebSocketDisconnect
# ...
try:
  while True:
    data = await websocket.receive_text()
    # ...
except WebSocketDisconnect:
  print("Cliente desconectado")
```

(Captura la desconexión del cliente y hace algo al respecto)

## H - Dependencias en WebSockets

**Definición:** Se pueden usar dependencias (ej: Depends, Security, Cookie, Header, Path, Query) en rutas WebSockets de la misma manera que en las rutas HTTP. Esto permite manejar autenticación, datos de sesión y otras tareas antes de aceptar la conexión.

**Ejemplo:**

```Python
from fastapi import WebSocket, Depends, Query, Cookie
from typing import Annotated

async def get_token(token: Annotated[str | None, Query()] = None, session: Annotated[str | None, Cookie()] = None):
    return session or token


@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket, token: str = Depends(get_token)):
  await websocket.accept()
  # ...
```

(La función get_token extrae el token y es una dependencia que se ejecuta antes de aceptar la conexión.)

## I - Manejo de Múltiples Clientes

**Definición:** Implica mantener un registro de las conexiones WebSockets activas para poder enviar mensajes a clientes específicos o a todos los clientes (broadcast). Un ejemplo común es manejar listas de objetos WebSocket para realizar un sistema de chat.

**Ejemplo (Simplificado):**

```Python
from fastapi import FastAPI, WebSocket, WebSocketDisconnect

class ConnectionManager:
    def __init__(self):
        self.active_connections: list[WebSocket] = []

    async def connect(self, websocket: WebSocket):
        await websocket.accept()
        self.active_connections.append(websocket)

    def disconnect(self, websocket: WebSocket):
        self.active_connections.remove(websocket)

    async def broadcast(self, message: str):
        for connection in self.active_connections:
            await connection.send_text(message)
```

(La clase ConnectionManager gestiona la lista de conexiones activas para enviar mensajes a todas.)
