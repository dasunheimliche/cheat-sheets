## A - OAuth2 Basic Concept

**Definición:** OAuth2 scopes son strings que representan permisos específicos dentro de un sistema de autenticación, permitiendo un control granular sobre lo que un usuario puede hacer.

**Ejemplo:**

```python

# Definición básica de OAuth2 con scopes
oauth2_scheme = OAuth2PasswordBearer(
    tokenUrl="token",
    scopes={
        "read": "Read access to resources",
        "write": "Write access to resources"
    }
)
```

(Muestra cómo definir scopes básicos para lectura y escritura)

## B - Declaración de Scopes en Path Operations

**Definición:** Los scopes se pueden requerir en operaciones específicas usando Security en lugar de Depends.

**Ejemplo:**

```python

@app.get("/items/")
async def read_items(
    user: Annotated[User, Security(get_current_user, scopes=["items:read"])]
):
    return [{"item": "secret"}]
```

(Demuestra cómo proteger una ruta requiriendo un scope específico)

## C - Token con Scopes

**Definición:** Los JWT tokens deben incluir los scopes otorgados al usuario, que luego se verifican en las peticiones.

**Ejemplo:**

```python

def create_access_token(username: str, scopes: list[str]):
    token_data = {
        "sub": username,
        "scopes": scopes,
        "exp": datetime.now(timezone.utc) + timedelta(minutes=30)
    }
    return jwt.encode(token_data, SECRET_KEY, algorithm=ALGORITHM)
```

(Ilustra cómo incluir scopes en un token JWT)

## D - Verificación de Scopes

**Definición:** Los scopes deben verificarse al validar el token para asegurar que el usuario tiene los permisos necesarios.

**Ejemplo:**

```python

async def verify_token_scopes(token: str, required_scopes: list[str]):
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        token_scopes = payload.get("scopes", [])

        for scope in required_scopes:
            if scope not in token_scopes:
                raise HTTPException(
                    status_code=401,
                    detail="Insufficient permissions",
                    headers={"WWW-Authenticate": f'Bearer scope="{" ".join(required_scopes)}"'}
                )
        return True
    except jwt.InvalidTokenError:
        raise HTTPException(status_code=401, detail="Invalid token")
```

(Muestra la validación de scopes en un token)

## E - SecurityScopes Usage

**Definición:** SecurityScopes es una clase que permite acceder a todos los scopes requeridos en una cadena de dependencias.

**Ejemplo:**

```python

async def get_current_user(
    security_scopes: SecurityScopes,
    token: Annotated[str, Depends(oauth2_scheme)]
):
    if security_scopes.scopes:
        authenticate_value = f'Bearer scope="{security_scopes.scope_str}"'
    else:
        authenticate_value = "Bearer"

    # Verificación de token y scopes
    try:
        # ... verificación del token ...
        for scope in security_scopes.scopes:
            if scope not in token_scopes:
                raise HTTPException(
                    status_code=401,
                    detail="Not enough permissions"
                )
    except Exception:
        raise HTTPException(
            status_code=401,
            headers={"WWW-Authenticate": authenticate_value}
        )
```

(Demuestra el uso de SecurityScopes para manejar scopes en dependencias)
