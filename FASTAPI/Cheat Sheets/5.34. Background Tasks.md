## A - Background Tasks

**Definición:** Las tareas en segundo plano son operaciones que se ejecutan después de devolver una respuesta al cliente. Son útiles para acciones que no requieren que el cliente espere a que se completen antes de recibir la respuesta.

**Ejemplo:** Enviar notificaciones por correo electrónico después de realizar una acción. Conectar a un servidor de correo y enviar un correo puede ser lento, por lo que se puede devolver la respuesta inmediatamente y enviar el correo en segundo plano.

## B - Crear una función de tarea

**Definición:** Una función de tarea es una función estándar que puede recibir parámetros y se ejecuta en segundo plano. Puede ser una función async def o def normal.

**Ejemplo:**

```python
def write_notification(email: str, message=""):
    with open("log.txt", mode="w") as email_file:
        content = f"notification for {email}: {message}"
        email_file.write(content)
```

## C - Añadir la tarea en segundo plano

**Definición:** Dentro de tu función de operación de ruta, pasa tu función de tarea al objeto de tareas en segundo plano usando el método .add_task().

**Ejemplo:**

```python
@app.post("/send-notification/{email}")
async def send_notification(email: str, background_tasks: BackgroundTasks):
    background_tasks.add_task(write_notification, email, message="some notification")
    return {"message": "Notification sent in the background"}
```

## D - Inyección de dependencias

**Definición:** El uso de BackgroundTasks también funciona con el sistema de inyección de dependencias de FastAPI. Puedes declarar un parámetro de tipo BackgroundTasks en múltiples niveles: en una función de operación de ruta, en una dependencia, en una sub-dependencia, etc.

**Ejemplo:**

```python
def get_query(background_tasks: BackgroundTasks, q: str | None = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(email: str, background_tasks: BackgroundTasks, q: Annotated[str, Depends(get_query)]):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

## E - Detalles técnicos

**Definición:** La clase BackgroundTasks proviene directamente de starlette.background. Se importa directamente en FastAPI para evitar confusiones con BackgroundTask (sin la 's' al final).

**Ejemplo:**

```python
from fastapi import BackgroundTasks
# Uso correcto de BackgroundTasks
```

## F - Advertencia

**Definición:** Para tareas de computación pesada en segundo plano que no necesitan ejecutarse en el mismo proceso, se recomienda usar herramientas más grandes como Celery.

**Ejemplo:** Usar Celery con RabbitMQ o Redis para ejecutar tareas en segundo plano en múltiples procesos y servidores.
