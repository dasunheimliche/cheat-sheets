## A - Tareas en segundo plano (Background Tasks)

**Definición:**  
Las tareas en segundo plano permiten ejecutar operaciones después de que se ha enviado una respuesta al cliente. Esto es útil para tareas que no requieren que el cliente espere a que se completen, como enviar correos electrónicos o procesar datos pesados.

**Ejemplo de uso:**

```python
from fastapi import BackgroundTasks, FastAPI

app = FastAPI()

def write_notification(email: str, message=""):
    with open("log.txt", mode="w") as email_file:
        content = f"notification for {email}: {message}"
        email_file.write(content)

@app.post("/send-notification/{email}")
async def send_notification(email: str, background_tasks: BackgroundTasks):
    background_tasks.add_task(write_notification, email, message="some notification")
    return {"message": "Notification sent in the background"}
```

**Descripción del ejemplo:**

- Se define una función `write_notification` que simula enviar una notificación por correo electrónico.
- En la ruta `/send-notification/{email}`, se agrega la tarea `write_notification` al objeto `background_tasks`.
- La respuesta se envía inmediatamente, y la tarea se ejecuta en segundo plano.

---

## B - Creación de una función de tarea

**Definición:**  
Una función de tarea es una función normal o asíncrona que realiza una operación específica. Puede recibir parámetros y ser ejecutada en segundo plano.

**Ejemplo:**

```python
def write_notification(email: str, message=""):
    with open("log.txt", mode="w") as email_file:
        content = f"notification for {email}: {message}"
        email_file.write(content)
```

**Descripción del ejemplo:**

- La función `write_notification` es una función normal (`def`) que escribe en un archivo.
- No es necesario que sea asíncrona (`async def`) a menos que realice operaciones que requieran `await`.

---

## C - Agregar una tarea en segundo plano

**Definición:**  
Para agregar una tarea en segundo plano, se utiliza el método `.add_task()` del objeto `BackgroundTasks`. Este método recibe la función de tarea y sus argumentos.

**Ejemplo:**

```python
background_tasks.add_task(write_notification, email, message="some notification")
```

**Descripción del ejemplo:**

- `write_notification` es la función que se ejecutará en segundo plano.
- `email` y `message="some notification"` son los argumentos que se pasan a la función.

---

## D - Inyección de dependencias con `BackgroundTasks`

**Definición:**  
`BackgroundTasks` se puede usar con el sistema de inyección de dependencias de FastAPI. Puedes declarar un parámetro de tipo `BackgroundTasks` en una función de ruta, en una dependencia o en una subdependencia.

**Ejemplo:**

```python
from typing import Annotated
from fastapi import BackgroundTasks, Depends, FastAPI

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: str | None = None):
    if q:
        message = f"found query: {q}n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: Annotated[str, Depends(get_query)]
):
    message = f"message to {email}n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

**Descripción del ejemplo:**

- La dependencia `get_query` agrega una tarea en segundo plano si se proporciona un parámetro de consulta `q`.
- La función de ruta `send_notification` también agrega una tarea en segundo plano para escribir un mensaje en el archivo de registro.

---

## E - Detalles técnicos de `BackgroundTasks`

**Definición:**  
La clase `BackgroundTasks` proviene de Starlette y se integra directamente en FastAPI. Es importante usar `BackgroundTasks` (con una "s" al final) en lugar de `BackgroundTask` para aprovechar la integración con FastAPI.

**Ejemplo de uso incorrecto:**

```python
from starlette.background import BackgroundTask  # ¡No uses esto!
```

**Ejemplo de uso correcto:**

```python
from fastapi import BackgroundTasks  # Usa esto en su lugar
```

**Descripción del ejemplo:**

- `BackgroundTasks` es la clase recomendada para trabajar con tareas en segundo plano en FastAPI.
- `BackgroundTask` (sin la "s") es una clase de Starlette que requiere un manejo manual y no se integra tan fácilmente con FastAPI.

---

## F - Limitaciones de `BackgroundTasks`

**Definición:**  
Si necesitas realizar tareas en segundo plano que requieren mucho procesamiento o que deben ejecutarse en múltiples servidores, es mejor usar herramientas como **Celery**. `BackgroundTasks` es ideal para tareas pequeñas y rápidas, como enviar notificaciones por correo electrónico.

**Ejemplo de uso de Celery:**

```python
# Requiere configuración adicional (RabbitMQ, Redis, etc.)
from celery import Celery

app = Celery('tasks', broker='pyamqp://guest@localhost//')

@app.task
def send_email(email, message):
    # Lógica para enviar correo electrónico
    pass
```

**Descripción del ejemplo:**

- Celery es una herramienta más robusta para tareas en segundo plano que requieren escalabilidad.
- `BackgroundTasks` es más simple y adecuado para tareas pequeñas dentro de la misma aplicación FastAPI.
