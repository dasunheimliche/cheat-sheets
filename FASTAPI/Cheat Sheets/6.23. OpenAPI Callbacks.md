## A - Callbacks en OpenAPI

**Definición:**  
Un callback es una solicitud que tu API realiza a una API externa después de que un cliente (usuario de tu API) realiza una acción. Esto es útil para notificar al cliente sobre eventos, como el pago exitoso de una factura. FastAPI permite documentar cómo debería ser la API externa que recibirá el callback.

**Ejemplo:**

```python
from fastapi import APIRouter, FastAPI
from pydantic import BaseModel, HttpUrl

app = FastAPI()

class Invoice(BaseModel):
    id: str
    customer: str
    total: float

class InvoiceEvent(BaseModel):
    description: str
    paid: bool

class InvoiceEventReceived(BaseModel):
    ok: bool

# Router para el callback
invoices_callback_router = APIRouter()

@invoices_callback_router.post(
    "{$callback_url}/invoices/{$request.body.id}", response_model=InvoiceEventReceived
)
def invoice_notification(body: InvoiceEvent):
    pass

@app.post("/invoices/", callbacks=invoices_callback_router.routes)
def create_invoice(invoice: Invoice, callback_url: Union[HttpUrl, None] = None):
    return {"msg": "Invoice received"}
```

Descripción: Aquí se define un callback que notificará a una API externa sobre el estado de una factura. La ruta del callback se construye dinámicamente usando el `callback_url` y el `id` de la factura.

---

## B - Documentación de Callbacks

**Definición:**  
FastAPI permite documentar cómo debería ser la API externa que recibirá el callback. Esto se hace creando un `APIRouter` con las operaciones que la API externa debe implementar. Esta documentación aparece en la interfaz Swagger UI.

**Ejemplo:**

```python
from fastapi import APIRouter

invoices_callback_router = APIRouter()

@invoices_callback_router.post(
    "{$callback_url}/invoices/{$request.body.id}", response_model=InvoiceEventReceived
)
def invoice_notification(body: InvoiceEvent):
    pass
```

Descripción: Este código documenta cómo la API externa debe recibir el callback. La ruta usa una expresión OpenAPI para incluir el `callback_url` y el `id` de la factura.

---

## C - Expresiones OpenAPI en Callbacks

**Definición:**  
Las rutas de los callbacks pueden usar expresiones OpenAPI para incluir dinámicamente partes de la solicitud original, como parámetros de consulta o datos del cuerpo. Esto permite construir rutas personalizadas para cada callback.

**Ejemplo:**

```python
@invoices_callback_router.post(
    "{$callback_url}/invoices/{$request.body.id}", response_model=InvoiceEventReceived
)
def invoice_notification(body: InvoiceEvent):
    pass
```

Descripción: La ruta del callback usa `{$callback_url}` y `{$request.body.id}` para construir dinámicamente la URL a la que se enviará la notificación.

---

## D - Uso de `APIRouter` para Callbacks

**Definición:**  
Un `APIRouter` se usa para agrupar las operaciones de callback. Luego, este router se pasa al decorador de la operación principal usando el parámetro `callbacks`.

**Ejemplo:**

```python
@app.post("/invoices/", callbacks=invoices_callback_router.routes)
def create_invoice(invoice: Invoice, callback_url: Union[HttpUrl, None] = None):
    return {"msg": "Invoice received"}
```

Descripción: Aquí se asocia el router de callbacks (`invoices_callback_router`) con la operación principal `create_invoice`. Esto permite documentar el callback en la interfaz Swagger UI.

---

## E - Modelos Pydantic para Callbacks

**Definición:**  
Los modelos Pydantic se usan para definir la estructura de los datos que se enviarán y recibirán en los callbacks. Esto asegura que la API externa reciba y devuelva los datos en el formato correcto.

**Ejemplo:**

```python
class InvoiceEvent(BaseModel):
    description: str
    paid: bool

class InvoiceEventReceived(BaseModel):
    ok: bool
```

Descripción: `InvoiceEvent` define el cuerpo que se enviará en el callback, y `InvoiceEventReceived` define la respuesta esperada de la API externa.

---

## F - Integración de Callbacks en la Documentación

**Definición:**  
Al agregar el router de callbacks a una operación principal, FastAPI automáticamente incluye la documentación del callback en la interfaz Swagger UI. Esto ayuda a los desarrolladores externos a implementar correctamente la API que recibirá el callback.

**Ejemplo:**

```python
@app.post("/invoices/", callbacks=invoices_callback_router.routes)
def create_invoice(invoice: Invoice, callback_url: Union[HttpUrl, None] = None):
    return {"msg": "Invoice received"}
```

Descripción: La documentación del callback aparecerá en la sección "Callbacks" de la interfaz Swagger UI.

---

## G - Ejemplo Completo

**Definición:**  
Aquí tienes un ejemplo completo que integra todos los conceptos anteriores: creación de facturas, definición de callbacks y documentación en Swagger UI.

**Ejemplo:**

```python
from typing import Union
from fastapi import APIRouter, FastAPI
from pydantic import BaseModel, HttpUrl

app = FastAPI()

class Invoice(BaseModel):
    id: str
    customer: str
    total: float

class InvoiceEvent(BaseModel):
    description: str
    paid: bool

class InvoiceEventReceived(BaseModel):
    ok: bool

# Router para el callback
invoices_callback_router = APIRouter()

@invoices_callback_router.post(
    "{$callback_url}/invoices/{$request.body.id}", response_model=InvoiceEventReceived
)
def invoice_notification(body: InvoiceEvent):
    pass

@app.post("/invoices/", callbacks=invoices_callback_router.routes)
def create_invoice(invoice: Invoice, callback_url: Union[HttpUrl, None] = None):
    return {"msg": "Invoice received"}
```

Descripción: Este código define una API que crea facturas y notifica a una API externa mediante un callback. La documentación del callback se incluye automáticamente en Swagger UI.

---

## H - Recapitulación

**Definición:**

- Los callbacks permiten notificar a una API externa sobre eventos en tu API.
- Usa `APIRouter` para documentar cómo debería ser la API externa.
- Las expresiones OpenAPI permiten construir rutas dinámicas para los callbacks.
- Los modelos Pydantic aseguran que los datos se envíen y reciban en el formato correcto.
- La documentación de los callbacks aparece en Swagger UI.
