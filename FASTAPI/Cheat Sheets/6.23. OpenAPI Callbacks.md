## A - OpenAPI Callbacks

**Definición:** Un "callback" en una API es un proceso donde una operación en tu API desencadena una solicitud a una API externa, generalmente creada por el mismo desarrollador que usa tu API. Esencialmente, tu API "llama de vuelta" a la API externa después de realizar una acción.

**Ejemplo:**

```Python
from typing import Union
from fastapi import APIRouter, FastAPI
from pydantic import BaseModel, HttpUrl

app = FastAPI()

class Invoice(BaseModel):
    id: str
    title: Union[str, None] = None
    customer: str
    total: float

class InvoiceEvent(BaseModel):
    description: str
    paid: bool

class InvoiceEventReceived(BaseModel):
    ok: bool

invoices_callback_router = APIRouter()

@invoices_callback_router.post(
    "{$callback_url}/invoices/{$request.body.id}", response_model=InvoiceEventReceived
)
def invoice_notification(body: InvoiceEvent):
    pass

@app.post("/invoices/", callbacks=invoices_callback_router.routes)
def create_invoice(invoice: Invoice, callback_url: Union[HttpUrl, None] = None):
    """
    Crea una factura.

    Esta operación permite a un desarrollador externo crear una factura.
    Luego, la API:
    1. Envía la factura al cliente.
    2. Recauda el pago.
    3. Envía una notificación al desarrollador externo (callback).
    """
    return {"msg": "Invoice received"}
```

(En este ejemplo, al crear una factura en /invoices/, la API enviará una notificación a la URL especificada en callback_url, usando el id de la factura en la ruta. La función invoice_notification define la estructura de esta notificación, pero no se ejecuta directamente en la API principal, sino que sirve para documentar la API externa.)

## B - Documentación de Callbacks

**Definición:** La documentación de callbacks describe cómo debe ser la API externa que tu API llamará de vuelta. Esto incluye la ruta, el cuerpo de la solicitud, la respuesta esperada, etc. Se documenta usando las mismas herramientas de FastAPI que se usan para documentar la API principal.

**Ejemplo:**

```Python
invoices_callback_router = APIRouter()

@invoices_callback_router.post(
    "{$callback_url}/invoices/{$request.body.id}", response_model=InvoiceEventReceived
)
def invoice_notification(body: InvoiceEvent):
    pass
```

(Aquí, invoices_callback_router define la estructura de la API externa que recibirá el callback. La ruta usa expresiones OpenAPI para incluir la URL del callback y el ID de la factura. InvoiceEvent define el cuerpo de la solicitud y InvoiceEventReceived define la respuesta esperada. Esta definición no ejecuta código, sino que documenta la API externa.)

## C - APIRouter para Callbacks

**Definición:** Un APIRouter se utiliza para organizar y documentar las rutas de callback. Permite definir las operaciones que la API externa debe implementar para recibir las notificaciones de tu API.

**Ejemplo:**

```Python
invoices_callback_router = APIRouter()

@invoices_callback_router.post(
    "{$callback_url}/invoices/{$request.body.id}", response_model=InvoiceEventReceived
)
def invoice_notification(body: InvoiceEvent):
    pass
```

(En este ejemplo, invoices_callback_router es un APIRouter que contiene la definición de la ruta de callback. Esto permite separar la documentación de la API principal de la documentación de la API externa.)

## D - Expresiones OpenAPI en Rutas de Callback

**Definición:** Las rutas de callback pueden usar expresiones OpenAPI para incluir variables de la solicitud original a tu API. Esto permite que la ruta del callback sea dinámica y dependa de los datos enviados a tu API.

**Ejemplo:**

```Python
@invoices_callback_router.post(
    "{$callback_url}/invoices/{$request.body.id}", response_model=InvoiceEventReceived
)
def invoice_notification(body: InvoiceEvent):
    pass
```

(En este ejemplo, {$callback_url} se reemplaza por el valor del parámetro callback_url de la solicitud original, y {$request.body.id} se reemplaza por el valor del campo id del cuerpo de la solicitud original. Esto permite que la ruta del callback sea específica para cada factura.)

## E - Parámetro callbacks en Operaciones de Ruta

**Definición:** El parámetro callbacks en el decorador de una operación de ruta de FastAPI se utiliza para especificar las rutas de callback que se deben documentar. Recibe la lista de rutas del APIRouter de callbacks.

**Ejemplo:**

```Python
@app.post("/invoices/", callbacks=invoices_callback_router.routes)
def create_invoice(invoice: Invoice, callback_url: Union[HttpUrl, None] = None):
    ...
```

(Aquí, callbacks=invoices_callback_router.routes indica que las rutas definidas en invoices_callback_router deben ser documentadas como callbacks para la operación /invoices/. Es importante pasar .routes y no el router en sí.)

## F - Uso de HttpUrl

**Definición:** HttpUrl de Pydantic se utiliza para validar que un string sea una URL válida.

**Ejemplo:**

```Python
from pydantic import HttpUrl
from typing import Union

@app.post("/invoices/")
def create_invoice(invoice: Invoice, callback_url: Union[HttpUrl, None] = None):
    ...
```

(En este ejemplo, callback_url se define como Union[HttpUrl, None], lo que significa que puede ser una URL válida o None. Pydantic se encargará de validar que el valor sea una URL válida si se proporciona.)
