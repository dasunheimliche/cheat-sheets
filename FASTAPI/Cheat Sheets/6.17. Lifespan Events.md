## A - Eventos de Ciclo de Vida (Lifespan Events)

**Definición:** Funciones o lógica que se ejecutan al inicio (startup) y al cierre (shutdown) de una aplicación FastAPI. Estos eventos permiten realizar tareas de configuración y limpieza necesarias durante el ciclo de vida de la aplicación.

**Ejemplo:** Inicializar conexiones a bases de datos, cargar modelos de aprendizaje automático, cerrar archivos, limpiar recursos.

(Estos eventos no son llamados por cada request sino al iniciar y al terminar la aplicación)

## B - lifespan (Context Manager)

**Definición:** El método recomendado para manejar los eventos de ciclo de vida en FastAPI. Se define utilizando un async context manager con la sintaxis async def lifespan(app: FastAPI):. Contiene la lógica a ejecutar antes y después del inicio/cierre de la aplicación.

**Ejemplo:**

```Python
from contextlib import asynccontextmanager
from fastapi import FastAPI

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Código que se ejecuta al inicio
    print("Aplicación Iniciando")
    yield
    # Código que se ejecuta al cierre
    print("Aplicación Detenida")

app = FastAPI(lifespan=lifespan)
```

(Al iniciar la app, imprime "Aplicación Iniciando", y al cerrar imprime "Aplicación Detenida").

## C - async contextmanager

**Definición:** Un decorador de contextlib que transforma una función asíncrona en un "async context manager". Esto permite usar la función con async with, o con el parámetro lifespan de FastAPI. El código anterior al yield se ejecuta al ingresar al bloque with y el posterior al salir.

**Ejemplo:**

```Python
from contextlib import asynccontextmanager
from fastapi import FastAPI
import asyncio

@asynccontextmanager
async def my_context():
    print("Antes del yield")
    yield "dato"
    print("Despues del yield")

async def run():
  async with my_context() as data:
    print(f"Dentro del with: {data}")


asyncio.run(run())
```

(Este código imprimirá: "Antes del yield", "Dentro del with: dato", "Despues del yield")

## D - Parte Startup (Antes del yield)

**Definición:** La sección del código de un async context manager (usado como lifespan) que se ejecuta antes de que la aplicación comience a recibir peticiones. Se utiliza para inicializar recursos, configuraciones, etc.

**Ejemplo:**

```Python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Inicializar conexión a la base de datos
    db_connection = await init_db()
    app.state.db_connection = db_connection
    yield
    # ...
```

(El ejemplo inicializa la conexión a la base de datos y la deja disponible en la app para cada request).

## E - Parte Shutdown (Después del yield)

**Definición:** La sección del código que se ejecuta una vez que la aplicación deja de recibir peticiones, antes de detenerse. Se utiliza para liberar recursos, limpiar conexiones, guardar datos, etc.

**Ejemplo:**

```Python
@asynccontextmanager
async def lifespan(app: FastAPI):
    #...
    yield
    # Cerrar la conexión a la base de datos
    await app.state.db_connection.close()
    # ...
```

(Este código cierra la conexión de la base de datos al cerrar la aplicación.)

## F - app.state

**Definición:** Un diccionario que permite almacenar datos entre los ciclos de vida de la app. En la section startup podemos almacenar datos que utilizaremos en los request, ya que la misma instancia de la app se reutiliza para todas.

**Ejemplo:**
(Ver ejemplos anteriores donde se almacena una conexión a la base de datos).

## G - Eventos Alternativos (Deprecados: startup, shutdown)

**Definición:** Una forma anterior de manejar eventos de inicio y cierre en FastAPI usando los decoradores @app.on_event("startup") y @app.on_event("shutdown"), que ahora se desaconseja utilizar en favor del lifespan por ser una solucion mas completa y coherente.

**Ejemplo:**

```Python
from fastapi import FastAPI

app = FastAPI()

@app.on_event("startup")
async def startup_event():
  print("Startup Event")

@app.on_event("shutdown")
def shutdown_event():
    print("Shutdown Event")
```

(Ejecutará "Startup Event" al iniciar y "Shutdown Event" al cerrar la app)
