## A - Eventos de ciclo de vida (Lifespan Events)

**Definición:**  
Los eventos de ciclo de vida permiten ejecutar código antes de que la aplicación comience a recibir solicitudes (_startup_) y después de que la aplicación haya terminado de manejar solicitudes (_shutdown_). Esto es útil para inicializar recursos compartidos (como conexiones a bases de datos o modelos de machine learning) y liberarlos adecuadamente.

**Ejemplo básico:**

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI

def fake_answer_to_everything_ml_model(x: float):
    return x * 42

ml_models = {}

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Código de inicio (antes de recibir solicitudes)
    ml_models["answer_to_everything"] = fake_answer_to_everything_ml_model
    yield
    # Código de cierre (después de manejar solicitudes)
    ml_models.clear()

app = FastAPI(lifespan=lifespan)

@app.get("/predict")
async def predict(x: float):
    result = ml_models["answer_to_everything"](x)
    return {"result": result}
```

**Descripción del ejemplo:**

1.  Se define una función `lifespan` con `yield` para manejar el inicio y cierre de la aplicación.
2.  Antes del `yield`, se carga un modelo de machine learning en un diccionario compartido.
3.  Después del `yield`, se liberan los recursos (en este caso, se limpia el diccionario).
4.  La ruta `/predict` usa el modelo cargado durante el inicio.

---

## B - Caso de uso: Carga de modelos de machine learning

**Definición:**  
Un caso común es cargar modelos de machine learning que son compartidos entre múltiples solicitudes. Estos modelos pueden tardar en cargarse, por lo que es preferible hacerlo una sola vez al inicio de la aplicación, en lugar de cargarlos en cada solicitud.

**Ejemplo:**

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # Simulación de carga de un modelo
    ml_models["answer_to_everything"] = fake_answer_to_everything_ml_model
    yield
    # Liberación de recursos
    ml_models.clear()
```

**Descripción del ejemplo:**

1.  El modelo se carga antes de que la aplicación comience a recibir solicitudes.
2.  El modelo se libera después de que la aplicación haya terminado de manejar solicitudes.

---

## C - Async Context Manager

**Definición:**  
Un **context manager** es una estructura en Python que permite ejecutar código antes y después de un bloque de código, usando `with`. En el caso de operaciones asíncronas, se usa un **async context manager** con `async with`. FastAPI utiliza esta estructura para manejar los eventos de ciclo de vida.

**Ejemplo:**

```python
from contextlib import asynccontextmanager

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Código de inicio
    print("Starting up...")
    yield
    # Código de cierre
    print("Shutting down...")
```

**Descripción del ejemplo:**

1.  El código antes del `yield` se ejecuta al inicio.
2.  El código después del `yield` se ejecuta al cierre.

---

## D - Eventos `startup` y `shutdown` (deprecados)

**Definición:**  
Antes de la introducción de `lifespan`, FastAPI permitía definir eventos de inicio y cierre usando `@app.on_event("startup")` y `@app.on_event("shutdown")`. Aunque aún funciona, se recomienda usar `lifespan` en su lugar.

**Ejemplo de `startup`:**

```python
@app.on_event("startup")
async def startup_event():
    print("Application is starting up...")
```

**Descripción del ejemplo:**  
Este código se ejecuta justo antes de que la aplicación comience a recibir solicitudes.

**Ejemplo de `shutdown`:**

```python
@app.on_event("shutdown")
def shutdown_event():
    print("Application is shutting down...")
```

**Descripción del ejemplo:**  
Este código se ejecuta justo después de que la aplicación haya terminado de manejar solicitudes.

---

## E - Detalles técnicos

**Definición:**  
Los eventos de ciclo de vida en FastAPI están basados en el protocolo ASGI (Asynchronous Server Gateway Interface), específicamente en el [Lifespan Protocol](https://asgi.readthedocs.io/en/latest/specs/lifespan.html). Esto permite manejar el inicio y cierre de la aplicación de manera eficiente.

**Ejemplo técnico:**

```python
from fastapi import FastAPI

app = FastAPI()

@app.on_event("startup")
async def startup():
    print("Starting up...")

@app.on_event("shutdown")
async def shutdown():
    print("Shutting down...")
```

**Descripción del ejemplo:**

1.  El evento `startup` se ejecuta antes de que la aplicación comience a recibir solicitudes.
2.  El evento `shutdown` se ejecuta después de que la aplicación haya terminado de manejar solicitudes.

---

## F - Sub aplicaciones y eventos de ciclo de vida

**Definición:**  
Los eventos de ciclo de vida solo se ejecutan para la aplicación principal, no para las sub aplicaciones montadas (Sub Applications - Mounts). Si necesitas manejar eventos de ciclo de vida para sub aplicaciones, debes hacerlo manualmente.

**Ejemplo:**

```python
from fastapi import FastAPI

app = FastAPI()

sub_app = FastAPI()

@app.on_event("startup")
async def startup():
    print("Main app starting up...")

@sub_app.on_event("startup")
async def sub_app_startup():
    print("Sub app starting up...")  # Esto no se ejecutará automáticamente
```

**Descripción del ejemplo:**

1.  El evento `startup` de la aplicación principal se ejecuta correctamente.
2.  El evento `startup` de la sub aplicación no se ejecuta automáticamente.
