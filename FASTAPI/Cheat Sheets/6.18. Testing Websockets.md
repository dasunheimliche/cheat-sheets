## A - TestClient para WebSockets

**Definición:** La misma clase TestClient de FastAPI que se usa para pruebas HTTP, puede utilizarse para probar WebSockets. Permite establecer conexiones WebSocket y enviar/recibir mensajes de prueba.

**Ejemplo:** Se utiliza el mismo TestClient que se usa para testear rutas HTTP, ahora también con WebSockets.

(El TestClient es una herramienta muy versátil para probar diferentes partes de una app FastAPI.)

## B - websocket_connect

**Definición:** Método del TestClient para conectarse a una ruta WebSocket. Devuelve un objeto de contexto que permite interactuar con la conexión. Se suele utilizar con un bloque with para asegurar que la conexión se cierre correctamente.

**Ejemplo:**

```Python
from fastapi.testclient import TestClient
from fastapi import FastAPI, WebSocket

app = FastAPI()

@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    await websocket.send_text("Conectado")
    await websocket.close()


def test_websocket():
    client = TestClient(app)
    with client.websocket_connect("/ws") as websocket:
        #Se realiza el test dentro del contexto
        pass
```

(En este ejemplo, websocket es el objeto que permite interactuar con la conexión WebSocket.)

## C - Bloque with para WebSockets

**Definición:** El bloque with se utiliza para asegurar que la conexión WebSocket se cierre automáticamente al salir del bloque, evitando fugas de recursos. Es importante usarlo con websocket_connect.

**Ejemplo:**

```Python
def test_websocket():
    client = TestClient(app)
    with client.websocket_connect("/ws") as websocket:
        #codigo de prueba
        pass
    # La conexión se cierra automaticamente al salir de este bloque
```

(El código dentro del with puede recibir y enviar datos a través del websocket, y la conexión se cerrará al final.)

## D - Recibir Mensajes en Pruebas (.receive_text(), .receive_json(), etc)

**Definición:** Métodos que se utilizan en el websocket de TestClient para recibir mensajes. Al igual que en el endpoint estos son: .receive_text() para recibir texto, .receive_json() para recibir un diccionario JSON, etc.

**Ejemplo:**

```Python
def test_websocket():
    client = TestClient(app)
    with client.websocket_connect("/ws") as websocket:
        data = websocket.receive_text()
        print(f"Recibido: {data}")
        data_json = websocket.receive_json()
        print(f"Recibido JSON: {data_json}")
```

(En este caso, se reciben dos tipos de mensajes: texto y json y se muestran por consola, pero usualmente aquí se harían assertions para testear el correcto funcionamiento.)

## E - Enviar Mensajes en Pruebas (.send_text(), .send_json(), etc)

**Definición:** Métodos en el websocket de TestClient para enviar mensajes al servidor. Similar a las funciones de receive, estas son las contrapartes para enviar: .send_text(), .send_json(), etc.

**Ejemplo:**

```Python
def test_websocket():
  client = TestClient(app)
  with client.websocket_connect("/ws") as websocket:
    websocket.send_text("Hola Servidor!")
    websocket.send_json({"msg": "Hola Servidor!"})
    #El server deberia responder...
    data = websocket.receive_text()
    print(data)
```

(Aqui se envían mensajes al servidor a traves del objeto websocket, y luego se recibe la respuesta del mismo.)

## F - Cierre de la Conexión (.close())

**Definición:** Aunque websocket_connect cierra la conexión automáticamente al salir del with, también se puede cerrar la conexión explícitamente usando el método .close() del objeto websocket.

**Ejemplo:**

```Python
def test_websocket():
  client = TestClient(app)
  with client.websocket_connect("/ws") as websocket:
    # ...
    websocket.close() #Se cierra la conexión
```

(En la práctica esto no suele ser necesario dentro del with, ya que la conexión se cierra automáticamente, pero se puede usar manualmente en casos de ser necesario.)
