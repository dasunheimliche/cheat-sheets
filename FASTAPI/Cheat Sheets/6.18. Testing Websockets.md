## A - Pruebas de WebSockets con `TestClient`

**Definición:**  
FastAPI permite probar WebSockets utilizando el `TestClient`, que es una herramienta para realizar pruebas en aplicaciones FastAPI. Con `TestClient`, puedes simular conexiones WebSocket y verificar el comportamiento de tu aplicación.

**Ejemplo básico:**

```python
from fastapi import FastAPI
from fastapi.testclient import TestClient
from fastapi.websockets import WebSocket

app = FastAPI()

@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    await websocket.send_json({"msg": "Hello WebSocket"})
    await websocket.close()

def test_websocket():
    client = TestClient(app)
    with client.websocket_connect("/ws") as websocket:
        data = websocket.receive_json()
        assert data == {"msg": "Hello WebSocket"}
```

**Descripción del ejemplo:**

1.  Se define una ruta WebSocket en `/ws` que acepta conexiones, envía un mensaje JSON y cierra la conexión.
2.  En la prueba, se usa `TestClient` para conectarse al WebSocket.
3.  Se recibe el mensaje enviado por el servidor y se verifica que sea el esperado.

---

## B - Uso de `TestClient` en pruebas

**Definición:**  
`TestClient` es una clase que permite realizar pruebas HTTP y WebSocket en aplicaciones FastAPI. Para probar WebSockets, se usa el método `websocket_connect`, que simula una conexión WebSocket.

**Ejemplo:**

```python
def test_websocket():
    client = TestClient(app)
    with client.websocket_connect("/ws") as websocket:
        data = websocket.receive_json()
        assert data == {"msg": "Hello WebSocket"}
```

**Descripción del ejemplo:**

1.  Se crea una instancia de `TestClient` pasando la aplicación FastAPI.
2.  Se usa `websocket_connect` para conectarse a la ruta WebSocket `/ws`.
3.  Se recibe un mensaje JSON y se verifica su contenido.

---

## C - Flujo de una prueba WebSocket

**Definición:**  
Una prueba típica de WebSocket sigue estos pasos:

1.  Conectarse al WebSocket usando `websocket_connect`.
2.  Enviar o recibir mensajes usando métodos como `send_json` o `receive_json`.
3.  Verificar que los mensajes recibidos sean los esperados.

**Ejemplo completo:**

```python
from fastapi import FastAPI, WebSocket
from fastapi.testclient import TestClient

app = FastAPI()

@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    await websocket.send_json({"msg": "Hello WebSocket"})
    await websocket.close()

def test_websocket():
    client = TestClient(app)
    with client.websocket_connect("/ws") as websocket:
        # Recibir mensaje del servidor
        data = websocket.receive_json()
        assert data == {"msg": "Hello WebSocket"}

        # Enviar mensaje al servidor (si fuera necesario)
        websocket.send_json({"msg": "Hi there!"})
        response = websocket.receive_json()
        assert response == {"msg": "Message received"}
```

**Descripción del ejemplo:**

1.  El servidor WebSocket envía un mensaje JSON al cliente.
2.  El cliente recibe el mensaje y verifica su contenido.
3.  El cliente puede enviar un mensaje al servidor y recibir una respuesta.

---

## D - Notas importantes

**Definición:**

- Las pruebas de WebSockets deben realizarse dentro de un bloque `with` para asegurar que la conexión se cierre correctamente.
- Puedes usar métodos como `receive_text`, `receive_bytes`, `send_text`, y `send_bytes` para manejar diferentes tipos de datos.
- Para más detalles, consulta la documentación de Starlette sobre [pruebas de WebSockets](https://www.starlette.io/testclient/#testing-websocket-sessions).

**Ejemplo con `receive_text`:**

```python
def test_websocket_text():
    client = TestClient(app)
    with client.websocket_connect("/ws") as websocket:
        websocket.send_text("Hello")
        response = websocket.receive_text()
        assert response == "Message received: Hello"
```

**Descripción del ejemplo:**

1.  El cliente envía un mensaje de texto al servidor.
2.  El cliente recibe una respuesta de texto y verifica su contenido.
