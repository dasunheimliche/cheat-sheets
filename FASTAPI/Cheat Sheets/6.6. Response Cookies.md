## A - Cookies usando Response Parameter

**Definición:** Permite establecer cookies en una respuesta HTTP mientras se mantiene la capacidad de retornar objetos normales y usar response_model. Esto se logra mediante la inyección de un parámetro de tipo Response en la función.

**Ejemplo:**

```python

from fastapi import FastAPI, Response
from pydantic import BaseModel
from typing import Optional
from datetime import datetime, timedelta

class UserPreferences(BaseModel):
    theme: str
    language: str
    notifications_enabled: bool

app = FastAPI()

@app.post("/users/preferences/", response_model=UserPreferences)
async def set_user_preferences(
    preferences: UserPreferences,
    response: Response  # Inyección del parámetro Response
):
    # Establecer múltiples cookies con diferentes configuraciones
    response.set_cookie(
        key="user_theme",
        value=preferences.theme,
        expires=datetime.now() + timedelta(days=30),
        httponly=True,
        samesite='lax'
    )

    response.set_cookie(
        key="user_lang",
        value=preferences.language,
        max_age=3600,  # 1 hora en segundos
        secure=True
    )

    response.set_cookie(
        key="notifications",
        value=str(preferences.notifications_enabled).lower(),
        path="/api/notifications/"
    )

    # Retornamos el objeto normalmente
    # FastAPI automáticamente combinará esto con las cookies establecidas
    return preferences
```

(Este ejemplo muestra cómo establecer cookies mientras se mantiene el tipado y validación del modelo de respuesta. Las cookies se establecen con diferentes configuraciones de seguridad y expiración.)

## B - Cookies usando Response Directa

**Definición:** Permite crear y retornar una respuesta HTTP directamente con cookies establecidas, útil cuando necesitas control total sobre la respuesta o cuando no necesitas usar response_model.

**Ejemplo:**

```python

from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse, RedirectResponse
from typing import Optional
import json

app = FastAPI()

@app.post("/auth/login/")
async def login(
    request: Request,
    username: str,
    remember: Optional[bool] = False
):
    # Simular autenticación
    if username != "admin":
        response = JSONResponse(
            status_code=401,
            content={
                "error": "Invalid credentials",
                "message": "Username or password incorrect"
            }
        )
        # Limpiar cookies de sesión anteriores
        response.delete_cookie(key="session")
        response.delete_cookie(key="user_data")
        return response

    # Crear sesión exitosa
    session_data = {
        "user_id": "123",
        "username": username,
        "roles": ["admin"],
        "last_login": str(datetime.now())
    }

    # Crear respuesta con múltiples cookies
    response = JSONResponse(
        content={
            "message": "Login successful",
            "redirect_to": "/dashboard"
        }
    )

    # Configurar cookie de sesión segura
    response.set_cookie(
        key="session",
        value="encrypted_session_token",
        httponly=True,  # No accesible via JavaScript
        secure=True,    # Solo enviada sobre HTTPS
        samesite='strict',
        max_age=3600 if not remember else 30 * 24 * 3600  # 1 hora o 30 días
    )

    # Cookie con datos de usuario (no sensibles)
    response.set_cookie(
        key="user_data",
        value=json.dumps({
            "username": username,
            "theme": "light",
            "timezone": "UTC"
        }),
        max_age=30 * 24 * 3600  # 30 días
    )

    return response

@app.post("/auth/logout/")
async def logout():
    response = RedirectResponse(
        url="/login",
        status_code=302
    )

    # Limpiar todas las cookies relacionadas con la sesión
    cookies_to_delete = [
        "session",
        "user_data",
        "user_theme",
        "user_lang",
        "notifications"
    ]

    for cookie_name in cookies_to_delete:
        response.delete_cookie(
            key=cookie_name,
            path="/",  # Importante: mismo path usado al crear la cookie
            secure=True,
            httponly=True
        )

    return response
```

(Este ejemplo muestra cómo manejar cookies directamente con diferentes tipos de respuestas, incluyendo autenticación, manejo de sesiones y limpieza de cookies.)

## C - Cookies en Dependencias

**Definición:** Permite establecer cookies desde funciones de dependencia, útil para operaciones comunes como tracking, análisis o manejo de sesiones que deben aplicarse a múltiples endpoints.

**Ejemplo:**

```python

from fastapi import FastAPI, Depends, Response, Request
from typing import Optional
from datetime import datetime

app = FastAPI()

async def track_visitor(
    request: Request,
    response: Response,
    user_agent: Optional[str] = None
):
    """Dependency para tracking de visitantes"""
    visitor_data = {
        "last_visit": str(datetime.now()),
        "user_agent": user_agent or request.headers.get("user-agent", "unknown"),
        "ip": request.client.host
    }

    # Actualizar cookie de analytics
    response.set_cookie(
        key="visitor_stats",
        value=json.dumps(visitor_data),
        max_age=365 * 24 * 3600,  # 1 año
        httponly=True
    )

    return visitor_data

async def session_manager(
    request: Request,
    response: Response
):
    """Dependency para manejo de sesiones"""
    session_token = request.cookies.get("session")

    if not session_token:
        # Crear nueva sesión para visitantes
        response.set_cookie(
            key="session",
            value=f"sess_{datetime.now().timestamp()}",
            httponly=True,
            secure=True,
            samesite='lax'
        )
    else:
        # Renovar expiración de sesión existente
        response.set_cookie(
            key="session",
            value=session_token,
            httponly=True,
            secure=True,
            samesite='lax'
        )

    return session_token

@app.get("/products/{product_id}")
async def get_product(
    product_id: str,
    visitor: dict = Depends(track_visitor),
    session: str = Depends(session_manager)
):
    return {
        "product_id": product_id,
        "visitor_info": visitor,
        "session": session
    }
```

(Este ejemplo demuestra cómo usar dependencies para establecer cookies de tracking y sesión que se aplican automáticamente en múltiples endpoints.)

## D - Buenas Prácticas y Seguridad con Cookies

**Definición:** Conjunto de prácticas recomendadas para el manejo seguro de cookies en FastAPI, incluyendo configuraciones de seguridad y patrones comunes.

**Ejemplo:**

```python

from fastapi import FastAPI, Response, Request, HTTPException
from fastapi.security import HTTPBearer
from datetime import datetime, timedelta
import jwt
from typing import Optional

app = FastAPI()
security = HTTPBearer()

# Configuraciones de seguridad para cookies
COOKIE_SETTINGS = {
    "secure": True,      # Solo HTTPS
    "httponly": True,    # No accesible via JavaScript
    "samesite": 'strict' # Protección CSRF
}

def create_secure_cookie(
    response: Response,
    key: str,
    value: str,
    expires_delta: Optional[timedelta] = None,
    **additional_settings
):
    """Helper function para crear cookies seguras"""
    settings = {**COOKIE_SETTINGS, **additional_settings}

    if expires_delta:
        settings["expires"] = datetime.now() + expires_delta

    response.set_cookie(
        key=key,
        value=value,
        **settings
    )

@app.post("/auth/login")
async def secure_login(response: Response):
    # Generar token JWT
    token = jwt.encode(
        {
            "user_id": "123",
            "exp": datetime.now() + timedelta(hours=1)
        },
        "secret_key",
        algorithm="HS256"
    )

    # Establecer múltiples cookies seguras
    create_secure_cookie(
        response,
        "access_token",
        token,
        expires_delta=timedelta(hours=1)
    )

    create_secure_cookie(
        response,
        "refresh_token",
        "secure_refresh_token",
        expires_delta=timedelta(days=30),
        path="/auth/refresh"  # Limitar alcance de la cookie
    )

    return {"message": "Login successful"}

@app.get("/auth/check")
async def check_auth(request: Request):
    """Ejemplo de validación de cookies"""
    token = request.cookies.get("access_token")

    if not token:
        raise HTTPException(
            status_code=401,
            detail="No authentication token found"
        )

    try:
        payload = jwt.decode(
            token,
            "secret_key",
            algorithms=["HS256"]
        )
        return {"authenticated": True, "user_id": payload["user_id"]}
    except jwt.ExpiredSignatureError:
        raise HTTPException(
            status_code=401,
            detail="Token has expired"
        )
    except jwt.InvalidTokenError:
        raise HTTPException(
            status_code=401,
            detail="Invalid token"
        )

@app.post("/auth/refresh")
async def refresh_token(request: Request, response: Response):
    """Ejemplo de renovación de token usando refresh cookie"""
    refresh_token = request.cookies.get("refresh_token")

    if not refresh_token:
        raise HTTPException(
            status_code=401,
            detail="No refresh token found"
        )

    # Validar refresh token y generar nuevo access token
    new_token = jwt.encode(
        {
            "user_id": "123",
            "exp": datetime.now() + timedelta(hours=1)
        },
        "secret_key",
        algorithm="HS256"
    )

    create_secure_cookie(
        response,
        "access_token",
        new_token,
        expires_delta=timedelta(hours=1)
    )

    return {"message": "Token refreshed successfully"}
```

(Este ejemplo muestra las mejores prácticas para el manejo seguro de cookies, incluyendo configuraciones de seguridad, manejo de JWT, y patrones comunes de autenticación y renovación de tokens.)
