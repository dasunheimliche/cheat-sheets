## A - `response_class` en el decorador de la operación de ruta

**Definición:**

El parámetro `response_class` dentro de los decoradores de operaciones de ruta (`@app.get()`, `@app.post()`, etc.) te permite especificar la clase de respuesta que se utilizará para esa ruta en particular. Esto afecta cómo se serializan los datos, qué tipo de encabezado `Content-Type` se envía y cómo se documenta la respuesta en OpenAPI. Si se usa una clase de respuesta con un tipo de medio JSON (`application/json`), como `JSONResponse` u `ORJSONResponse`, FastAPI realizará la conversión automática de datos (usando `jsonable_encoder`) y la validación con los modelos Pydantic definidos en `response_model`.

**Ejemplo:**

```Python

    from fastapi import FastAPI
    from fastapi.responses import ORJSONResponse
    from pydantic import BaseModel
    from typing import List

    app = FastAPI()

    class Item(BaseModel):
        name: str
        price: float

    @app.get("/items/", response_class=ORJSONResponse, response_model=List[Item])
    async def read_items():
        items = [{"name": "Foo", "price": 50.2}, {"name": "Bar", "price": 20.1}]
        return items
```

(En este ejemplo, `response_class=ORJSONResponse` indica que se usará `ORJSONResponse`. `response_model=List[Item]` define que la respuesta debe ser una lista de objetos `Item`. FastAPI convertirá la lista de diccionarios a una lista de objetos `Item` y luego a JSON usando `orjson`. El encabezado `Content-Type` será `application/json` y la documentación OpenAPI reflejará esto.)

## B - Retornar un `Response` directamente

**Definición:**

En lugar de dejar que FastAPI maneje la creación de la respuesta, puedes retornar directamente una instancia de la clase `Response` (o una de sus subclases). Esto te da un control completo sobre la respuesta, incluyendo el contenido, el código de estado, los encabezados y las cookies. Sin embargo, al retornar un `Response` directamente, FastAPI _no_ realiza la conversión automática de datos ni genera la documentación OpenAPI automáticamente (a menos que se combine con `response_class`, como se explica en la siguiente sección).

**Ejemplo:**

```Python

    from fastapi import FastAPI, Response
    from fastapi.responses import HTMLResponse

    app = FastAPI()

    @app.get("/items/")
    async def read_items():
        html_content = """
        <html><body><h1>Items</h1></body></html>
        """
        return HTMLResponse(content=html_content, status_code=200)
```

(En este ejemplo, se crea y se retorna directamente un `HTMLResponse`. FastAPI no realiza ninguna conversión de datos. El encabezado `Content-Type` se establece automáticamente a `text/html` debido a que se usa `HTMLResponse`.)

## C - Combinar `response_class` y retornar un `Response`

**Definición:**

Puedes combinar el uso de `response_class` en el decorador con el retorno directo de un objeto `Response`. En este caso, `response_class` se utiliza _únicamente_ para la documentación en OpenAPI (principalmente para especificar el `media_type`), mientras que el objeto `Response` que se retorna en la función de la operación de ruta es el que se envía al cliente. Esto es útil cuando necesitas un control preciso sobre la respuesta (por ejemplo, para establecer un código de estado específico o encabezados adicionales) pero también quieres que la documentación OpenAPI sea correcta.

**Ejemplo:**

```Python

    from fastapi import FastAPI
    from fastapi.responses import HTMLResponse

    app = FastAPI()

    def generate_html_response():
        html_content = """
        <html><body><h1>Items</h1></body></html>
        """
        return HTMLResponse(content=html_content, status_code=201)

    @app.get("/items/", response_class=HTMLResponse)
    async def read_items():
        return generate_html_response()
```

(Aquí, `response_class=HTMLResponse` le dice a OpenAPI que la respuesta es HTML. Sin embargo, la función `generate_html_response()` retorna un `HTMLResponse` con un código de estado 201. Este código de estado _sobrescribe_ el valor predeterminado (200). La documentación mostrará que la respuesta es HTML, pero el cliente recibirá un código 201.)

## D - Clases de `Response` disponibles

**Definición:**

FastAPI proporciona varias clases de `Response` predefinidas para facilitar la creación de respuestas con diferentes tipos de contenido.

**Ejemplos:**

- `Response`: La clase base. Recibe `content` (bytes o string), `status_code`, `headers` (diccionario) y `media_type`.
- `HTMLResponse`: Para respuestas HTML (`media_type="text/html"`).
- `PlainTextResponse`: Para texto plano (`media_type="text/plain"`).
- `JSONResponse`: Para JSON (`media_type="application/json"`).
- `ORJSONResponse`: Una alternativa de alto rendimiento a `JSONResponse` que usa `orjson`. Requiere la instalación de `orjson` (`pip install orjson`).
- `UJSONResponse`: Otra alternativa a `JSONResponse` que usa `ujson`. Requiere la instalación de `ujson` (`pip install ujson`). _Advertencia_: `ujson` es menos estricto que la implementación de JSON de Python en el manejo de algunos casos límite. `ORJSONResponse` podría ser una mejor opción.
- `RedirectResponse`: Para redirecciones HTTP.
- `StreamingResponse`: Para transmitir datos en flujo (ej: archivos grandes, audio, video). Recibe un iterador o generador.
- `FileResponse`: Para enviar archivos estáticos. Recibe la ruta del archivo.

## E - Uso de `StreamingResponse` con objetos tipo archivo

**Definición:**

`StreamingResponse` es especialmente útil para trabajar con archivos grandes sin cargarlos completamente en la memoria. Se puede usar con objetos tipo archivo (como los que devuelve `open()`) creando una función generadora que itere sobre el archivo.

**Ejemplo:**

```Python

    from fastapi import FastAPI
    from fastapi.responses import StreamingResponse

    app = FastAPI()
    some_file_path = "large-video-file.mp4"

    @app.get("/", response_class=StreamingResponse) #Se declara StreamingResponse
    async def main():
        def iterfile():
            with open(some_file_path, mode="rb") as file_like:
                yield from file_like

        return iterfile() #Se retorna el generador directamente
```

(La función `iterfile()` es un generador que lee el archivo en bloques y los devuelve con `yield from`. El bloque `with` asegura que el archivo se cierre correctamente después de la transmisión. Como se usa `open()` estándar (no asíncrono), la operación de ruta se declara con `def` en lugar de `async def`.)

## F - `FileResponse`

**Definición:**

`FileResponse` proporciona una forma eficiente de enviar archivos estáticos. Maneja automáticamente los encabezados `Content-Length`, `Last-Modified` y `ETag`.

**Ejemplo:**

```Python

    from fastapi import FastAPI
    from fastapi.responses import FileResponse

    app = FastAPI()
    some_file_path = "large-video-file.mp4"

    @app.get("/", response_class=FileResponse)
    async def main():
        return some_file_path #Se retorna directamente la ruta
```

(En este ejemplo, se retorna directamente la ruta del archivo. `FileResponse` se encarga de abrir, leer y enviar el archivo al cliente. También se puede usar `return FileResponse(some_file_path)` dentro de la función.)

## G - `default_response_class`

**Definición:**

El parámetro `default_response_class` al crear una instancia de `FastAPI` te permite definir la clase de respuesta que se utilizará por defecto en _todas_ las operaciones de ruta de esa instancia de FastAPI.

**Ejemplo:**

```Python

    from fastapi import FastAPI
    from fastapi.responses import ORJSONResponse

    app = FastAPI(default_response_class=ORJSONResponse)

    @app.get("/items/")
    async def read_items():
        return [{"item_id": "Foo"}]

    @app.post("/items/")
    async def create_item(item: dict):
        return item
```

(En este ejemplo, tanto `/items/` (GET) como `/items/` (POST) usarán `ORJSONResponse` por defecto. Se puede seguir usando `response_class` en operaciones individuales para sobrescribir este comportamiento global.)
