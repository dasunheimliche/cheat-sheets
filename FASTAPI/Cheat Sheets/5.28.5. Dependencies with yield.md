## A - Dependencias con `yield`

**Definición:**  
FastAPI permite crear dependencias que realizan acciones adicionales después de que la operación de ruta ha terminado. Para esto, se usa `yield` en lugar de `return`. El código antes del `yield` se ejecuta antes de la operación de ruta, y el código después del `yield` se ejecuta después de que la operación de ruta ha terminado.

**Ejemplo:**

```python
from fastapi import Depends, FastAPI

app = FastAPI()

async def get_db():
    db = DBSession()  # Crea una sesión de base de datos
    try:
        yield db  # Pasa la sesión a la operación de ruta
    finally:
        db.close()  # Cierra la sesión después de que la operación de ruta termina

@app.get("/items/")
async def read_items(db: Session = Depends(get_db)):
    return db.query(Item).all()
```

**Descripción del ejemplo:**

- `get_db` es una dependencia que crea una sesión de base de datos.
- El código antes del `yield` se ejecuta antes de la operación de ruta.
- El código después del `yield` se ejecuta después de que la operación de ruta ha terminado, asegurando que la sesión se cierre correctamente.

---

## B - Dependencias con `yield` y `try`

**Definición:**  
Puedes usar un bloque `try` en una dependencia con `yield` para manejar excepciones que ocurran durante la ejecución de la operación de ruta. Esto es útil para asegurar que los recursos se liberen correctamente, incluso si ocurre un error.

**Ejemplo:**

```python
async def get_db():
    db = DBSession()
    try:
        yield db
    except Exception as e:
        print(f"Error: {e}")
        raise
    finally:
        db.close()
```

**Descripción del ejemplo:**

- Si ocurre una excepción durante la operación de ruta, se captura en el bloque `except`.
- El bloque `finally` asegura que la sesión de la base de datos se cierre, independientemente de si ocurrió un error o no.

---

## C - Sub-dependencias con `yield`

**Definición:**  
Puedes tener dependencias que dependen de otras dependencias, y todas pueden usar `yield`. FastAPI se asegura de que el código de salida (después del `yield`) se ejecute en el orden correcto.

**Ejemplo:**

```python
async def dependency_a():
    dep_a = generate_dep_a()
    try:
        yield dep_a
    finally:
        dep_a.close()

async def dependency_b(dep_a=Depends(dependency_a)):
    dep_b = generate_dep_b()
    try:
        yield dep_b
    finally:
        dep_b.close(dep_a)

async def dependency_c(dep_b=Depends(dependency_b)):
    dep_c = generate_dep_c()
    try:
        yield dep_c
    finally:
        dep_c.close(dep_b)
```

**Descripción del ejemplo:**

- `dependency_b` depende de `dependency_a`, y `dependency_c` depende de `dependency_b`.
- FastAPI se asegura de que el código de salida se ejecute en el orden correcto: primero `dependency_c`, luego `dependency_b`, y finalmente `dependency_a`.

---

## D - Dependencias con `yield` y `HTTPException`

**Definición:**  
Puedes lanzar excepciones como `HTTPException` en el código de salida (después del `yield`) de una dependencia. Esto es útil para manejar errores que ocurren después de que la operación de ruta ha terminado.

**Ejemplo:**

```python
from fastapi import Depends, FastAPI, HTTPException

app = FastAPI()

async def get_username():
    try:
        yield "Rick"
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Error: {e}")

@app.get("/items/{item_id}")
async def get_item(item_id: str, username: str = Depends(get_username)):
    if item_id != "plumbus":
        raise HTTPException(status_code=404, detail="Item not found")
    return {"item_id": item_id, "username": username}
```

**Descripción del ejemplo:**

- Si ocurre un error después del `yield`, se lanza una `HTTPException`.
- Esto permite manejar errores que ocurren después de que la operación de ruta ha terminado.

---

## E - Dependencias con `yield` y `except`

**Definición:**  
Si capturas una excepción en una dependencia con `yield` y no la vuelves a lanzar, FastAPI no podrá notar que ocurrió un error. Por lo tanto, es importante volver a lanzar la excepción después de capturarla.

**Ejemplo:**

```python
async def get_username():
    try:
        yield "Rick"
    except Exception as e:
        print(f"Error: {e}")
        raise  # Vuelve a lanzar la excepción

@app.get("/items/{item_id}")
async def get_item(item_id: str, username: str = Depends(get_username)):
    if item_id != "plumbus":
        raise HTTPException(status_code=404, detail="Item not found")
    return {"item_id": item_id, "username": username}
```

**Descripción del ejemplo:**

- Si no vuelves a lanzar la excepción, FastAPI no podrá manejarla correctamente.
- Esto asegura que los errores se registren y manejen adecuadamente.

---

## F - Context Managers (Manejadores de contexto)

**Definición:**  
Un "Context Manager" es un objeto en Python que se puede usar en un bloque `with`. FastAPI usa internamente context managers para manejar dependencias con `yield`.

**Ejemplo:**

```python
class MySuperContextManager:
    def __init__(self):
        self.db = DBSession()

    def __enter__(self):
        return self.db

    def __exit__(self, exc_type, exc_value, traceback):
        self.db.close()

async def get_db():
    with MySuperContextManager() as db:
        yield db
```

**Descripción del ejemplo:**

- `MySuperContextManager` es un context manager que maneja una sesión de base de datos.
- FastAPI usa context managers internamente para manejar dependencias con `yield`.
