## A - Anulación de dependencias en pruebas

**Definición:**  
En FastAPI, puedes anular (reemplazar) dependencias durante las pruebas para evitar ejecutar el código original. Esto es útil cuando la dependencia original realiza operaciones costosas (como llamadas a servicios externos) y prefieres usar un valor simulado (`mock`) para tus pruebas.

Ejemplo:

```python
from fastapi import FastAPI, Depends
from fastapi.testclient import TestClient

app = FastAPI()

async def common_parameters(q: str | None = None, skip: int = 0, limit: int = 100):
    return {"q": q, "skip": skip, "limit": limit}

@app.get("/items/")
async def read_items(commons: dict = Depends(common_parameters)):
    return {"message": "Hello Items!", "params": commons}

client = TestClient(app)

async def override_dependency(q: str | None = None):
    return {"q": q, "skip": 5, "limit": 10}

app.dependency_overrides[common_parameters] = override_dependency

def test_override_in_items():
    response = client.get("/items/")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": None, "skip": 5, "limit": 10},
    }
```

(Descripción del ejemplo):

- `common_parameters` es la dependencia original que se usa en la ruta `/items/`.
- `override_dependency` es una dependencia simulada que reemplaza a `common_parameters` durante las pruebas.
- `app.dependency_overrides` es un diccionario que permite anular dependencias.
- La prueba verifica que la ruta `/items/` use la dependencia anulada y devuelva los valores simulados.

---

## B - `app.dependency_overrides`

**Definición:**  
`app.dependency_overrides` es un diccionario en FastAPI que te permite reemplazar dependencias durante las pruebas. La clave es la dependencia original, y el valor es la dependencia que la reemplazará.

Ejemplo:

```python
app.dependency_overrides[common_parameters] = override_dependency
```

(Descripción del ejemplo):

- Aquí, `common_parameters` es la dependencia original, y `override_dependency` es la dependencia que se usará en su lugar durante las pruebas.

---

## C - Casos de uso: Servicios externos

**Definición:**  
Un caso común para anular dependencias es cuando tu aplicación depende de servicios externos (como un proveedor de autenticación). En lugar de llamar al servicio real durante las pruebas (lo que puede ser lento o costoso), puedes usar una dependencia simulada que devuelva datos predefinidos.

Ejemplo:

```python
async def override_auth_provider():
    return {"user": "mock_user"}

app.dependency_overrides[auth_provider] = override_auth_provider
```

(Descripción del ejemplo):

- `auth_provider` es una dependencia que llama a un servicio externo.
- `override_auth_provider` es una dependencia simulada que devuelve un usuario falso para pruebas.

---

## D - Restablecer anulaciones de dependencias

**Definición:**  
Después de realizar pruebas con dependencias anuladas, es importante restablecer las dependencias originales para evitar efectos secundarios en otras pruebas. Esto se hace asignando un diccionario vacío a `app.dependency_overrides`.

Ejemplo:

```python
app.dependency_overrides = {}
```

(Descripción del ejemplo):

- Esto elimina todas las anulaciones de dependencias, restableciendo el comportamiento original de la aplicación.

---

## E - Anulación temporal en pruebas específicas

**Definición:**  
Puedes anular una dependencia solo para una prueba específica y restablecerla al final de la prueba. Esto es útil cuando no quieres que la anulación afecte a otras pruebas.

Ejemplo:

```python
def test_override_temporarily():
    app.dependency_overrides[common_parameters] = override_dependency
    response = client.get("/items/")
    assert response.status_code == 200
    assert response.json() == {
        "message": "Hello Items!",
        "params": {"q": None, "skip": 5, "limit": 10},
    }
    app.dependency_overrides = {}  # Restablecer al final de la prueba
```

(Descripción del ejemplo):

- La anulación se aplica solo durante esta prueba y se restablece al final para evitar afectar otras pruebas.

---

### Resumen del Cheat Sheet

1.  **Anulación de dependencias:** Reemplazar dependencias originales con versiones simuladas para pruebas.
2.  **`app.dependency_overrides`:** Diccionario para definir anulaciones de dependencias.
3.  **Casos de uso:** Evitar llamadas a servicios externos costosos o lentos.
4.  **Restablecer anulaciones:** Usar `app.dependency_overrides = {}` para eliminar anulaciones.
5.  **Anulación temporal:** Anular dependencias solo para pruebas específicas y restablecerlas después.
