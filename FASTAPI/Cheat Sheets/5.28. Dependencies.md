## A - Inyección de dependencias en FastAPI

**Definición:**  
La inyección de dependencias es un patrón de diseño en el que un sistema (en este caso, FastAPI) se encarga de proporcionar las dependencias que una función necesita para ejecutarse. Esto permite reutilizar lógica, compartir conexiones a bases de datos, implementar seguridad, y más, minimizando la repetición de código.

**Casos de uso comunes:**

- Lógica compartida (por ejemplo, validaciones repetidas).
- Conexiones a bases de datos.
- Autenticación y autorización.
- Requisitos de roles.

---

## B - Primeros pasos con dependencias

**Definición:**  
Una dependencia es simplemente una función que puede recibir los mismos parámetros que una función de operación de ruta (`path operation function`). FastAPI se encarga de llamar a esta función y pasar su resultado a la función que la requiere.

Ejemplo:

```python
from fastapi import FastAPI, Depends

app = FastAPI()

async def common_parameters(q: str | None = None, skip: int = 0, limit: int = 100):
    return {"q": q, "skip": skip, "limit": limit}

@app.get("/items/")
async def read_items(commons: dict = Depends(common_parameters)):
    return commons

@app.get("/users/")
async def read_users(commons: dict = Depends(common_parameters)):
    return commons
```

**Descripción:**

- `common_parameters` es una dependencia que recibe parámetros de consulta (`q`, `skip`, `limit`) y devuelve un diccionario.
- `Depends(common_parameters)` indica que `read_items` y `read_users` dependen de `common_parameters`.
- FastAPI llama a `common_parameters` automáticamente y pasa su resultado a las funciones de ruta.

---

## C - Uso de `Annotated` para dependencias

**Definición:**  
`Annotated` permite definir un alias para una dependencia, lo que reduce la repetición de código cuando la misma dependencia se usa en múltiples lugares.

Ejemplo:

```python
from typing import Annotated
from fastapi import FastAPI, Depends

app = FastAPI()

async def common_parameters(q: str | None = None, skip: int = 0, limit: int = 100):
    return {"q": q, "skip": skip, "limit": limit}

CommonsDep = Annotated[dict, Depends(common_parameters)]

@app.get("/items/")
async def read_items(commons: CommonsDep):
    return commons

@app.get("/users/")
async def read_users(commons: CommonsDep):
    return commons
```

**Descripción:**

- `CommonsDep` es un alias para `Annotated[dict, Depends(common_parameters)]`.
- Esto permite reutilizar la dependencia sin repetir la declaración completa.

---

## D - Dependencias asíncronas y síncronas

**Definición:**  
Las dependencias pueden ser funciones asíncronas (`async def`) o síncronas (`def`). FastAPI maneja ambos casos automáticamente.

Ejemplo:

```python
from fastapi import FastAPI, Depends

app = FastAPI()

# Dependencia síncrona
def sync_dependency():
    return "I'm synchronous!"

# Dependencia asíncrona
async def async_dependency():
    return "I'm asynchronous!"

@app.get("/sync/")
async def read_sync(result: str = Depends(sync_dependency)):
    return {"result": result}

@app.get("/async/")
async def read_async(result: str = Depends(async_dependency)):
    return {"result": result}
```

**Descripción:**

- `sync_dependency` es una función síncrona.
- `async_dependency` es una función asíncrona.
- FastAPI maneja ambas sin problemas.

---

## E - Integración con OpenAPI

**Definición:**  
Las dependencias y sus requisitos se integran automáticamente en el esquema OpenAPI. Esto significa que la documentación interactiva de FastAPI mostrará información sobre las dependencias.

**Ejemplo en la documentación interactiva:**

- Parámetros de consulta, validaciones y requisitos de las dependencias se muestran en la interfaz de Swagger UI o ReDoc.

---

## F - Uso avanzado de dependencias

**Definición:**  
Las dependencias pueden tener sus propias dependencias, creando un árbol jerárquico. FastAPI resuelve automáticamente todas las dependencias y subdependencias.

Ejemplo:

```python
from fastapi import FastAPI, Depends, HTTPException

app = FastAPI()

def get_db():
    # Simula una conexión a la base de datos
    return "Database connection"

def get_user(db: str = Depends(get_db)):
    if db:
        return {"user": "John Doe", "db": db}
    raise HTTPException(status_code=400, detail="DB connection failed")

@app.get("/user/")
async def read_user(user: dict = Depends(get_user)):
    return user
```

**Descripción:**

- `get_db` es una dependencia que simula una conexión a la base de datos.
- `get_user` depende de `get_db` y devuelve información del usuario.
- `read_user` depende de `get_user`.
- FastAPI resuelve automáticamente `get_db` y `get_user` antes de llamar a `read_user`.

---

## G - Compatibilidad de FastAPI con dependencias

**Definición:**  
El sistema de inyección de dependencias de FastAPI es compatible con:

- Bases de datos relacionales y NoSQL.
- Paquetes externos.
- APIs externas.
- Sistemas de autenticación y autorización.
- Monitoreo de uso de APIs.
- Inyección de datos en respuestas.

---

## H - Resumen de dependencias

**Definición:**  
Las dependencias en FastAPI son una forma poderosa y sencilla de:

- Reutilizar lógica.
- Compartir recursos (como conexiones a bases de datos).
- Implementar seguridad y validaciones.
- Crear sistemas modulares y escalables.

**Ejemplo completo:**

```python
from fastapi import FastAPI, Depends, HTTPException

app = FastAPI()

# Dependencia para verificar autenticación
async def verify_token(token: str):
    if token != "secret-token":
        raise HTTPException(status_code=403, detail="Token inválido")
    return "Usuario autenticado"

# Dependencia para obtener datos del usuario
async def get_user_data(auth: str = Depends(verify_token)):
    return {"user": "John Doe", "auth": auth}

@app.get("/user-data/")
async def read_user_data(user_data: dict = Depends(get_user_data)):
    return user_data
```

**Descripción:**

- `verify_token` verifica un token de autenticación.
- `get_user_data` depende de `verify_token` y devuelve datos del usuario.
- `read_user_data` depende de `get_user_data`.
- FastAPI maneja la resolución de dependencias automáticamente.
