## A - Middleware

**Definición:**  
Un middleware es una función que se ejecuta con cada **solicitud (request)** antes de que sea procesada por una operación de ruta (_path operation_). También trabaja con cada **respuesta (response)** antes de devolverla al cliente. Es como un intermediario que puede modificar o realizar acciones sobre las solicitudes y respuestas.

- Recibe la solicitud, puede modificarla o ejecutar código antes de pasarla a la operación de ruta.
- Luego recibe la respuesta generada, puede modificarla o ejecutar código antes de devolverla.

**Ejemplo:**

```python
import time
from fastapi import FastAPI, Request

app = FastAPI()

@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start_time = time.perf_counter()  # Tiempo inicial
    response = await call_next(request)  # Pasa la solicitud a la operación de ruta
    process_time = time.perf_counter() - start_time  # Calcula el tiempo de procesamiento
    response.headers["X-Process-Time"] = str(process_time)  # Agrega un encabezado personalizado
    return response
```

**Descripción del ejemplo:**  
Este middleware mide el tiempo que tarda en procesarse una solicitud y agrega un encabezado personalizado (`X-Process-Time`) a la respuesta con ese valor. El encabezado puede ser útil para depurar o monitorear el rendimiento.

---

## B - Crear un middleware

**Definición:**  
Para crear un middleware en FastAPI, se usa el decorador `@app.middleware("http")` sobre una función. Esta función recibe:

1.  El objeto `request` (la solicitud).
2.  Una función `call_next` que pasa la solicitud a la operación de ruta correspondiente y devuelve la respuesta.

**Ejemplo:**

```python
from fastapi import FastAPI, Request

app = FastAPI()

@app.middleware("http")
async def custom_middleware(request: Request, call_next):
    # Código antes de procesar la solicitud
    print("Antes de procesar la solicitud")

    response = await call_next(request)  # Pasa la solicitud a la operación de ruta

    # Código antes de devolver la respuesta
    print("Después de procesar la solicitud")

    return response
```

**Descripción del ejemplo:**  
Este middleware imprime un mensaje antes y después de procesar la solicitud. Es útil para depurar o realizar acciones antes y después de que la solicitud sea manejada por la aplicación.

---

## C - Antes y después de la respuesta

**Definición:**  
Puedes agregar código que se ejecute **antes** de que la solicitud llegue a la operación de ruta y **después** de que se genere la respuesta, pero antes de devolverla. Esto permite modificar la solicitud o la respuesta según sea necesario.

**Ejemplo:**

```python
import time
from fastapi import FastAPI, Request

app = FastAPI()

@app.middleware("http")
async def add_custom_header(request: Request, call_next):
    # Antes de procesar la solicitud
    request.state.custom_data = "Dato personalizado"

    response = await call_next(request)  # Pasa la solicitud a la operación de ruta

    # Después de procesar la solicitud
    response.headers["X-Custom-Data"] = request.state.custom_data

    return response
```

**Descripción del ejemplo:**  
Este middleware agrega un dato personalizado a la solicitud (`request.state.custom_data`) y luego lo incluye en un encabezado de la respuesta (`X-Custom-Data`). Esto demuestra cómo puedes compartir información entre el middleware y la operación de ruta.

---

## D - Headers personalizados

**Definición:**  
Puedes agregar encabezados personalizados a las respuestas usando el prefijo `X-`. Estos encabezados son útiles para incluir información adicional, como tiempos de procesamiento o datos personalizados.

**Ejemplo:**

```python
from fastapi import FastAPI, Request

app = FastAPI()

@app.middleware("http")
async def add_custom_header(request: Request, call_next):
    response = await call_next(request)
    response.headers["X-Custom-Header"] = "Valor personalizado"
    return response
```

**Descripción del ejemplo:**  
Este middleware agrega un encabezado personalizado (`X-Custom-Header`) a la respuesta. Los encabezados personalizados son útiles para enviar metadatos al cliente.

---

## E - Consideraciones técnicas

**Definición:**

- Si usas dependencias con `yield`, el código de salida se ejecutará **después** del middleware.
- Las tareas en segundo plano (background tasks) se ejecutarán **después** de todo el middleware.
- Puedes importar `Request` directamente desde `starlette.requests`, pero FastAPI lo proporciona por conveniencia.

**Ejemplo:**

```python
from fastapi import FastAPI, Request
from starlette.requests import Request as StarletteRequest

app = FastAPI()

@app.middleware("http")
async def middleware_example(request: StarletteRequest, call_next):
    response = await call_next(request)
    return response
```

**Descripción del ejemplo:**  
Este ejemplo muestra cómo importar `Request` desde Starlette. Aunque FastAPI lo proporciona, es útil saber que proviene de Starlette.

---

## F - Otros middlewares

**Definición:**  
FastAPI permite usar middlewares avanzados, como el manejo de **CORS (Cross-Origin Resource Sharing)**, que se cubre en la guía avanzada. Estos middlewares son útiles para configurar políticas de seguridad y acceso entre diferentes dominios.

**Ejemplo:**

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Permite todos los orígenes
    allow_methods=["*"],  # Permite todos los métodos HTTP
    allow_headers=["*"],  # Permite todos los encabezados
)
```

**Descripción del ejemplo:**  
Este middleware configura CORS para permitir solicitudes desde cualquier origen (`*`). Es útil cuando tu API necesita ser accesible desde diferentes dominios.
