## A - Prefetching: El Secreto para una Navegación Instantánea 🔴

#### 1. **Introducción:**

Imagina que tu sitio web es un restaurante y tus páginas son los platos; el _prefetching_ es como tener un camarero tan atento que empieza a preparar el siguiente plato que probablemente pedirás _antes_ de que lo pidas, para que cuando lo hagas, ¡llegue al instante!

#### 2. **Ejemplo:**

Para encender esta "magia" en todo tu sitio, solo necesitas añadir una línea en tu archivo de configuración.

**`astro.config.mjs`**

```javascript
import { defineConfig } from "astro/config";

export default defineConfig({
  // Con esta simple línea, activas la maquinaria del prefetching.
  prefetch: true,
});
```

**Explicación del ejemplo:**
Este código le dice a Astro: "Oye, quiero usar la función de prefetching en mi proyecto". Es el interruptor general. Sin embargo, ¡ojo!, esto por sí solo no hace nada visible. Es como encender la cocina; ahora necesitas decirle qué platos (o enlaces) empezar a preparar.

#### 3. **Desarrollo:**

El _prefetching_ (o precarga) es una técnica que mejora drásticamente la velocidad de tu sitio web. Cuando un usuario interactúa con un enlace preparado para prefetching (por ejemplo, al pasar el mouse sobre él), Astro descarga esa página en segundo plano. Así, cuando el usuario finalmente hace clic, la página ya está en el navegador, lista para mostrarse de inmediato. Esto transforma una aplicación de múltiples páginas (MPA) en algo que se siente tan rápido y fluido como una aplicación de una sola página (SPA).

🔴 **Fundamental**: Este es el punto de partida. Sin activar `prefetch: true`, ninguna de las otras opciones de prefetching que veremos a continuación funcionará. Es el paso 0, el más crucial de todos.

---

## B - `data-astro-prefetch`: Marcando los Enlaces a Precargar 🔴

#### 1. **Introducción:**

Una vez que has encendido la maquinaria del prefetching (ver concepto **A**), necesitas darle una "señal" a los enlaces específicos que quieres que se beneficien de esta velocidad instantánea.

#### 2. **Ejemplo:**

Simplemente añade el atributo `data-astro-prefetch` a cualquier etiqueta de enlace `<a>` que apunte a una página de tu propio sitio.

```html
<!-- Este enlace ahora es "inteligente" -->
<a href="/acerca-de-nosotros" data-astro-prefetch>Conoce al equipo</a>

<!-- Este enlace funcionará de forma normal, sin precarga -->
<a href="/contacto">Contacto</a>

<!-- Los enlaces a sitios externos son ignorados, no te preocupes por ellos -->
<a href="https://google.com">Ir a Google</a>
```

**Explicación del ejemplo:**
Al añadir `data-astro-prefetch` al enlace "Conoce al equipo", le estás diciendo a Astro: "Cuando un usuario pase el ratón por encima de este enlace, por favor, empieza a descargar la página `/acerca-de-nosotros` en silencio". El usuario no notará nada hasta que haga clic y la página aparezca como por arte de magia.

#### 3. **Desarrollo:**

Este atributo es el corazón del prefetching en Astro. Es la forma manual y controlada de decidir qué páginas son las más importantes para precargar. Por defecto, al usar `data-astro-prefetch` sin ningún valor, se utiliza la estrategia `hover` (precargar al pasar el mouse), que es un equilibrio perfecto entre proactividad y ahorro de recursos. Recuerda, esto solo funciona para enlaces internos de tu sitio.

🔴 **Fundamental**: Activar el prefetching no sirve de nada si no le dices a Astro _qué_ enlaces precargar. Este atributo es la herramienta principal para hacerlo, dándote control total sobre el comportamiento de tu sitio.

---

## C - Estrategias de Prefetching: El "Cuándo" de la Precarga 🟡

#### 1. **Introducción:**

Astro no solo te permite decidir _qué_ precargar, sino también _cuándo_ hacerlo, dándote un control granular para adaptarte a cada situación y no malgastar los datos del usuario.

#### 2. **Ejemplo:**

Puedes especificar la estrategia directamente en el atributo `data-astro-prefetch`.

```html
<!-- Estrategia 'hover' (por defecto): Precarga al pasar el mouse. -->
<a href="/blog" data-astro-prefetch="hover">Nuestro Blog</a>

<!-- Estrategia 'tap': Precarga justo en el instante antes del clic. ¡Súper seguro! -->
<a href="/comprar" data-astro-prefetch="tap">Finalizar Compra</a>

<!-- Estrategia 'viewport': Precarga tan pronto como el enlace es visible en la pantalla. -->
<a href="/siguiente-articulo" data-astro-prefetch="viewport">Leer más...</a>

<!-- Estrategia 'load': Precarga TODOS los enlaces marcados en la página una vez que esta ha cargado. ¡Úsalo con cuidado! -->
<a href="/mapa-del-sitio" data-astro-prefetch="load">Mapa del Sitio</a>
```

**Explicación del ejemplo:**
Cada enlace tiene un comportamiento distinto. El enlace de "Finalizar Compra" usa `tap` porque es una acción crítica y no queremos precargarla a menos que el usuario esté 100% seguro de hacer clic. El enlace "Leer más..." usa `viewport` porque es muy probable que el usuario haga clic en él después de ver el inicio del artículo.

#### 3. **Desarrollo:**

Elegir la estrategia correcta es un arte. Astro te ofrece cuatro opciones:

- **`hover` (por defecto):** Ideal para la mayoría de los enlaces de navegación.
- **`tap`:** El más conservador. Perfecto para acciones importantes (comprar, borrar) o para ahorrar el máximo de datos. Astro es tan inteligente que si detecta que un usuario tiene un plan de datos limitado o una conexión lenta, usará esta estrategia automáticamente aunque hayas puesto otra.
- **`viewport`:** Genial para enlaces que aparecen a medida que el usuario hace scroll, como en un feed infinito o al final de un post.
- **`load`:** La opción más agresiva. Precarga todos los enlaces marcados en cuanto la página inicial está lista. Puede ser útil para sitios pequeños con pocas páginas, pero puede consumir muchos datos en sitios grandes.

🟡 **Importante**: Aunque podrías vivir solo con la estrategia por defecto (`hover`), conocer y usar las otras estrategias te convierte en un desarrollador que realmente se preocupa por la experiencia y los recursos de sus usuarios. Es una herramienta de optimización muy poderosa.

---

## D - Configuración Global: Ajustes de Prefetch para Todo el Sitio 🟡

#### 1. **Introducción:**

Si no quieres ir enlace por enlace, puedes establecer reglas de prefetching para todo tu sitio desde el archivo de configuración, ahorrándote mucho trabajo.

#### 2. **Ejemplo:**

Imagina que quieres que _todos_ los enlaces de tu sitio se precarguen en cuanto sean visibles en la pantalla, sin tener que añadir `data-astro-prefetch` a cada uno.

**`astro.config.mjs`**

```javascript
import { defineConfig } from "astro/config";

export default defineConfig({
  prefetch: {
    // ¡Precarga todos los enlaces de mi sitio!
    prefetchAll: true,
    // Y quiero que la estrategia por defecto sea 'viewport', no 'hover'.
    defaultStrategy: "viewport",
  },
});
```

**Y si quieres que un enlace específico NO se precargue:**

```html
<!-- Este enlace NO se precargará, a pesar de la configuración global -->
<a href="/logout" data-astro-prefetch="false">Cerrar Sesión</a>
```

**Explicación del ejemplo:**
Con la configuración de `astro.config.mjs`, hemos establecido dos reglas para todo el sitio:

1.  `prefetchAll: true`: Cualquier enlace `<a>` interno se considerará candidato para prefetching, sin necesidad de añadirle el atributo.
2.  `defaultStrategy: 'viewport'`: La precarga se activará cuando el enlace entre en la pantalla.

Luego, en el HTML, mostramos cómo crear una excepción. El enlace "Cerrar Sesión" tiene `data-astro-prefetch="false"`, que le dice a Astro: "Ignórame, no quiero que me precargues".

#### 3. **Desarrollo:**

Esta configuración es extremadamente útil para sitios donde quieres una experiencia súper fluida por defecto.

- `prefetchAll: true`: Es una decisión importante. Actívala si la mayoría de tus enlaces se benefician de la precarga.
- `defaultStrategy`: Te permite cambiar el comportamiento por defecto de `hover` a cualquiera de las otras estrategias (`tap`, `viewport`, `load`).

Saber cómo configurar esto globalmente y cómo crear excepciones locales con `data-astro-prefetch="false"` te da lo mejor de ambos mundos: automatización y control.

🟡 **Importante**: Esta es una configuración de "configúralo y olvídalo" que puede mejorar enormemente el rendimiento percibido de tu sitio con muy poco esfuerzo. Es muy recomendable entenderla.

---

## E - `prefetch()` Programático: Precarga sin Enlaces `<a>` 🔵

#### 1. **Introducción:**

A veces, la navegación no ocurre a través de un enlace `<a>` tradicional (por ejemplo, un botón o un evento personalizado); para estos casos, Astro te da una función para activar la precarga manualmente desde tu código JavaScript.

#### 2. **Ejemplo:**

Imagina que tienes un botón que, al hacerle clic, debería llevar al usuario a otra página. Quieres que esa página se precargue cuando el usuario simplemente _pase el mouse_ sobre el botón.

```html
<button id="miBoton">Ir a la Galería</button>

<script>
  // 1. Importamos la herramienta mágica desde Astro
  import { prefetch } from "astro:prefetch";

  const miBoton = document.getElementById("miBoton");

  // 2. Cuando el mouse pasa sobre el botón...
  miBoton.addEventListener(
    "mouseenter",
    () => {
      // 3. ...le decimos a Astro que empiece a descargar la página de la galería.
      prefetch("/galeria");
    },
    { once: true }
  ); // { once: true } es una buena práctica para que solo se ejecute una vez.

  // La navegación real ocurriría en el evento 'click'
  miBoton.addEventListener("click", () => {
    window.location.href = "/galeria";
  });
</script>
```

**Explicación del ejemplo:**
Este script es muy astuto. No espera al clic. En el momento en que el usuario posa el cursor sobre el botón (`mouseenter`), la función `prefetch('/galeria')` se dispara, iniciando la descarga en segundo plano. Cuando el usuario finalmente hace clic, la página de la galería ya está lista y la transición es instantánea.

#### 3. **Desarrollo:**

La función `prefetch()` es tu navaja suiza para escenarios de navegación complejos. Puedes llamarla cuando quieras: al cargar un componente, después de una acción del usuario, etc. También respeta la configuración del usuario (modo de ahorro de datos, conexión lenta), pero puedes forzar la precarga si es absolutamente necesario con una opción: `prefetch('/ruta-critica', { ignoreSlowConnection: true });`.

🔵 **Específico**: No usarás esto todos los días. Está reservado para cuando la navegación de tu sitio se sale de los simples enlaces `<a>`. Pero cuando lo necesites, te alegrarás inmensamente de que exista. Es una herramienta de poder para casos de uso avanzados.

---

## F - `eagerness`: Ajustando la "Ansiedad" de la Precarga (Experimental) 🔵

#### 1. **Introducción:**

Esta es una función experimental y avanzada que te permite darle "pistas" al navegador sobre qué tan urgente o importante es precargar un enlace, permitiendo una optimización aún más fina.

#### 2. **Ejemplo:**

Imagina que tienes varios enlaces para precargar programáticamente, pero con diferentes niveles de prioridad.

```html
<script>
  import { prefetch } from "astro:prefetch";

  // Esta página es súper importante, ¡precárgala ya!
  prefetch("/carrito-de-compras", { eagerness: "immediate" }); // 'immediate' es el valor por defecto.

  // Esta página es un panel pesado. Precárgalo, pero sin tanta prisa.
  prefetch("/dashboard-de-analiticas", { eagerness: "conservative" });

  // Los términos de servicio no son tan visitados. Prioridad moderada.
  prefetch("/terminos-y-condiciones", { eagerness: "moderate" });
</script>
```

**Explicación del ejemplo:**
Estamos usando la opción `eagerness` para comunicarle al navegador nuestras intenciones.

- `immediate`: La máxima prioridad. "Hazlo ahora".
- `conservative`: La mínima prioridad. "Si tienes tiempo y recursos de sobra, considera esto".
- `moderate`: Un punto intermedio.

#### 3. **Desarrollo:**

Esta característica se basa en una tecnología de navegador muy moderna llamada [Speculation Rules API](https://developer.mozilla.org/en-US/docs/Web/API/Speculation_Rules_API). Para usarla, necesitas activar una bandera experimental en tu configuración de Astro: `experimental: { clientPrerender: true }`. La opción `eagerness` te permite gestionar mejor los recursos del navegador, evitando sobrecargarlo si intentas precargar demasiadas cosas a la vez. Los niveles de "ansiedad" son, de mayor a menor: `immediate` > `eager` > `moderate` > `conservative`.

🔵 **Específico**: Esto es para los obsesionados del rendimiento que trabajan con sitios complejos y quieren el máximo control. Es experimental, así que úsalo con conocimiento y ten en cuenta que su comportamiento puede cambiar.

---

## G - Prefetch y View Transitions: El Dúo Dinámico 🟡

#### 1. **Introducción:**

Si usas las famosas View Transitions de Astro (con el componente `<ViewTransitions />`) para tener animaciones suaves entre páginas, ¡tienes una buena noticia! El prefetching se activa automáticamente para todos los enlaces.

#### 2. **Ejemplo:**

Por defecto, al usar View Transitions, Astro se comporta como si hubieras configurado esto:
`prefetch: { prefetchAll: true }`

Pero, ¿y si no quieres ese comportamiento? Puedes sobreescribirlo fácilmente.

**Caso 1: Desactivar el prefetching por completo.**
**`astro.config.mjs`**

```javascript
import { defineConfig } from "astro/config";

export default defineConfig({
  // Aunque use View Transitions, no quiero nada de prefetching.
  prefetch: false,
});
```

**Caso 2: Mantener el prefetching, pero solo para enlaces marcados manualmente.**
**`astro.config.mjs`**

```javascript
import { defineConfig } from "astro/config";

export default defineConfig({
  // Quiero prefetching, pero no para todos. Volvamos al modo manual.
  prefetch: {
    prefetchAll: false,
  },
});
```

**Explicación del ejemplo:**
El componente `<ViewTransitions />` (anteriormente `<ClientRouter />`) es muy conveniente y asume que si quieres transiciones suaves, también querrás una carga rápida. Por eso activa `prefetchAll: true`. Los ejemplos de código te muestran cómo tomar el control de nuevo: ya sea apagándolo por completo (`prefetch: false`) o volviendo al comportamiento por defecto donde solo los enlaces con `data-astro-prefetch` son precargados (`prefetchAll: false`).

#### 3. **Desarrollo:**

Esta es una de esas "magias" de Astro que es genial, pero que puede confundirte si no sabes que está ocurriendo. Si de repente notas que tu sitio está intentando precargar todos los enlaces y no sabes por qué, la respuesta probablemente sea que añadiste View Transitions. Saber cómo personalizar esta configuración es clave para que tu sitio se comporte exactamente como tú quieres.

🟡 **Importante**: Si planeas usar View Transitions (y es muy probable que sí, porque son geniales), es fundamental que entiendas que el prefetching se activará para todo y que sepas cómo ajustar ese comportamiento a tus necesidades.

---

## H - Soporte en Navegadores y Caché: El "Por qué no funciona" ⚪

#### 1. **Introducción:**

El prefetching de Astro es muy listo y usa la mejor tecnología disponible en cada navegador, pero para que funcione correctamente en todos, depende de una cosa crucial: las **cabeceras de caché**.

#### 2. **Desarrollo:**

Aquí no hay un ejemplo de código, sino un conocimiento vital que te ahorrará dolores de cabeza.

- **¿Cómo funciona?** Astro intenta usar `<link rel="prefetch">`, que es el método nativo y más eficiente. Si el navegador no lo soporta (como Safari), usa un método alternativo con `fetch()`.
- **El Requisito Clave:** Ambos métodos, especialmente el de `fetch()`, necesitan que el servidor responda con cabeceras de caché (como `ETag` o `Cache-Control`). Estas cabeceras le dicen al navegador: "Oye, ya tienes una versión de este archivo, no necesitas descargarlo de nuevo". Sin ellas, el navegador podría descargar la página dos veces (una para el prefetch y otra al hacer clic), ¡lo cual anularía todo el beneficio!

**Resumen por Navegador:**

- **Chrome:** Funciona de maravilla. Soporta todo.
- **Firefox:** Soporta `prefetch`, pero es muy estricto. Si no hay cabeceras de caché, puede dar errores o no funcionar.
- **Safari:** No soporta `prefetch` nativo, así que usa `fetch()`. Depende **totalmente** de las cabeceras de caché para funcionar.

**La Regla de Oro:**
No te preocupes demasiado por los detalles de cada navegador. Solo asegúrate de una cosa: **tu hosting debe configurar correctamente las cabeceras de caché**.

- **Para sitios estáticos (Netlify, Vercel, Cloudflare Pages, etc.):** Esto casi siempre se hace automáticamente por ti. ¡No tienes que hacer nada!
- **Para sitios con SSR (renderizado en el servidor):** Es posible que tengas que configurar las cabeceras de caché tú mismo en tu código de servidor.

⚪ **Raramente usado (como concepto a modificar, pero vital de conocer)**: No es algo que _hagas_ activamente, sino algo que _debes saber_. Lo clasifico así porque el 90% de las veces tu plataforma de despliegue lo manejará por ti. Sin embargo, si el prefetching no te funciona, la causa número uno es un problema de caché. Saber esto te convierte en un detective de bugs de primer nivel.
