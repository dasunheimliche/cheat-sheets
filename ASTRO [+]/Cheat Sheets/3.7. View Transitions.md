## A - View Transitions: La Magia de Moverse con Estilo 🔴

#### 1. **Introducción:**

Imagina que tu sitio web es una película; las View Transitions son los efectos especiales que hacen que pasar de una escena (página) a otra sea suave y espectacular, en lugar de un corte brusco.

#### 2. **Ejemplo:**

Piensa en un blog. Haces clic en la foto de un artículo en la página principal y, en lugar de que la página simplemente desaparezca y aparezca la nueva, la foto "viaja" y se expande hasta su lugar en la página del artículo.

![Ejemplo visual de una transición de vista](https://docs.astro.build/assets/view-transitions-hero.webp)

**Explicación del ejemplo:**
En la imagen, ves cómo un elemento (la tarjeta del astronauta) no se recarga, sino que se transforma y se mueve suavemente de la página de listado a la página de detalle. Esto mantiene la atención del usuario y hace que la navegación se sienta increíblemente fluida, como si fuera una aplicación de escritorio y no una web.

#### 3. **Desarrollo:**

Las View Transitions son una tecnología de los navegadores modernos que Astro aprovecha para crear animaciones entre páginas. Por defecto, cuando haces clic en un enlace, el navegador borra todo y carga la nueva página. ¡Aburrido y brusco! Con las View Transitions, Astro puede "ver" qué elementos son comunes entre la página vieja y la nueva (como un logo, una imagen o un título) y animar su cambio de posición, tamaño o apariencia.

Esto convierte tu sitio web de múltiples páginas (MPA) en algo que _se siente_ como una aplicación de una sola página (SPA), pero sin la complejidad y manteniendo la rapidez y el SEO de Astro.

🔴 **Fundamental**: Este es el concepto central. Entender qué son y por qué existen es el primer paso para usarlas. Son la base de todo lo que veremos a continuación.

---

## B - `<ClientRouter />`: El Interruptor Mágico para Activar las Transiciones 🔴

#### 1. **Introducción:**

Este componente es el cerebro que activa y gestiona todas las transiciones automáticas en tu sitio, convirtiendo la navegación normal en una experiencia fluida de SPA.

#### 2. **Ejemplo:**

Para activar las transiciones en TODO tu sitio, simplemente importa `<ClientRouter />` y ponlo en el `<head>` de tu layout principal.

**`src/layouts/Layout.astro`**

```astro
---
import { ClientRouter } from 'astro:transitions';
---
<html lang="es">
  <head>
    <meta charset="utf-t" />
    <title>Mi Sitio Mágico</title>

    <!-- ¡AQUÍ ESTÁ LA MAGIA! -->
    <ClientRouter />
  </head>
  <body>
    <slot />
  </body>
</html>
```

**Explicación del ejemplo:**
Al añadir `<ClientRouter />` en tu layout (el archivo que define la estructura común de tus páginas), le estás diciendo a Astro: "Oye, a partir de ahora, quiero que interceptes todos los clics en los enlaces y, en lugar de recargar la página, cargues el nuevo contenido y lo animes suavemente". ¡Con solo esa línea, ya tienes transiciones por defecto en todo tu sitio!

#### 3. **Desarrollo:**

El `<ClientRouter />` es más que un simple activador. Es un pequeño script que se ejecuta en el navegador del usuario y hace varias cosas:

1.  **Intercepta clics:** Escucha los clics en las etiquetas `<a>`.
2.  **Carga contenido en segundo plano:** Cuando haces clic, busca la nueva página sin recargar.
3.  **Realiza la transición:** Usa la API de View Transitions del navegador para animar el cambio entre el contenido viejo y el nuevo.
4.  **Ofrece un plan B:** Si el navegador del usuario es muy antiguo y no soporta esta API, tiene un [mecanismo de fallback](#m-fallback-control-el-plan-b-para-navegadores-antiguos-🟡) para que el sitio siga funcionando.

🔴 **Fundamental**: Sin este componente, nada de la magia de las transiciones automáticas funciona. Es el requisito número uno para empezar.

---

## C - `transition:name`: Poniéndole una Etiqueta a tus Actores 🟡

#### 1. **Introducción:**

Esta directiva te permite darle un nombre único a un elemento para que Astro sepa que es "el mismo" en dos páginas diferentes, asegurando que se anime correctamente.

#### 2. **Ejemplo:**

Imagina que tienes una imagen de perfil en tu página de inicio y la misma imagen, pero más grande, en tu página "Sobre mí". Quieres que la imagen pequeña "crezca" y se mueva a su nueva posición al navegar.

**`src/pages/index.astro`**

```astro
---
// Página de inicio
---
<img src="/perfil.jpg" alt="Mi foto" transition:name="foto-perfil" />
```

**`src/pages/sobre-mi.astro`**

```astro
---
// Página "Sobre mí"
---
<img src="/perfil.jpg" alt="Mi foto" class="grande" transition:name="foto-perfil" />
```

**Explicación del ejemplo:**
Al darles a ambas imágenes el mismo `transition:name="foto-perfil"`, le estás diciendo a Astro: "¡Ojo! Esta imagen en `index.astro` y esta otra en `sobre-mi.astro` son la misma entidad. Cuando navegues entre estas páginas, no las desvanezcas, ¡anímala moviéndose y cambiando de tamaño de una a otra!". Sin esto, Astro podría no adivinar que son el mismo elemento y aplicaría la animación por defecto (un fundido).

#### 3. **Desarrollo:**

Astro es muy inteligente y a menudo puede adivinar qué elementos se corresponden entre páginas. Pero a veces, especialmente si la estructura del HTML cambia mucho, necesita una pista. `transition:name` es esa pista. Es como ponerle una etiqueta con nombre a tus maletas en el aeropuerto; te aseguras de que la correcta llegue a su destino.

**¡Cuidado!** El nombre que elijas debe ser **único en cada página**. No puedes tener dos elementos con `transition:name="foto-perfil"` en la misma página.

🟡 **Importante**: Aunque Astro intenta hacer el trabajo por ti, usar `transition:name` te da el control total y es esencial para crear transiciones de elementos específicos (lo que se conoce como "morphing" o "hero transitions").

---

## D - `transition:persist`: Congelando el Tiempo para tus Componentes 🟡

#### 1. **Introducción:**

Esta directiva le dice a Astro que un elemento o componente no debe ser reemplazado al cambiar de página, sino que debe mantenerse tal cual, conservando su estado interno.

#### 2. **Ejemplo:**

Tienes un reproductor de video. Quieres que el video siga reproduciéndose sin interrupciones mientras el usuario navega a otra página que también muestra ese mismo video.

**`src/components/ReproductorVideo.astro`**

```astro
<!-- Este video seguirá sonando al cambiar de página -->
<video controls autoplay muted transition:persist>
  <source src="/mi-video.mp4" type="video/mp4" />
</video>
```

**Explicación del ejemplo:**
Al añadir `transition:persist`, el componente `<video>` no se destruirá y se volverá a crear. En su lugar, el mismo elemento del DOM se mantendrá en la página. Si el video estaba en el segundo 35, seguirá en el segundo 35 en la nueva página. ¡Magia!

Esto también funciona de maravilla con componentes interactivos (islas de Astro). Imagina un contador:

**`src/components/Contador.jsx`** (Componente de React)

```jsx
// ...código del contador...
```

**`src/layouts/Layout.astro`**

```astro
---
import Contador from '../components/Contador.jsx';
---
<!-- ... -->
<header>
  <Contador client:load transition:persist />
</header>
<!-- ... -->
```

Si haces clic en el contador 5 veces y luego navegas a otra página que usa el mismo layout, el contador seguirá mostrando "5", en lugar de reiniciarse a cero.

#### 3. **Desarrollo:**

`transition:persist` es la solución para mantener el "estado". El "estado" es simplemente la información momentánea de un componente: el tiempo de un video, el número de un contador, el texto escrito en un campo de búsqueda, etc. Por defecto, al cambiar de página, todo se reinicia. `persist` evita ese reinicio para los elementos que tú elijas.

También puedes combinarlo con `transition:name` si el elemento persistente necesita ser identificado explícitamente: `transition:persist="mi-reproductor"`.

🟡 **Importante**: Es una herramienta increíblemente poderosa para mejorar la experiencia de usuario en aplicaciones web complejas, como reproductores de música, carritos de compra flotantes o cualquier componente que no deba reiniciarse con la navegación.

---

## E - `transition:persist-props`: "No me actualices, estoy bien así" 🔵

#### 1. **Introducción:**

Es un complemento de `transition:persist` que le dice a un componente persistente que ignore las nuevas `props` (propiedades) que le llegan desde la nueva página y conserve las que ya tenía.

#### 2. **Ejemplo:**

Imagina un componente `Header` que muestra el título de la página actual. Quieres que el `Header` persista, pero que el título SÍ se actualice. En ese caso, solo usas `transition:persist`.

Pero, ¿y si tienes un componente que recibe una `prop` inicial y no quieres que cambie nunca?

**`src/pages/pagina-1.astro`**

```astro
<MiComponenteEspecial client:load transition:persist transition:persist-props configInicial="A" />
```

**`src/pages/pagina-2.astro`**

```astro
<MiComponenteEspecial client:load transition:persist transition:persist-props configInicial="B" />
```

**Explicación del ejemplo:**
Cuando navegas de `pagina-1` a `pagina-2`, `MiComponenteEspecial` persistirá gracias a `transition:persist`. Pero como también hemos añadido `transition:persist-props`, el componente ignorará la nueva `configInicial="B"` y seguirá usando la original, `configInicial="A"`. Su estado y sus props iniciales quedan "congelados".

#### 3. **Desarrollo:**

Esta es la diferencia clave:

- `transition:persist`: Mantiene el **estado interno** del componente, pero lo **vuelve a renderizar con las nuevas props**. Útil para un `Header` que necesita actualizar el título de la página.
- `transition:persist` + `transition:persist-props`: Mantiene el **estado interno** Y las **props originales**. El componente no se vuelve a renderizar. Útil para un widget que se configura una vez y no debe cambiar.

🔵 **Específico**: No lo usarás todos los días, pero es la herramienta perfecta para casos muy concretos donde necesitas un control absoluto sobre el ciclo de vida de un componente persistente. Es bueno saber que existe para cuando te encuentres con ese problema.

---

## F - `transition:animate`: Tu Paleta de Animaciones Prediseñadas 🟡

#### 1. **Introducción:**

Esta directiva te permite cambiar la animación por defecto (`fade`) por otras animaciones que Astro ya trae listas para usar, como `slide`.

#### 2. **Ejemplo:**

Por defecto, las páginas se desvanecen (fade). Vamos a hacer que el contenido principal se deslice hacia un lado, pero que el resto de la página no tenga ninguna animación.

```astro
---
import CommonHead from "../components/CommonHead.astro"; // Contiene <ClientRouter />
---
<!-- Desactivamos la animación por defecto para toda la página -->
<html transition:animate="none">
  <head>
    <CommonHead />
  </head>
  <body>
    <header>
      ...
    </header>

    <!-- Pero para el contenido principal, ¡queremos un deslizamiento! -->
    <main transition:animate="slide">
      <h1>¡Hola Mundo!</h1>
      <p>Este contenido se deslizará.</p>
    </main>
  </body>
</html>
```

**Explicación del ejemplo:**

1.  En la etiqueta `<html>`, usamos `transition:animate="none"` para eliminar la animación de fundido (fade) que Astro aplica por defecto a todo.
2.  Luego, en la etiqueta `<main>`, anulamos esa regla y le decimos `transition:animate="slide"`.
    El resultado es que, al navegar, solo el bloque `<main>` tendrá una animación de deslizamiento, mientras que el resto de la página cambiará instantáneamente.

#### 3. **Desarrollo:**

Astro te da varias animaciones listas para usar:

- `fade` (la de por defecto): Un contenido se desvanece mientras el nuevo aparece.
- `slide`: El contenido viejo se desliza hacia la izquierda y el nuevo entra desde la derecha (en navegación hacia adelante).
- `initial`: Usa la animación por defecto del navegador, que es más sutil.
- `none`: Sin animación. El cambio es instantáneo.

Puedes combinar estas directivas para orquestar tus transiciones. Es como ser el director de tu propia película de efectos especiales.

🟡 **Importante**: Esta es la forma más rápida y sencilla de personalizar el "feeling" de tu sitio sin escribir una sola línea de CSS. Es fundamental para dar personalidad a tus transiciones.

---

## G - Animaciones Personalizadas: Tu Propio Kit de Efectos Especiales 🔵

#### 1. **Introducción:**

Si las animaciones predefinidas no son suficientes, puedes crear las tuyas desde cero usando CSS y un poco de JavaScript.

#### 2. **Ejemplo:**

Vamos a crear una animación llamada "bump" (bote) que hace que el nuevo contenido aparezca con un pequeño efecto de rebote.

**1. Define la animación en CSS (en tu layout principal):**

```astro
// src/layouts/Layout.astro
<style is:global>
  @keyframes bump {
    0% {
      transform: scale(0.8);
      opacity: 0;
    }
    70% {
      transform: scale(1.05);
      opacity: 1;
    }
    100% {
      transform: scale(1);
    }
  }
</style>
```

**2. Configura la animación en el script de tu página:**

```astro
// src/pages/index.astro
---
const miAnimacionBump = {
  forwards: { // Al navegar HACIA ADELANTE
    old: { name: 'fade', duration: '0.3s' }, // La página vieja se desvanece
    new: { name: 'bump', duration: '0.5s', easing: 'ease-out' } // La nueva "bota"
  },
  backwards: { // Al navegar HACIA ATRÁS
    old: { name: 'fade', duration: '0.3s' },
    new: { name: 'bump', duration: '0.5s', easing: 'ease-out' }
  }
};
---
<h1 transition:animate={miAnimacionBump}>
  ¡Este título hará BUMP!
</h1>
```

**Explicación del ejemplo:**

1.  **CSS (`@keyframes`):** Primero, definimos los pasos de nuestra animación `bump` con CSS. La etiqueta `<style is:global>` asegura que esta animación esté disponible en todo el sitio.
2.  **JavaScript (objeto de configuración):** Luego, creamos un objeto en JavaScript. Este objeto le dice a Astro qué hacer:
    - `forwards`: Define las animaciones para la navegación "hacia adelante" (clic en un enlace).
    - `backwards`: Define las animaciones para la navegación "hacia atrás" (clic en el botón "atrás" del navegador).
    - `old` y `new`: Para cada dirección, especificamos qué animación usar para el contenido `old` (el que se va) y el `new` (el que llega).
3.  **Aplicación:** Finalmente, pasamos este objeto de configuración a `transition:animate`.

#### 3. **Desarrollo:**

Crear animaciones personalizadas te da un poder ilimitado. Puedes definir animaciones completamente diferentes para la navegación hacia adelante y hacia atrás, y para los elementos que entran y los que salen. Es un nivel de control profesional.

🔵 **Específico**: Esto es para cuando realmente quieres que tu sitio destaque con una animación única. No es necesario para la mayoría de los proyectos, pero es una herramienta increíblemente potente para diseñadores y desarrolladores creativos.

---

## H - `data-astro-reload`: El Botón de "Escape" 🟡

#### 1. **Introducción:**

Este atributo HTML te permite forzar una recarga completa de la página para un enlace específico, ignorando por completo el sistema de transiciones.

#### 2. **Ejemplo:**

Quieres que todos los enlaces de tu sitio tengan transiciones suaves, EXCEPTO el enlace para "Cerrar Sesión", que debe recargar la página por completo para asegurar que todo el estado del usuario se limpie.

```html
<!-- Este enlace tendrá una transición suave -->
<a href="/perfil">Mi Perfil</a>

<!-- Este enlace forzará una recarga completa de la página -->
<a href="/logout" data-astro-reload>Cerrar Sesión</a>
```

**Explicación del ejemplo:**
Al añadir `data-astro-reload` a la etiqueta `<a>`, le estás diciendo al `<ClientRouter />` de Astro: "Ignórame. Cuando alguien haga clic aquí, no hagas tu magia de transiciones. Haz lo que el navegador ha hecho toda la vida: una recarga completa y tradicional".

#### 3. **Desarrollo:**

¿Por qué querrías hacer esto?

1.  **Enlaces externos:** Aunque Astro suele detectarlos, es una buena práctica para asegurar que no intente una transición a un sitio externo.
2.  **Páginas sin `<ClientRouter />`:** Si enlazas a una página de tu propio sitio que, por alguna razón, no usa el layout con el router, necesitas una recarga completa para que funcione.
3.  **Scripts de terceros:** A veces, una recarga completa es necesaria para que ciertos scripts (como los de analíticas o autenticación) se reinicien correctamente.
4.  **Formularios:** También puedes usar `data-astro-reload` en una etiqueta `<form>` para que su envío provoque una recarga tradicional.

🟡 **Importante**: Es tu válvula de seguridad. Cuando las transiciones automáticas causan un problema o simplemente no son deseadas, `data-astro-reload` es la solución simple y directa.

---

## I - `navigate()`: El Control Remoto para la Navegación 🔵

#### 1. **Introducción:**

Es una función de JavaScript que te permite activar una navegación con transición desde tu propio código, en lugar de depender de un clic en un enlace.

#### 2. **Ejemplo:**

Tienes un menú desplegable (`<select>`) y quieres que el usuario navegue a una nueva página tan pronto como elija una opción, con una transición suave.

**`src/components/MenuNavegacion.astro`**```astro
<select id="menu">

  <option value="/pagina1">Ir a Página 1</option>
  <option value="/pagina2">Ir a Página 2</option>
</select>

<script>
  import { navigate } from 'astro:transitions/client';

  const menu = document.getElementById('menu');
  menu.onchange = (evento) => {
    const nuevaUrl = evento.target.value;
    // ¡Aquí disparamos la navegación!
    navigate(nuevaUrl);
  };
</script>

````

**Explicación del ejemplo:**
1.  Importamos la función `navigate` desde `astro:transitions/client`.
2.  Escuchamos el evento `onchange` del menú desplegable.
3.  Cuando el usuario elige una opción, obtenemos la URL del `value` de esa opción.
4.  Llamamos a `navigate(nuevaUrl)`, y Astro iniciará una navegación con transición a esa página, ¡como si el usuario hubiera hecho clic en un enlace!

#### 3. **Desarrollo:**

`navigate()` es para situaciones donde la navegación no es un simple clic en un `<a>`. Piensa en:
*   Después de enviar un formulario con éxito.
*   Al terminar una cuenta atrás.
*   Como parte de una lógica compleja en un componente de React/Vue/Svelte.

La función `navigate(href, options)` también acepta un segundo argumento `options` para un control más fino, como por ejemplo, cómo debe afectar al historial del navegador (ver [siguiente concepto](#j-data-astro-history-el-editor-del-historial-del-navegador-🔵)).

🔵 **Específico**: Es una herramienta para desarrolladores que necesitan integrar la navegación de Astro en lógica de JavaScript personalizada. No la usarás para un blog simple, pero es indispensable para construir aplicaciones web interactivas.

---

## J - `data-astro-history`: El Editor del Historial del Navegador 🔵

#### 1. **Introducción:**

Este atributo te permite controlar cómo un enlace afecta al historial del navegador, permitiéndote reemplazar la entrada actual en lugar de añadir una nueva.

#### 2. **Ejemplo:**

Imagina un flujo de compra: `Paso 1 -> Paso 2 -> Página de Confirmación`. Después de la confirmación, navegas a la página de "Gracias". Si el usuario presiona el botón "Atrás" desde la página de "Gracias", no quieres que vuelva a la "Confirmación", ¡sino al "Paso 2"!

**`src/pages/confirmacion.astro`**
```html
<!-- Al hacer clic aquí, la URL cambiará a /gracias,
     pero la entrada "/confirmacion" en el historial será reemplazada. -->
<a href="/gracias" data-astro-history="replace">Confirmar y finalizar</a>
````

**Explicación del ejemplo:**
Usando `data-astro-history="replace"`, le decimos al navegador: "Navega a `/gracias`, pero no crees una nueva entrada en el historial. En su lugar, sobrescribe la entrada actual (`/confirmacion`)".

El historial se vería así:

- **Sin `replace`:** `... -> Paso 2 -> Confirmación -> Gracias` (Atrás te lleva a Confirmación)
- **Con `replace`:** `... -> Paso 2 -> Gracias` (Atrás te lleva a Paso 2)

#### 3. **Desarrollo:**

Esta herramienta es útil para flujos de usuario donde ciertos pasos son transitorios y no tiene sentido volver a ellos. Los valores posibles son:

- `push` (por defecto): Añade una nueva entrada al historial.
- `replace`: Reemplaza la entrada actual del historial.
- `auto`: El comportamiento por defecto de Astro.

También puedes controlar esto mediante programación usando la opción `history` en la [función `navigate()`](#i-navigate-el-control-remoto-para-la-navegación-🔵).

🔵 **Específico**: Es una técnica avanzada para pulir la experiencia de usuario en flujos de navegación complejos. La mayoría de los sitios no lo necesitarán, pero en aplicaciones web y procesos de varios pasos, es un detalle que marca la diferencia.

---

## K - Transiciones con Formularios: Envíos con Estilo 🟡

#### 1. **Introducción:**

El router de Astro también puede interceptar el envío de formularios (`<form>`), permitiendo que la página de respuesta se cargue con una transición suave en lugar de una recarga completa.

#### 2. **Ejemplo:**

Un formulario de contacto. Cuando el usuario lo envía, en lugar de una recarga brusca, quieres que la página se transforme suavemente en la página de "Gracias por contactar".

**`src/components/FormularioContacto.astro`**

```astro
<form method="POST" action="/enviado">
  <label for="email">Tu email:</label>
  <input type="email" id="email" name="email" />
  <button type="submit">Enviar</button>
</form>
```

**Explicación del ejemplo:**
¡No hay que hacer nada especial! Si tienes el `<ClientRouter />` en tu layout, Astro automáticamente gestionará el envío de este formulario. Cuando el usuario haga clic en "Enviar", Astro enviará los datos al servidor, recibirá la página `/enviado` y animará la transición hacia ella. Funciona tanto para métodos `GET` como `POST`.

#### 3. **Desarrollo:**

Esto hace que la interacción con formularios se sienta mucho más moderna e integrada en la experiencia de la aplicación.

- **Opt-out:** Si quieres que un formulario específico se envíe de la manera tradicional (con recarga completa), simplemente añádele el atributo [`data-astro-reload`](#h-data-astro-reload-el-botón-de-escape-🟡).
- **Pro-Tip (`enctype`):** Por defecto, Astro envía los datos del formulario como `multipart/form-data`. Si necesitas que se comporte exactamente como un navegador estándar (por ejemplo, para que tu backend lo procese correctamente), añade `enctype="application/x-www-form-urlencoded"` a tu etiqueta `<form>`.

🟡 **Importante**: Los formularios son una parte clave de casi cualquier sitio web. Saber que las transiciones funcionan con ellos de forma automática y cómo personalizar su comportamiento es muy útil.

---

## L - Fallback Control: El Plan B para Navegadores Antiguos 🟡

#### 1. **Introducción:**

Esta opción te permite decidir qué sucederá en navegadores antiguos que no soportan la API de View Transitions, asegurando que tu sitio no se rompa para ningún usuario.

#### 2. **Ejemplo:**

Configuras el `<ClientRouter />` para que, en navegadores no compatibles, simplemente cambie el contenido sin intentar ninguna animación, en lugar de hacer una recarga completa.

**`src/layouts/Layout.astro`**

```astro
---
import { ClientRouter } from 'astro:transitions';
---
<html>
  <head>
    <!-- Le decimos a Astro qué hacer si el navegador es antiguo -->
    <ClientRouter fallback="swap" />
  </head>
  <body>
    <slot />
  </body>
</html>
```

**Explicación del ejemplo:**
Al añadir `fallback="swap"` al componente `<ClientRouter />`, estás estableciendo una estrategia de respaldo. Si un usuario visita tu sitio con un navegador como Firefox (que a día de hoy aún no soporta View Transitions), en lugar de ver animaciones, la navegación seguirá siendo del lado del cliente (sin recarga), pero el contenido viejo será reemplazado instantáneamente (`swap`) por el nuevo.

#### 3. **Desarrollo:**

Tienes tres opciones para el `fallback`:

- `animate` (por defecto): Astro intenta _simular_ las animaciones usando JavaScript. Es la mejor experiencia, pero puede no ser perfecta.
- `swap`: No hay animación. El contenido se cambia rápidamente sin recargar la página. Es rápido y seguro.
- `none`: Desactiva por completo el router del lado del cliente en navegadores no compatibles. La navegación volverá a ser la tradicional recarga de página completa. Es la opción más segura si tienes problemas de compatibilidad.

🟡 **Importante**: La web es para todos, y no todos usan el navegador más moderno. Configurar un `fallback` sensato es una práctica de desarrollo responsable que garantiza una experiencia funcional para el 100% de tus visitantes.

## M - El Proceso de Navegación: ¿Qué Pasa Detrás de Cámaras? 🟡

#### 1. **Introducción:**

¿Alguna vez te has preguntado qué hace Astro exactamente cuando haces clic en un enlace con las transiciones activadas? Este es el paso a paso de su magia interna.

#### 2. **Ejemplo (El Proceso Simplificado):**

Imagina que eres un director de teatro preparando un cambio de escena:

1.  **🕵️‍♂️ El Disparo:** Un actor (el usuario) hace clic en un enlace. ¡Acción!
2.  **📸 Foto Fija:** El director (Astro) toma una foto del escenario actual (la página vieja). Esta foto se congela para que el público no vea el caos del cambio.
3.  **🎭 Cambio Tras Bastidores:** Mientras el público ve la foto congelada, los tramoyistas (el router de Astro) corren a toda prisa:
    - Quitan el decorado viejo y ponen el nuevo (`<body>`).
    - Revisan el guion de luces y sonido (`<head>`), manteniendo las luces que se repiten para que no parpadeen.
    - Mueven los actores "persistentes" (elementos con `transition:persist`) a sus nuevas posiciones en el nuevo escenario.
4.  **🎬 ¡Luz, Cámara, Animación!:** Una vez que el nuevo escenario está listo, el director grita "¡Ahora!". La foto congelada se desvanece y la nueva escena se revela, con los actores moviéndose suavemente a sus nuevas marcas (la animación de la transición).
5.  **📢 Anuncio Final:** Se encienden todas las luces y se ejecutan los nuevos efectos de sonido (se cargan los nuevos scripts y se dispara `astro:page-load`). ¡La escena ha terminado!

#### 3. **Desarrollo:**

Conocer este proceso no es vital para usar las transiciones, pero es **inmensamente útil para depurar**. Si algo no funciona como esperas (especialmente un script), entender en qué momento del "cambio de escena" se ejecuta te ayudará a encontrar el problema. Por ejemplo, si tu script necesita un elemento que está en el nuevo `<body>`, sabes que no puedes ejecutarlo antes del paso 3.

🟡 **Importante**: No necesitas memorizar esto, pero tenlo a mano. Cuando un script falle o una animación se comporte de forma extraña, volver a leer este proceso te dará pistas sobre _por qué_ está pasando.

---

## N - El Gran "¡Mi Script No Funciona!": Comportamiento de Scripts 🔴

#### 1. **Introducción:**

Este es, sin duda, el problema más común al empezar con View Transitions: un script que funcionaba perfectamente ahora solo se ejecuta en la primera carga de la página.

#### 2. **Ejemplo:**

Tienes un menú de hamburguesa para móviles. El script que lo abre y cierra funciona cuando cargas la página por primera vez, pero si navegas a otra página y vuelves, el botón ya no responde.

**El código que FALLA después de una transición:**

```javascript
// menu.js
// Esto solo se ejecuta UNA VEZ, cuando el sitio carga por primera vez.
document.querySelector(".hamburger").addEventListener("click", () => {
  document.querySelector(".nav-links").classList.toggle("expanded");
});
```

**El código que SIEMPRE FUNCIONA:**

```javascript
// menu.js
// Le decimos a Astro: "Oye, ejecuta esta función CADA VEZ que una página termine de cargar".
document.addEventListener("astro:page-load", () => {
  document.querySelector(".hamburger").addEventListener("click", () => {
    document.querySelector(".nav-links").classList.toggle("expanded");
  });
});
```

**Explicación del ejemplo:**
En una navegación tradicional, cada página es un borrón y cuenta nueva, por lo que los scripts se ejecutan siempre. Con las View Transitions, el "documento" principal no se recarga, solo se intercambia su contenido. Por defecto, Astro es eficiente y no vuelve a ejecutar los scripts que ya ha visto.

La solución es "enganchar" tu código a un evento del ciclo de vida de Astro, como `astro:page-load`. Este evento es la señal de Astro que dice: "¡Listo, he terminado de cargar la nueva página, ahora puedes inicializar tus cosas!".

#### 3. **Desarrollo:**

La regla de oro es: **Cualquier script que necesite manipular el DOM (añadir event listeners, mostrar/ocultar elementos, etc.) debe estar dentro de un listener de eventos del ciclo de vida de Astro.**

- **Scripts `is:inline`:** Estos scripts _pueden_ volver a ejecutarse si navegas a una página que no lo tiene y luego vuelves. Pero no es una garantía.
- **Scripts por defecto (empaquetados):** Estos están diseñados para ejecutarse solo una vez.

🔴 **Fundamental**: Este concepto es la clave para que tus sitios interactivos no se rompan al usar View Transitions. Si usas JavaScript, necesitas entender esto. Es la causa número uno de dolores de cabeza, y ahora tienes la cura.

---

## O - Eventos del Ciclo de Vida: Tus "Espías" en la Navegación 🟡

#### 1. **Introducción:**

Son notificaciones que Astro emite durante el proceso de navegación, permitiéndote ejecutar tu propio código en momentos muy específicos del cambio de página.

#### 2. **Ejemplo:**

Quieres evitar el "flash" de tema claro en un sitio con modo oscuro. Debes aplicar la clase `dark` al `<html>` de la nueva página _antes_ de que se muestre. El evento `astro:after-swap` es perfecto para esto.

```astro
<script is:inline>
  function aplicarTemaOscuro() {
    if (localStorage.theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }

  // Ejecútalo la primera vez
  aplicarTemaOscuro();

  // Y ejecútalo de nuevo justo después de que el nuevo contenido reemplace al viejo,
  // pero ANTES de que se pinte en pantalla.
  document.addEventListener('astro:after-swap', aplicarTemaOscuro);
</script>
```

**Explicación del ejemplo:**
`astro:after-swap` se dispara en un momento mágico: el nuevo HTML ya está en su sitio, pero el navegador aún no lo ha renderizado. Esto te da una ventana de oportunidad para hacer cambios (como añadir la clase `dark`) que serán visibles inmediatamente, sin parpadeos.

#### 3. **Desarrollo:**

Estos son tus principales "espías" o "gatillos", en orden de aparición:

- `astro:before-preparation`: **Cuándo usarlo:** Justo al inicio. Perfecto para **mostrar un spinner de carga**.
- `astro:after-preparation`: **Cuándo usarlo:** Cuando los datos de la nueva página ya se han descargado. Ideal para **ocultar el spinner de carga**.
- `astro:before-swap`: **Cuándo usarlo:** Justo antes de que el contenido viejo sea reemplazado. Útil para modificar el documento entrante o incluso para implementar tu propia lógica de reemplazo (muy avanzado).
- `astro:after-swap`: **Cuándo usarlo:** Justo después del reemplazo, antes del renderizado. Genial para **restaurar estado** (como el tema oscuro) o **manipular el scroll**.
- `astro:page-load`: **Cuándo usarlo:** Al final de todo, cuando la página es visible y está lista. Es el más común. El reemplazo del `DOMContentLoaded`. Ideal para **inicializar scripts, añadir event listeners**, etc. (como en el [ejemplo del menú](#n-el-gran-mi-script-no-funciona-comportamiento-de-scripts-🔴)).

🟡 **Importante**: Son tu caja de herramientas para interactuar con el proceso de navegación. No necesitas usarlos todos, pero saber que existen y para qué sirve cada uno te da un control total sobre la experiencia de usuario.

---

## P - `data-astro-rerun`: El Botón de "Re-ejecutar" para Scripts 🔵

#### 1. **Introducción:**

Es un atributo que puedes añadir a un script `<script is:inline>` para forzar que se vuelva a ejecutar en CADA transición de página, sin necesidad de un event listener.

#### 2. **Ejemplo:**

Tienes un pequeño script de analíticas que debe dispararse en cada cambio de página.

```html
<!-- Este script se ejecutará en la carga inicial y en cada navegación posterior. -->
<script is:inline data-astro-rerun>
  console.log("Página visitada:", window.location.pathname);
  // Aquí iría tu código de analíticas
</script>
```

**Explicación del ejemplo:**
Al añadir `data-astro-rerun`, le estás diciendo a Astro: "Olvida tu optimización de no repetir scripts. A este, en particular, quiero que lo ejecutes siempre, sin falta, cada vez que cambie la página". Es una orden directa.

#### 3. **Desarrollo:**

Esto parece una solución más fácil que usar `astro:page-load`, ¿verdad? ¡Cuidado! Tiene un efecto secundario importante: si tu script declara variables globales o añade listeners, lo hará una y otra y otra vez, lo que puede causar errores o fugas de memoria.

**¡Anticipando el problema!** Si usas `data-astro-rerun` para inicializar algo global, siempre comprueba si ya existe primero:

```javascript
<script is:inline data-astro-rerun>
  // Solo crea el objeto global si no existe ya
  if (!window.miAppGlobal) {
    window.miAppGlobal = { settings: 'inicial' };
  }
  // El resto de tu código que se ejecuta siempre...
</script>
```

🔵 **Específico**: Es una herramienta útil para scripts muy simples y autocontenidos. Para lógica más compleja, como añadir event listeners, es más seguro y limpio usar el evento [`astro:page-load`](#o-eventos-del-ciclo-de-vida-tus-espías-en-la-navegación-🟡), que te da un control más predecible.

---

## Q - Anuncio de Ruta: Hablándole a los Lectores de Pantalla 🟡

#### 1. **Introducción:**

Astro se asegura automáticamente de que los usuarios que utilizan tecnologías de asistencia (como lectores de pantalla) sepan que la página ha cambiado.

#### 2. **Ejemplo:**

No necesitas hacer nada. ¡Es automático!

#### 3. **Desarrollo:**

Cuando una página se recarga por completo, el lector de pantalla anuncia el título de la nueva página. En una navegación del lado del cliente, esto no ocurre por defecto. Sería como cambiar de canal en la tele sin que nadie se dé cuenta.

El `<ClientRouter />` de Astro soluciona esto: después de cada transición, busca el título de la nueva página (en este orden de prioridad: la etiqueta `<title>`, el primer `<h1>`, o la URL) y lo anuncia en voz alta a través de un elemento `aria-live`.

**¿Por qué es importante para ti?** Porque te recuerda la importancia de la accesibilidad. Asegúrate siempre de que cada página tenga una etiqueta `<title>` descriptiva. No solo es bueno para el SEO, sino que es crucial para que esta función de Astro haga bien su trabajo y todos los usuarios tengan una buena experiencia.

🟡 **Importante**: Aunque es una función automática, conocerla te hace un desarrollador más consciente y te anima a seguir buenas prácticas de accesibilidad, como usar siempre títulos de página adecuados.

---

## R - `prefers-reduced-motion`: Respetando las Preferencias del Usuario 🟡

#### 1. **Introducción:**

Astro desactiva automáticamente todas las animaciones de transición si el usuario ha configurado en su sistema operativo que prefiere movimiento reducido.

#### 2. **Ejemplo:**

Tampoco necesitas hacer nada aquí. ¡Astro lo gestiona por ti!

#### 3. **Desarrollo:**

Algunas personas pueden sentir mareos o malestar con las animaciones (condiciones como el síndrome de vestíbulo). Por eso, los sistemas operativos y navegadores ofrecen una opción de "reducir movimiento".

Astro respeta esta elección. Si detecta que el usuario tiene activada esta preferencia, todas las directivas `transition:animate` y las animaciones por defecto se desactivan. La navegación seguirá siendo del lado del cliente (rápida y sin recarga), pero el cambio de contenido será instantáneo, sin efectos de movimiento.

Es un gesto de respeto y empatía hacia tus usuarios, y es otra de esas cosas maravillosas que Astro hace por ti sin que tengas que mover un dedo.

🟡 **Importante**: Al igual que el anuncio de ruta, esto es un recordatorio del compromiso de Astro con una web accesible e inclusiva. Es una característica que simplemente funciona y hace que tu sitio sea mejor para todos.
