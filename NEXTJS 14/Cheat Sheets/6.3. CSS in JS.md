## CSS-in-JS en Next.js 14 (Cheat Sheet)

¬°Hola! üëã Veo que est√°s explorando CSS-in-JS en Next.js 14. ¬°Genial! Aqu√≠ te dejo una gu√≠a r√°pida y f√°cil para entenderlo todo sin dramas.

## A - CSS-in-JS y Server Components: ¬°Ojo! ‚ö†Ô∏è

#### 1. **Definici√≥n:**

CSS-in-JS es una t√©cnica para escribir estilos CSS directamente en tu c√≥digo JavaScript. Algunas librer√≠as de CSS-in-JS necesitan ejecutar JavaScript en tiempo real para funcionar. **Server Components** (componentes del servidor) en Next.js 14, por ahora, **no se llevan bien** con estas librer√≠as que requieren JavaScript en tiempo real.

#### 2. **Advertencia Importante:**

Si usas librer√≠as CSS-in-JS que necesitan JavaScript para funcionar en tiempo real, **no funcionar√°n directamente en Server Components**. Esto es algo temporal mientras los creadores de React y Next.js trabajan para mejorar la compatibilidad.

#### 3. **¬øQu√© significa esto para ti?**

Si est√°s usando Server Components y quieres usar CSS-in-JS, aseg√∫rate de que la librer√≠a que elijas sea compatible con las √∫ltimas versiones de React y con el "concurrent rendering" (una forma m√°s eficiente de React de renderizar las cosas).

## B - Librer√≠as CSS-in-JS Compatibles (Client Components) ‚úÖ

#### 1. **Definici√≥n:**

Estas son librer√≠as CSS-in-JS que **s√≠ funcionan** en Next.js 14, pero **solo en Client Components** (componentes del cliente). Recuerda, los Client Components son aquellos que se ejecutan en el navegador del usuario.

#### 2. **Lista de Librer√≠as Compatibles:**

- `chakra-ui`
- `kuma-ui`
- `@mui/material`
- `@mui/joy`
- `pandacss`
- `styled-jsx`
- `styled-components`
- `stylex`
- `tamagui`
- `tss-react`
- `vanilla-extract`

#### 3. **Librer√≠as "En Proceso":**

- `emotion` (Est√°n trabajando para que sea compatible)

#### 4. **Importante:**

Si quieres usar CSS-in-JS en tus **Client Components** dentro del directorio `app/` de Next.js 14, puedes usar cualquiera de estas librer√≠as sin problemas.

## C - ¬øY para los Server Components? ü§î

#### 1. **Recomendaci√≥n:**

Si necesitas dar estilo a tus **Server Components**, lo mejor es usar **CSS Modules**, **PostCSS** o **Tailwind CSS**. Estas herramientas generan archivos CSS normales, que s√≠ funcionan perfecto con Server Components.

#### 2. **¬øPor qu√© estas opciones?**

Estas opciones no necesitan JavaScript en tiempo real para aplicar los estilos, por lo que no tienen el problema de compatibilidad con Server Components.

## D - Configurando CSS-in-JS en `app/` (Pasos Clave) ‚öôÔ∏è

#### 1. **Proceso de Configuraci√≥n:**

Configurar CSS-in-JS en Next.js 14 para el directorio `app/` requiere tres pasos principales:

    a. **Registro de Estilos (Style Registry):**  Un lugar para guardar todos los estilos CSS que se crean durante la renderizaci√≥n de tu app.
    b. **`useServerInsertedHTML` Hook:**  Un "gancho" de React que te permite inyectar los estilos en el `<head>` de tu HTML **antes** de que se muestre cualquier contenido que use esos estilos. ¬°As√≠ te aseguras de que los estilos est√©n listos a tiempo!
    c. **Componente Cliente Envolvente (Client Component Wrapper):** Un componente de cliente que "envuelve" tu aplicaci√≥n y usa el registro de estilos durante la primera renderizaci√≥n en el servidor.

#### 2. **En Resumen:**

Necesitas estas tres cosas para que CSS-in-JS funcione correctamente en el entorno de Server Components y Client Components de Next.js 14. ¬°Vamos a ver ejemplos para que quede m√°s claro!

## E - Configurando `styled-jsx` üíÖ

#### 1. **Versi√≥n Necesaria:**

Para usar `styled-jsx` en Client Components, necesitas la versi√≥n `v5.1.0` o superior.

#### 2. **Paso 1: Crea el Registro (registry.tsx):**

Crea un archivo llamado `registry.tsx` dentro de tu carpeta `app/` y pega este c√≥digo:

```typescript
"use client";

import React, { useState } from "react";
import { useServerInsertedHTML } from "next/navigation";
import { StyleRegistry, createStyleRegistry } from "styled-jsx";

export default function StyledJsxRegistry({
  children,
}: {
  children: React.ReactNode;
}) {
  // Crea el registro de estilos solo una vez
  const [jsxStyleRegistry] = useState(() => createStyleRegistry());

  useServerInsertedHTML(() => {
    const styles = jsxStyleRegistry.styles(); // Obtiene los estilos
    jsxStyleRegistry.flush(); // Limpia el registro para la pr√≥xima vez
    return <>{styles}</>; // Inyecta los estilos en el HTML
  });

  return <StyleRegistry registry={jsxStyleRegistry}>{children}</StyleRegistry>; // Envuelve tu app con el registro
}
```

**Explicaci√≥n del c√≥digo:**

- `'use client'`: Marca este archivo como un Client Component.
- `createStyleRegistry()`: Crea un nuevo registro de estilos de `styled-jsx`.
- `useServerInsertedHTML()`: Este hook se ejecuta en el servidor y nos permite inyectar cosas en el `<head>`.
- `jsxStyleRegistry.styles()`: Obtiene todos los estilos que `styled-jsx` ha generado.
- `jsxStyleRegistry.flush()`: Limpia el registro de estilos para que est√© listo para la siguiente renderizaci√≥n.
- `<StyleRegistry registry={jsxStyleRegistry}>{children}</StyleRegistry>`: Este componente de `styled-jsx` hace que el registro de estilos est√© disponible para todos los componentes dentro de √©l (`children`).

#### 3. **Paso 2: Envuelve tu Root Layout (layout.tsx):**

Abre tu archivo `layout.tsx` (que est√° en `app/` y es el layout principal de tu app) y modif√≠calo as√≠:

```typescript
import StyledJsxRegistry from "./registry"; // Importa el registro que creaste

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html>
      <body>
        <StyledJsxRegistry>{children}</StyledJsxRegistry>{" "}
        {/* Envuelve los children con el registro */}
      </body>
    </html>
  );
}
```

**Explicaci√≥n:**

Simplemente importamos el componente `StyledJsxRegistry` que creamos antes y lo usamos para envolver el contenido (`children`) dentro de nuestro `RootLayout`. ¬°As√≠, todos los estilos de `styled-jsx` se manejar√°n correctamente!

#### 4. **Ejemplo Completo:**

Puedes ver un ejemplo funcionando aqu√≠: [https://github.com/vercel/app-playground/tree/main/app/styling/styled-jsx](https://github.com/vercel/app-playground/tree/main/app/styling/styled-jsx)

## F - Configurando Styled Components üíÖ

#### 1. **Versi√≥n Necesaria:**

Necesitas `styled-components@6` o una versi√≥n m√°s nueva.

#### 2. **Paso 1: Activa Styled Components en `next.config.js`:**

Abre el archivo `next.config.js` (o cr√©alo si no existe en la ra√≠z de tu proyecto) y a√±ade esto:

```javascript
module.exports = {
  compiler: {
    styledComponents: true, // Activa el soporte para styled-components
  },
};
```

**Explicaci√≥n:**

Esta configuraci√≥n le dice a Next.js que quieres usar `styled-components` y activa las optimizaciones necesarias.

#### 3. **Paso 2: Crea el Registro (lib/registry.tsx):**

Crea una carpeta llamada `lib` dentro de `app/` (si no existe) y dentro crea un archivo llamado `registry.tsx`. Pega este c√≥digo:

```typescript
"use client";

import React, { useState } from "react";
import { useServerInsertedHTML } from "next/navigation";
import { ServerStyleSheet, StyleSheetManager } from "styled-components";

export default function StyledComponentsRegistry({
  children,
}: {
  children: React.ReactNode;
}) {
  // Crea la hoja de estilos solo una vez
  const [styledComponentsStyleSheet] = useState(() => new ServerStyleSheet());

  useServerInsertedHTML(() => {
    const styles = styledComponentsStyleSheet.getStyleElement(); // Obtiene los elementos de estilo
    styledComponentsStyleSheet.instance.clearTag(); // Limpia la hoja de estilos
    return <>{styles}</>; // Inyecta los estilos en el HTML
  });

  if (typeof window !== "undefined") return <>{children}</>; // En el cliente, solo renderiza los children

  return (
    <StyleSheetManager sheet={styledComponentsStyleSheet.instance}>
      {children}
    </StyleSheetManager> // En el servidor, envuelve con StyleSheetManager
  );
}
```

**Explicaci√≥n del c√≥digo:**

- `'use client'`: Marca este archivo como Client Component.
- `new ServerStyleSheet()`: Crea una nueva hoja de estilos de `styled-components` para el servidor.
- `useServerInsertedHTML()`: Igual que en `styled-jsx`, este hook inyecta cosas en el `<head>`.
- `styledComponentsStyleSheet.getStyleElement()`: Obtiene los elementos `<style>` que contienen los estilos de `styled-components`.
- `styledComponentsStyleSheet.instance.clearTag()`: Limpia la hoja de estilos para la siguiente renderizaci√≥n.
- `StyleSheetManager`: Componente de `styled-components` que gestiona la hoja de estilos.
- `if (typeof window !== 'undefined') return <>{children}</>`: Esta l√≠nea es una optimizaci√≥n. En el navegador (cliente), no necesitamos el `StyleSheetManager` porque `styled-components` ya se encarga de todo. Solo lo necesitamos en el servidor.

#### 4. **Paso 3: Envuelve tu Root Layout (layout.tsx):**

Abre tu `layout.tsx` y modif√≠calo as√≠:

```typescript
import StyledComponentsRegistry from "./lib/registry"; // Importa el registro

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html>
      <body>
        <StyledComponentsRegistry>{children}</StyledComponentsRegistry>{" "}
        {/* Envuelve con el registro */}
      </body>
    </html>
  );
}
```

**Explicaci√≥n:**

Similar a `styled-jsx`, importamos `StyledComponentsRegistry` y envolvemos el contenido de nuestro `RootLayout` con √©l.

#### 5. **Ejemplo Completo:**

Puedes ver un ejemplo funcionando aqu√≠: [https://github.com/vercel/app-playground/tree/main/app/styling/styled-components](https://github.com/vercel/app-playground/tree/main/app/styling/styled-components)

## G - Puntos Importantes sobre la Configuraci√≥n de Styled Components üí°

#### 1. **Renderizaci√≥n en el Servidor:**

Durante la renderizaci√≥n en el servidor, los estilos se guardan en un registro global y luego se "env√≠an" al `<head>` de tu HTML. Esto asegura que los estilos est√©n disponibles antes de que se muestre el contenido que los usa. En el futuro, React podr√≠a tener una forma a√∫n mejor de decidir d√≥nde inyectar los estilos.

#### 2. **Streaming:**

Si est√°s usando "streaming" (una forma de Next.js de enviar partes de la p√°gina web al navegador poco a poco), los estilos de cada parte se ir√°n a√±adiendo a los estilos ya existentes. Una vez que la p√°gina se carga completamente en el navegador (hidrataci√≥n), `styled-components` toma el control y funciona como siempre para los estilos din√°micos.

#### 3. **¬øPor qu√© un Client Component para el Registro?**

Usar un Client Component en la parte superior del √°rbol de componentes para el registro de estilos es m√°s eficiente. Evita que los estilos se generen de nuevo en cada renderizaci√≥n del servidor y tambi√©n evita que se env√≠en datos innecesarios en la respuesta del servidor.

#### 4. **Configuraci√≥n Avanzada:**

Si necesitas personalizar cosas m√°s espec√≠ficas de c√≥mo `styled-components` se compila, puedes consultar la documentaci√≥n de Next.js sobre la API de `styled-components` en el compilador de Next.js: [https://nextjs.org/docs/14/architecture/nextjs-compiler#styled-components](https://nextjs.org/docs/14/architecture/nextjs-compiler#styled-components). ¬°Ah√≠ encontrar√°s opciones m√°s avanzadas!
