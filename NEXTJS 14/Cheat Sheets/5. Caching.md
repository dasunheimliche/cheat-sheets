## A - Caching en Next.js: Cheat Sheet para Principiantes

춰Hola! 游녦 Aqu칤 tienes una gu칤a r치pida y f치cil sobre c칩mo funciona el caching en Next.js. No te preocupes si al principio parece mucho, 춰lo desglosaremos paso a paso!

#### 1. **Definici칩n:**

Next.js usa "caching" para que tus aplicaciones sean m치s r치pidas y baratas. Imagina que el caching es como guardar cosas que usas mucho a mano para no tener que buscarlas cada vez desde el fondo del armario. En programaci칩n, esto significa guardar datos o p치ginas ya hechas para no tener que generarlas de nuevo cada vez que alguien las pide.

#### 2. **Tipos de Caching en Next.js:**

Next.js tiene varios tipos de "guardados" o caches. Aqu칤 te los presento de forma sencilla:

- **Request Memoization:** Cache temporal para datos dentro de una misma petici칩n.
- **Data Cache:** Cache persistente para datos, que se guarda entre peticiones y "deployments" (cuando subes tu app a internet).
- **Full Route Cache:** Cache persistente para p치ginas enteras (HTML y datos), para que las p치ginas se sirvan muy r치pido.
- **Router Cache:** Cache en el navegador del usuario para que la navegaci칩n entre p치ginas sea instant치nea.

#### 3. **Tabla Resumen:**

| Mecanismo           | Qu칠 guarda                | D칩nde se guarda | Para qu칠 sirve                                | Duraci칩n                            |
| :------------------ | :------------------------ | :-------------- | :-------------------------------------------- | :---------------------------------- |
| Request Memoization | Resultados de funciones   | Servidor        | Reutilizar datos en un mismo componente React | Durante una petici칩n                |
| Data Cache          | Datos                     | Servidor        | Guardar datos entre peticiones y deployments  | Persistente (se puede invalidar)    |
| Full Route Cache    | HTML y datos de la p치gina | Servidor        | Servir p치ginas muy r치pido                     | Persistente (se puede invalidar)    |
| Router Cache        | Datos de la p치gina (RSC)  | Navegador       | Navegaci칩n r치pida en el sitio                 | Sesi칩n de usuario o tiempo limitado |

춰Vamos a ver cada uno en detalle!

---

## B - Request Memoization: Reutilizando Datos en el Mismo Componente

#### 1. **Definici칩n:**

Imagina que en una misma p치gina necesitas los mismos datos varias veces. Request Memoization es como un "recordatorio" r치pido. Si ya pediste los datos una vez, las siguientes veces te los da directamente de la "memoria" sin volver a pedirlos.

#### 2. **Ejemplo:**

```typescript
async function getItem() {
  const res = await fetch("https://.../item/1");
  return res.json();
}

const item1 = await getItem(); // Primera vez: 춰a buscar los datos! (cache MISS)
const item2 = await getItem(); // Segunda vez: 춰ya los tengo guardados! (cache HIT)
```

**Explicaci칩n del ejemplo:**
Aunque `getItem()` se llama dos veces, la funci칩n `fetch` solo se ejecuta la primera vez. La segunda vez, los datos se obtienen directamente del "recordatorio" (memoization).

#### 3. **쮺칩mo Funciona?:**

![Diagram showing how fetch memoization works during React rendering.](https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Frequest-memoization.png&w=3840&q=75)![Diagram showing how fetch memoization works during React rendering.](https://nextjs.org/_next/image?url=%2Fdocs%2Fdark%2Fcaching-overview.png&w=3840&q=75)

- **Primera llamada:** No hay "recordatorio", as칤 que se busca la informaci칩n (cache MISS).
- **Se guarda:** El resultado se guarda en la "memoria" temporal.
- **Siguientes llamadas:** Si se piden los mismos datos otra vez durante la misma "construcci칩n" de la p치gina, se usan los guardados en "memoria" (cache HIT).
- **Se olvida:** Una vez que la p치gina est치 lista, la "memoria" se borra y se empieza de cero para la siguiente petici칩n.

#### 4. **Notas Importantes:**

- Es una funci칩n de React, no solo de Next.js.
- Solo funciona para peticiones `GET` con `fetch`.
- Funciona dentro de los componentes de React (Layouts, Pages, etc.), pero no en Route Handlers.
- Si `fetch` no te sirve, puedes usar `React.cache` para hacer memoization en otras funciones.

---

## C - Data Cache: Guardando Datos para Despu칠s

#### 1. **Definici칩n:**

Data Cache es como una "caja fuerte" para tus datos. Next.js guarda los resultados de las peticiones `fetch` en esta caja fuerte para que est칠n disponibles incluso despu칠s de que termine una petici칩n o cuando actualices tu aplicaci칩n.

#### 2. **쮺칩mo Funciona?:**

![Diagram showing how cached and uncached fetch requests interact with the Data Cache. Cached requests are stored in the Data Cache, and memoized, uncached requests are fetched from the data source, not stored in the Data Cache, and memoized.](https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Fdata-cache.png&w=3840&q=75)![Diagram showing how cached and uncached fetch requests interact with the Data Cache. Cached requests are stored in the Data Cache, and memoized, uncached requests are fetched from the data source, not stored in the Data Cache, and memoized.](https://nextjs.org/_next/image?url=%2Fdocs%2Fdark%2Fcaching-overview.png&w=3840&q=75)

- **Primera petici칩n:** Next.js busca en la "caja fuerte" (Data Cache).
- **Si est치:** Los datos se sacan de la "caja fuerte" y se usan (cache HIT).
- **Si no est치:** Se piden los datos a la fuente original, se guardan en la "caja fuerte" y se usan (cache MISS y luego SET).
- **Datos sin cache:** Si pides datos con `{ cache: 'no-store' }`, nunca se guardan en la "caja fuerte", siempre se piden de nuevo.
- **Memoization siempre activa:** Recuerda que, est칠n o no en la "caja fuerte", las peticiones siempre tienen Request Memoization para evitar duplicados dentro de la misma petici칩n.

#### 3. **Duraci칩n:**

Los datos en Data Cache se quedan guardados hasta que los "invalides" o los borres, incluso entre actualizaciones de tu app.

#### 4. **Revalidaci칩n (Actualizando los Datos):**

Puedes actualizar los datos en Data Cache de dos formas:

- **Revalidaci칩n por tiempo:** Dices "actualiza estos datos cada X segundos/minutos/horas". Ideal para datos que no cambian muy seguido.

  ```javascript
  fetch("https://...", { next: { revalidate: 3600 } }); // Revalida cada hora
  ```

  ![Diagram showing how time-based revalidation works, after the revalidation period, stale data is returned for the first request, then data is revalidated.](https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Ftime-based-revalidation.png&w=3840&q=75)![Diagram showing how time-based revalidation works, after the revalidation period, stale data is returned for the first request, then data is revalidated.](https://nextjs.org/_next/image?url=%2Fdocs%2Fdark%2Fcaching-overview.png&w=3840&q=75)

  - Se pide la data por primera vez y se guarda.
  - Durante el tiempo definido (`revalidate`), se usan los datos guardados.
  - Despu칠s del tiempo, la _siguiente_ petici칩n usa los datos viejos PERO en segundo plano Next.js actualiza los datos. La pr칩xima vez ya estar치n los nuevos. 춰Como "stale-while-revalidate"!

- **Revalidaci칩n On-Demand (Bajo Demanda):** Actualizas los datos cuando pasa algo espec칤fico, por ejemplo, cuando alguien edita un art칤culo en tu blog. Puedes usar "tags" o "paths" para invalidar grupos de datos a la vez.

  ![Diagram showing how on-demand revalidation works, the Data Cache is updated with fresh data after a revalidation request.](https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Fon-demand-revalidation.png&w=3840&q=75)![Diagram showing how on-demand revalidation works, the Data Cache is updated with fresh data after a revalidation request.](https://nextjs.org/_next/image?url=%2Fdocs%2Fdark%2Fcaching-overview.png&w=3840&q=75)

  - Se pide la data y se guarda.
  - Cuando pides revalidar (por tag o path), se borran los datos guardados.
  - La siguiente petici칩n volver치 a pedir los datos frescos y los guardar치 de nuevo.

#### 5. **Optar por No Usar Data Cache:**

Si no quieres usar Data Cache para una petici칩n espec칤fica, usa:

```javascript
fetch("https://...", { cache: "no-store" });
```

O para toda una ruta, usa en tu `page.js` o `layout.js`:

```javascript
export const dynamic = "force-dynamic";
```

#### 6. **Ojo:**

Data Cache solo funciona en `app/routes`, no en `middleware`.

---

## D - Full Route Cache: P치ginas Ultrarr치pidas

#### 1. **Definici칩n:**

Full Route Cache guarda la p치gina web completa (HTML y datos) ya "cocinada" en el servidor. As칤, cuando alguien pide esa p치gina, Next.js se la sirve directamente, 춰sin tener que "cocinarla" de nuevo! Esto hace que las p치ginas se carguen muy r치pido.

#### 2. **쮺칩mo Funciona?:**

![Default behavior of the Full Route Cache, showing how the React Server Component Payload and HTML are cached on the server for statically rendered routes.](https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Ffull-route-cache.png&w=3840&q=75)![Default behavior of the Full Route Cache, showing how the React Server Component Payload and HTML are cached on the server for statically rendered routes.](https://nextjs.org/_next/image?url=%2Fdocs%2Fdark%2Fcaching-overview.png&w=3840&q=75)

- **Renderizado en el servidor:** Next.js usa React para crear la p치gina en el servidor.
- **Cache de la p치gina:** El resultado (HTML y datos) se guarda en Full Route Cache.
- **Entrega r치pida:** Cuando alguien pide la p치gina, se sirve directamente desde el cache, 춰super r치pido!
- **React en el navegador:** El navegador usa el HTML para mostrar la p치gina r치pido y luego usa los datos guardados para hacerla interactiva.

#### 3. **Est치tico vs Din치mico:**

- **Rutas est치ticas:** Se crean en el momento de "construir" la app (build time) o cuando se revalidan. Se guardan en Full Route Cache por defecto.
- **Rutas din치micas:** Se crean cuando alguien las pide (request time). No se guardan en Full Route Cache por defecto.

![How static and dynamic rendering affects the Full Route Cache. Static routes are cached at build time or after data revalidation, whereas dynamic routes are never cached](https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Fstatic-and-dynamic-routes.png&w=3840&q=75)![How static and dynamic rendering affects the Full Route Cache. Static routes are cached at build time or after data revalidation, whereas dynamic routes are never cached](https://nextjs.org/_next/image?url=%2Fdocs%2Fdark%2Fcaching-overview.png&w=3840&q=75)

#### 4. **Duraci칩n:**

Por defecto, Full Route Cache es persistente, se guarda entre peticiones.

#### 5. **Invalidaci칩n:**

- **Revalidando Data Cache:** Si actualizas los datos en Data Cache, tambi칠n se invalida Full Route Cache (porque la p치gina depende de los datos).
- **Redeploy:** Al subir una nueva versi칩n de tu app, se borra Full Route Cache.

#### 6. **Optar por No Usar Full Route Cache (Renderizado Din치mico):**

- **Funciones din치micas:** Usar `cookies`, `headers` o `searchParams` en tu p치gina la hace din치mica y no se guarda en Full Route Cache.
- **`dynamic = 'force-dynamic'` o `revalidate = 0`:** En la configuraci칩n de la ruta, fuerza el renderizado din치mico y no usa Full Route Cache ni Data Cache.
- **No usar Data Cache en alguna petici칩n:** Si una petici칩n `fetch` en la ruta usa `cache: 'no-store'`, la ruta entera se vuelve din치mica (pero otras peticiones en la misma ruta pueden seguir usando Data Cache).

---

## E - Router Cache: Navegaci칩n Instant치nea en el Cliente

#### 1. **Definici칩n:**

Router Cache es como una "memoria cach칠" en el navegador del usuario. Guarda partes de las p치ginas (React Server Component Payload) que ya ha visitado. As칤, cuando vuelve a esas p치ginas o va a p치ginas que ya "pre-carg칩", la navegaci칩n es casi instant치nea.

#### 2. **쮺칩mo Funciona?:**

![How the Router cache works for static and dynamic routes, showing MISS and HIT for initial and subsequent navigations.](https://nextjs.org/_next/image?url=%2Fdocs%2Flight%2Frouter-cache.png&w=3840&q=75)![How the Router cache works for static and dynamic routes, showing MISS and HIT for initial and subsequent navigations.](https://nextjs.org/_next/image?url=%2Fdocs%2Fdark%2Fcaching-overview.png&w=3840&q=75)

- **Navegaci칩n:** Al navegar por tu sitio, Next.js guarda partes de las p치ginas visitadas en Router Cache.
- **Prefetching:** Next.js "pre-carga" p치ginas a las que es probable que el usuario vaya (por ejemplo, las que est치n en los `<Link>`).
- **Navegaci칩n r치pida:** Al volver a una p치gina ya visitada o pre-cargada, se usa Router Cache y la p치gina aparece al instante.

#### 3. **Duraci칩n:**

Router Cache dura durante la sesi칩n del usuario en el navegador. Se borra al recargar la p치gina. Adem치s, tiene un tiempo de vida autom치tico para layouts y "loading states" (p치ginas de carga):

- **Prefetching por defecto:** 5 minutos para p치ginas est치ticas, no cache para din치micas.
- **Prefetching completo:** 5 minutos para est치ticas y din치micas.

#### 4. **Invalidaci칩n:**

- **Server Actions:**
  - `revalidatePath` o `revalidateTag` en un Server Action invalidan Router Cache.
  - `cookies.set` o `cookies.delete` tambi칠n invalidan Router Cache (para reflejar cambios de autenticaci칩n, por ejemplo).
- **`router.refresh()`:** Borra Router Cache y pide la p치gina actual de nuevo al servidor.

#### 5. **Optar por No Usar Router Cache:**

No se puede desactivar Router Cache por completo. Pero puedes invalidarlo con `router.refresh()`, `revalidatePath` o `revalidateTag`.

Puedes desactivar el **prefetching** con `<Link prefetch={false}>`, pero la p치gina visitada se seguir치 guardando en Router Cache temporalmente.

---

## F - Interacciones entre Caches

Es importante entender c칩mo se relacionan los diferentes caches:

- **Data Cache y Full Route Cache:**

  - Invalidar Data Cache **SI** invalida Full Route Cache.
  - Invalidar Full Route Cache **NO** afecta a Data Cache.

- **Data Cache y Router Cache:**
  - Revalidar Data Cache en un Route Handler **NO** invalida Router Cache inmediatamente.
  - Para invalidar ambos a la vez, usa `revalidatePath` o `revalidateTag` en un Server Action.

---

## G - APIs y Caching: Resumen R치pido

Aqu칤 tienes una tabla con las APIs de Next.js y c칩mo afectan al caching:

| API                              | Router Cache | Full Route Cache | Data Cache       | React Cache |
| :------------------------------- | :----------- | :--------------- | :--------------- | :---------- |
| `<Link prefetch>`                | Cache        |                  |                  |             |
| `router.prefetch`                | Cache        |                  |                  |             |
| `router.refresh`                 | Revalida     |                  |                  |             |
| `fetch`                          |              | Cache            | Cache            |             |
| `fetch options.cache`            |              | Cache/Opt-out    | Cache/Opt-out    |             |
| `fetch options.next.revalidate`  |              | Revalida         | Revalida         |             |
| `fetch options.next.tags`        |              | Cache            | Cache            |             |
| `revalidateTag` (Server Action)  | Revalida     | Revalida         | Revalida         |             |
| `revalidatePath` (Server Action) | Revalida     | Revalida         | Revalida         |             |
| `const revalidate`               |              | Revalida/Opt-out | Revalida/Opt-out |             |
| `const dynamic`                  |              | Cache/Opt-out    | Cache/Opt-out    |             |
| `cookies` (Server Action)        | Revalida     | Opt-out          |                  |             |
| `headers`, `searchParams`        |              | Opt-out          |                  |             |
| `generateStaticParams`           |              | Cache            |                  |             |
| `React.cache`                    |              |                  |                  | Cache       |
| `unstable_cache`                 |              |                  |                  |             |
