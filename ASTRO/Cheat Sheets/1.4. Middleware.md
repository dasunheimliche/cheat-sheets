## A - Middleware (Definición General)

**Definición:** Middleware en Astro permite interceptar peticiones y respuestas, inyectando comportamientos dinámicos antes de que se renderice una página o endpoint. Se ejecuta en tiempo de compilación para páginas pre-renderizadas y bajo demanda para páginas SSR.

**Ejemplo:**

```js
src / middleware.js; // o src/middleware/index.js
```

(Un archivo middleware.js o middleware/index.js define el middleware.)

## B - Función onRequest()

**Definición:** El middleware exporta una función onRequest() que recibe un objeto context y una función next().

**Ejemplo:**

```JavaScript
// src/middleware.js
export function onRequest(context, next) {
  // ...
  return next();
}
```

(La función onRequest() define la lógica del middleware.)

## C - Objeto context

**Definición:** El objeto context contiene información sobre la petición y permite compartir datos entre middleware, endpoints y páginas.

**Ejemplo:**

```JavaScript
// src/middleware.js
export function onRequest(context, next) {
  console.log(context.url); // URL de la petición
  context.locals.user = { name: "John" }; // Almacena datos en locals
  return next();
}
```

(El objeto context proporciona acceso a la URL, locals y otras propiedades.)

## D - context.locals

**Definición:** context.locals es un objeto que permite compartir datos entre middleware, endpoints y páginas.

**Ejemplo:**

```JavaScript
// src/middleware.js
export function onRequest(context, next) {
  context.locals.title = "Mi Título";
  return next();
}
```

(Almacena datos que estarán disponibles en Astro.locals.)

## E - Acceso a Astro.locals

**Definición:** Los datos almacenados en context.locals están disponibles en páginas y endpoints a través de Astro.locals.

**Ejemplo:**

```Astro
// src/pages/index.astro
---
const title = Astro.locals.title;
---
<h1>{title}</h1>
```

(Accede a los datos compartidos por el middleware.)

## F - Tipado de Middleware

**Definición:** Puedes usar defineMiddleware() o JSDoc para tipar tu middleware.

**Ejemplo:**

```TypeScript
// src/middleware.ts
import { defineMiddleware } from "astro:middleware";

export const onRequest = defineMiddleware((context, next) => {
  // ...
});
```

(Proporciona seguridad de tipos y autocompletado.)

## G - Tipado de Astro.locals

**Definición:** Define un namespace global en src/env.d.ts para tipar los datos en Astro.locals.

**Ejemplo:**

```TypeScript
// src/env.d.ts
declare namespace App {
  interface Locals {
    user: { name: string };
    title: string;
  }
}
```

(Permite autocompletado y seguridad de tipos en Astro.locals.)

## H - Encadenamiento de Middleware (sequence())

**Definición:** Usa sequence() para ejecutar múltiples middlewares en un orden específico.

**Ejemplo:**

```JavaScript
// src/middleware.js
import { sequence } from "astro:middleware";

async function first(_, next) {
  console.log("first");
  return next();
}

async function second(_, next) {
  console.log("second");
  return next();
}

export const onRequest = sequence(first, second);
```

(Ejecuta first y luego second.)

## I - context.rewrite()

**Definición:** context.rewrite() permite mostrar el contenido de otra ruta sin redirigir al usuario.

**Ejemplo:**

```JavaScript
// src/middleware.js
export function onRequest(context, next) {
  if (!context.locals.isLoggedIn) {
    return context.rewrite("/login");
  }
  return next();
}
```

(Muestra el contenido de /login si el usuario no está logueado.)

## J - next() con URL (Middleware)

**Definición:** Puedes pasar una URL a next() para reescribir la petición actual sin ejecutar el middleware de nuevo.

**Ejemplo:**

```JavaScript
// src/middleware.js
export function onRequest(context, next) {
  if (!context.locals.isLoggedIn) {
    return next("/login");
  }
  return next();
}
```

(Reescribe la petición a /login sin volver a ejecutar el middleware.)

## K - Middleware y Páginas de Error

**Definición:** El middleware intenta ejecutarse incluso para páginas de error (404 y 500), pero depende del adaptador si esto ocurre.

**Ejemplo:**

```JavaScript
// src/middleware.js
export function onRequest(context, next) {
  console.log("Middleware ejecutado");
  return next();
}
```

(El middleware se ejecuta antes de mostrar la página de error, si el adaptador lo permite.)

## L - Redacción de Información Sensible

**Definición:** El middleware puede modificar la respuesta HTML para redactar información sensible.

**Ejemplo:**

```JavaScript
// src/middleware.js
export const onRequest = async (context, next) => {
  const response = await next();
  const html = await response.text();
  const redactedHtml = html.replaceAll("PRIVATE INFO", "REDACTED");
  return new Response(redactedHtml, {
    status: 200,
    headers: response.headers,
  });
};
```

(Reemplaza "PRIVATE INFO" con "REDACTED" en el HTML.)
