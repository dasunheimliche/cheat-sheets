## A - Conectando el Estado de Zustand con el Hash de la URL

#### 1. **DefiniciÃ³n:**

Si quieres que el estado de tu store de Zustand se guarde en el **hash** de la URL (la parte que va despuÃ©s del `#` en la direcciÃ³n web), puedes crear tu propio "almacenamiento hash" personalizado. Esto es Ãºtil para compartir el estado actual de tu aplicaciÃ³n a travÃ©s de un enlace, Â¡y el estado se restaurarÃ¡ cuando alguien abra ese enlace! âš“

#### 2. **Ejemplo:**

```typescript
import { create } from "zustand";
import { persist, StateStorage, createJSONStorage } from "zustand/middleware";

const hashStorage: StateStorage = {
  getItem: (key): string => {
    const searchParams = new URLSearchParams(location.hash.slice(1));
    const storedValue = searchParams.get(key) ?? "";
    return JSON.parse(storedValue);
  },
  setItem: (key, newValue): void => {
    const searchParams = new URLSearchParams(location.hash.slice(1));
    searchParams.set(key, JSON.stringify(newValue));
    location.hash = searchParams.toString();
  },
  removeItem: (key): void => {
    const searchParams = new URLSearchParams(location.hash.slice(1));
    searchParams.delete(key);
    location.hash = searchParams.toString();
  },
};

export const useBoundStore = create(
  persist(
    (set, get) => ({
      fishes: 0,
      addAFish: () => set({ fishes: get().fishes + 1 }),
    }),
    {
      name: "food-storage", // nombre Ãºnico
      storage: createJSONStorage(() => hashStorage),
    }
  )
);
```

**ExplicaciÃ³n del ejemplo:**

- **`hashStorage`:** Este objeto define cÃ³mo Zustand va a guardar y leer el estado desde el hash de la URL.
  - **`getItem`:** Lee el valor del hash, lo parsea de JSON y lo devuelve.
  - **`setItem`:** Convierte el nuevo valor a JSON, lo guarda en el hash de la URL.
  - **`removeItem`:** Elimina el valor del hash.
- **`create(persist(...))`:** Usamos el middleware `persist` de Zustand para guardar el estado.
  - **`storage: createJSONStorage(() => hashStorage)`:** Le decimos a `persist` que use nuestro `hashStorage` personalizado para guardar el estado en formato JSON en el hash de la URL.
  - **`name: 'food-storage'`:** Un nombre Ãºnico para identificar este store en el almacenamiento.

#### 3. **Notas o advertencias:**

- **`URLSearchParams`:** Usamos `URLSearchParams` para manipular fÃ¡cilmente el hash de la URL como si fuera un conjunto de parÃ¡metros. Â¡Es una herramienta muy Ãºtil para trabajar con URLs! ğŸ› ï¸
- **`location.hash`:** `location.hash` es la propiedad de JavaScript que nos permite acceder y modificar el hash de la URL.
- **`createJSONStorage`:** Este helper de Zustand convierte el estado a JSON antes de guardarlo y lo parsea de JSON al leerlo. Â¡AsÃ­ podemos guardar objetos y arrays en la URL! âš™ï¸
- **Demo en CodeSandbox:** Puedes ver un ejemplo funcionando aquÃ­: [https://codesandbox.io/s/zustand-state-with-url-hash-demo-f29b88?file=/src/store/index.ts](https://codesandbox.io/s/zustand-state-with-url-hash-demo-f29b88?file=/src/store/index.ts) ğŸ’»

## B - Persistiendo y Conectando el Estado con ParÃ¡metros de la URL (Ejemplo: Query Parameters)

#### 1. **DefiniciÃ³n:**

A veces, quieres guardar el estado de Zustand en los **parÃ¡metros de consulta** de la URL (la parte despuÃ©s del `?` en la direcciÃ³n web). Este mÃ©todo es Ãºtil para compartir el estado y tambiÃ©n para que el estado sea indexable por motores de bÃºsqueda (si es relevante para tu caso). AdemÃ¡s, puedes combinar esto con otro tipo de persistencia, como `localStorage`, Â¡para tener lo mejor de ambos mundos! ğŸŒ

#### 2. **Ejemplo:**

```typescript
import { create } from "zustand";
import { persist, StateStorage, createJSONStorage } from "zustand/middleware";

const getUrlSearch = () => {
  return window.location.search.slice(1);
};

const persistentStorage: StateStorage = {
  getItem: (key): string => {
    // Primero revisa la URL
    if (getUrlSearch()) {
      const searchParams = new URLSearchParams(getUrlSearch());
      const storedValue = searchParams.get(key);
      return JSON.parse(storedValue as string);
    } else {
      // Si no hay parÃ¡metros en la URL, carga desde localStorage
      return JSON.parse(localStorage.getItem(key) as string);
    }
  },
  setItem: (key, newValue): void => {
    // Si hay parÃ¡metros en la URL, actualÃ­zalos
    if (getUrlSearch()) {
      const searchParams = new URLSearchParams(getUrlSearch());
      searchParams.set(key, JSON.stringify(newValue));
      window.history.replaceState(null, "", `?${searchParams.toString()}`); // Actualiza la URL sin recargar la pÃ¡gina
    }

    localStorage.setItem(key, JSON.stringify(newValue)); // Siempre guarda en localStorage tambiÃ©n
  },
  removeItem: (key): void => {
    const searchParams = new URLSearchParams(getUrlSearch());
    searchParams.delete(key);
    window.location.search = searchParams.toString();
  },
};

type LocalAndUrlStore = {
  typesOfFish: string[];
  addTypeOfFish: (fishType: string) => void;
  numberOfBears: number;
  setNumberOfBears: (newNumber: number) => void;
};

const storageOptions = {
  name: "fishAndBearsStore",
  storage: createJSONStorage<LocalAndUrlStore>(() => persistentStorage),
};

const useLocalAndUrlStore = create(
  persist<LocalAndUrlStore>(
    (set) => ({
      typesOfFish: [],
      addTypeOfFish: (fishType) =>
        set((state) => ({ typesOfFish: [...state.typesOfFish, fishType] })),

      numberOfBears: 0,
      setNumberOfBears: (numberOfBears) => set(() => ({ numberOfBears })),
    }),
    storageOptions
  )
);

export default useLocalAndUrlStore;
```

**ExplicaciÃ³n del ejemplo:**

- **`getUrlSearch`:** FunciÃ³n auxiliar para obtener la parte de "query" de la URL (despuÃ©s del `?`).
- **`persistentStorage`:** Este almacenamiento personalizado ahora revisa _primero_ si hay parÃ¡metros en la URL.
  - **`getItem`:** Si hay parÃ¡metros en la URL, lee de ahÃ­. Si no, lee de `localStorage`.
  - **`setItem`:** Si hay parÃ¡metros en la URL, los actualiza _y_ tambiÃ©n guarda en `localStorage`.
  - **`removeItem`:** Elimina el parÃ¡metro de la URL.
- **`window.history.replaceState`:** Esta funciÃ³n mÃ¡gica actualiza la URL en la barra de direcciones del navegador **sin recargar la pÃ¡gina**. Â¡AsÃ­ la experiencia del usuario es mucho mejor! âœ¨
- **`localStorage.setItem`:** Siempre guardamos en `localStorage` tambiÃ©n, Â¡asÃ­ el estado persiste incluso si el usuario cierra la pestaÃ±a y vuelve a abrir la aplicaciÃ³n! ğŸ’¾

#### 3. **Notas o advertencias:**

- **Persistencia HÃ­brida:** Este ejemplo muestra cÃ³mo combinar la persistencia en la URL con `localStorage`. Puedes adaptarlo para usar otros tipos de almacenamiento persistente si lo necesitas. ibrido ğŸ§¬
- **`window.location.search`:** `window.location.search` nos da acceso a la parte de "query" de la URL.
- **`window.history.replaceState` vs `window.location.search = ...`:** `window.history.replaceState` es preferible para actualizar la URL sin recargar la pÃ¡gina. `window.location.search = ...` tambiÃ©n funciona, pero podrÃ­a causar una recarga en algunos casos. Â¡`replaceState` es mÃ¡s suave y eficiente! ğŸ’¨
- **Condicional `getUrlSearch()`:** El cÃ³digo revisa `getUrlSearch()` antes de leer y escribir en la URL. Puedes quitar estas revisiones si _siempre_ quieres que el estado se sincronice con la URL, Â¡sin importar si hay parÃ¡metros o no! ğŸš¦

## C - Generando URLs Compartibles con el Estado de Zustand

#### 1. **DefiniciÃ³n:**

Una vez que estÃ¡s guardando el estado de Zustand en la URL, Â¡querrÃ¡s poder generar URLs que incluyan ese estado para compartir con otros! AquÃ­ te mostramos cÃ³mo crear funciones para construir URLs compartibles que codifiquen el estado actual de tu store. ğŸ“¤

#### 2. **Ejemplo:**

```typescript
const buildURLSuffix = (params, version = 0) => {
  const searchParams = new URLSearchParams();

  const zustandStoreParams = {
    state: {
      typesOfFish: params.typesOfFish,
      numberOfBears: params.numberOfBears,
    },
    version: version, // version se incluye porque Zustand la guarda en el estado persistido
  };

  // La clave del parÃ¡metro de la URL debe coincidir con el nombre del store (storageOptions.name)
  searchParams.set("fishAndBearsStore", JSON.stringify(zustandStoreParams));
  return searchParams.toString();
};

export const buildShareableUrl = (params, version) => {
  return `${window.location.origin}?${buildURLSuffix(params, version)}`;
};
```

**ExplicaciÃ³n del ejemplo:**

- **`buildURLSuffix`:** Esta funciÃ³n toma un objeto `params` (con el estado que quieres compartir) y una `version` (que Zustand usa internamente).
  - Crea un `URLSearchParams`.
  - Crea un objeto `zustandStoreParams` que contiene el estado y la versiÃ³n (Â¡importante incluir la versiÃ³n!).
  - Guarda este objeto en los `searchParams` usando la clave `'fishAndBearsStore'` (Â¡asegÃºrate de que coincida con `storageOptions.name`!).
  - Devuelve la cadena de parÃ¡metros de consulta (`searchParams.toString()`).
- **`buildShareableUrl`:** Esta funciÃ³n toma los mismos `params` y `version`, usa `buildURLSuffix` para crear la parte de los parÃ¡metros de consulta, y luego construye la URL completa, Â¡incluyendo el origen de la pÃ¡gina (`window.location.origin`) y el `?`! ğŸŒ

#### 3. **Notas o advertencias:**

- **`storageOptions.name` es clave:** AsegÃºrate de que la clave que usas en `searchParams.set('fishAndBearsStore', ...)` en `buildURLSuffix` **coincida exactamente** con el `name` que definiste en `storageOptions` al configurar `persist`. Â¡Si no coinciden, Zustand no sabrÃ¡ quÃ© estado buscar en la URL! ğŸ”‘
- **Incluye la `version`:** Zustand guarda una `version` en el estado persistido. Es importante incluirla tambiÃ©n en la URL al generar enlaces compartibles, Â¡para que Zustand pueda restaurar el estado correctamente! ğŸ”¢
- **URL codificada:** La URL generada estarÃ¡ codificada (por ejemplo, los espacios se convierten en `%20`, etc.). Esto es normal y necesario para que las URLs sean vÃ¡lidas. Cuando `URLSearchParams` parsea la URL, Â¡descodifica todo automÃ¡ticamente! ğŸ›¡ï¸
- **Ejemplo de URL generada:** La URL generada se verÃ¡ algo asÃ­: `https://localhost/search?fishAndBearsStore={"state":{"typesOfFish":["tilapia","salmon"],"numberOfBears":15},"version":0}}` (sin codificar para que sea mÃ¡s legible). ğŸ”—
